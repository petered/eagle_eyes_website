---
layout: main
title: Update your profile
permalink: /user-form/
---

<style>
    /* Radio button styles */
    .radio-group {
        margin-bottom: 20px;
    }
    
    .radio-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .radio-container input[type="radio"] {
        margin-right: 10px;
        /* Ensure visibility */
        opacity: 1;
        visibility: visible;
        position: static;
        width: auto;
        height: auto;
    }
    
    /* Fix for labels */
    .radio-container label {
        display: inline-block;
        cursor: pointer;
    }
    
    /* Fix for checkbox containers too */
    .checkbox-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .checkbox-container input[type="checkbox"] {
        margin-right: 10px;
        /* Ensure visibility */
        opacity: 1;
        visibility: visible;
        position: static;
        width: auto;
        height: auto;
    }
    
   
</style>

<div class="section-block bkg-grey-ultralight" style="padding: 120px 0 30px 0;">
    <!-- Add the test user banner right at the top -->
    <div id="test-user-banner" style="display: none; position: sticky; top: 0; left: 0; width: 100%; background-color: #4CAF50; color: white; padding: 10px 0; text-align: center; z-index: 1000; margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <span><strong>Development Mode</strong></span>
            <button id="test-user-login" class="button small rounded" style="background-color: white; color: #4CAF50; border: none; padding: 8px 15px; font-size: 14px; cursor: pointer;">Sign in as Test User</button>
        </div>
    </div>
    
    <div class="row">
        <div class="column width-12">
            <div class="centered">
                <h2 class="mb-10">Update your profile</h2>
                <div style="display: flex; justify-content: flex-start; align-items: center; gap: 20px;">
                    <div id="userEmailDisplay" style="color: #666; font-size: 16px;"></div>
                    <div id="signOutContainer" style="display: none;">
                        <a href="#" id="signOutButton" class="button small rounded" style="padding: 8px 15px; font-size: 14px;">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-block" style="padding-top: 20px;">
    <div class="row">
        <div class="column width-8 offset-2">
            <!-- Sign in button (will trigger overlay) -->
            <div id="signinButtonSection" style="display: block; text-align: center; margin-bottom: 40px;">
                <p style="margin-bottom: 20px;">Sign in to get started. Don't have an account? No worries, you'll be able to create one.</p>
                <button id="accountSignInButton" class="button" onclick="toggleSignIn()">Sign In or Create Account</button>
            </div>

            <!-- Trial form content section -->
            <div id="form-container" class="box rounded xlarge bkg-white shadow" style="display: none;">
                <div class="box-content">
                    <div class="row">
                        <div class="column width-12">
                            
                            {% include account-questions.html %}
                            
                            
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="hang-on-message" class="info-box" style="display: none; margin-top: 20px; text-align: center; padding: 20px;">
                Hang on a moment while we get everything ready for you...
            </div>
            
            <div id="post-form" class="info-box" style="display: none; margin-top: 20px; text-align: center; padding: 20px;">
                <div id="checking-licenses-box"></div>
            </div>
        </div>
    </div>
</div>

<!-- Sign in overlay -->
<div id="signin-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: relative; width: 100%; height: 100%;">
        {% include signinwidget-main.html %}
    </div>
</div>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the form component without specifying a default form type
        if (typeof initFormComponent === 'function') {
            initFormComponent(); // No options, no default form type
        }

        // Capture URL parameters for returnURL and formType
        const urlParams = new URLSearchParams(window.location.search);
        window.formReturnURL = urlParams.get('returnURL') || null;
        const urlFormType = urlParams.get('formType');

        // If formType is specified in URL, auto-select it
        if (urlFormType) {
            setTimeout(() => {
                const radioButton = document.querySelector(`input[name="signup_type"][value="${urlFormType}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    if (typeof setFormType === 'function') {
                        setFormType(urlFormType);
                    }
                    if (typeof hideSignupTypeSection === 'function') {
                        hideSignupTypeSection();
                    }
                    if (typeof showFormSection === 'function') {
                        showFormSection(urlFormType);
                    }
                }
            }, 100);
        }

        const signinButtonSection = document.getElementById('signinButtonSection');
        const formContainer = document.getElementById('form-container');
        const userEmail = document.getElementById('userEmailDisplay');
        const signOutContainer = document.getElementById('signOutContainer');
        const signOutButton = document.getElementById('signOutButton');
        const hangOnMessage = document.getElementById('hang-on-message');
        const postForm = document.getElementById('post-form');
        const submitButton = document.getElementById('submitButton');
        const signupForm = document.getElementById('fields'); // The main signup form
        
        // If we have a submit button and form, attach the handler
        if (submitButton && signupForm) {
            // Prevent default form submission and use our custom handler
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                // Prevent double submission
                if (submitButton.classList.contains('processing')) {
                    return false;
                }
                submitForm();
                return false;
            });
        }
        
        // Listen for auth state changes
        document.addEventListener('authStateChanged', function(e) {
            const user = e.detail.user;
            handleAuthStateChange(user);
        });
        
        // Check current auth state immediately on page load
        firebase.auth().onAuthStateChanged(function(user) {
            handleAuthStateChange(user);
        });
        
        // Centralized function to handle auth state changes
        function handleAuthStateChange(user) {
            if (user) {
                // User is signed in - ensure sign-in UI is completely hidden
                signinButtonSection.style.display = 'none';
                userEmail.textContent = `Logged in as: ${user.email}`;
                signOutContainer.style.display = 'block';
                
                // IMPORTANT: Hide the sign-in overlay if it's visible
                const signinOverlay = document.getElementById('signin-overlay');
                if (signinOverlay) {
                    signinOverlay.style.display = 'none';
                    document.body.style.overflow = 'auto'; // Restore body scroll
                }
                
                // Don't immediately check or show form - let signinwidget handle redirects
                // We'll only display forms if we know we need to stay on this page
                hangOnMessage.style.display = 'block';
                setTimeout(function() {
                    // If we're still on this page after a short delay,
                    // the user probably needs to fill this form
                    redirectOrNot(user);
                }, 200);
            } else {
                // User is signed out
                signinButtonSection.style.display = 'block';
                formContainer.style.display = 'none';
                hangOnMessage.style.display = 'none';
                postForm.style.display = 'none';
                userEmail.textContent = '';
                signOutContainer.style.display = 'none';
                
                // Ensure sign-in overlay is hidden when signed out too
                const signinOverlay = document.getElementById('signin-overlay');
                if (signinOverlay) {
                    signinOverlay.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }
        }
        
        // Handle the signInComplete event
        document.addEventListener('signInComplete', function(e) {
            const user = e.detail.user;
            toggleSignIn(); // Hide the overlay
        });
        
        // Handle sign out
        if (signOutButton) {
            signOutButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                firebase.auth().signOut().then(function() {
                    // Sign-out successful
                    console.log('User signed out successfully');
                    
                    // Reload preserving the emulator parameter
                    const currentUrl = new URL(window.location.href);
                    window.location.href = currentUrl.toString();
                }).catch(function(error) {
                    console.error('Error signing out:', error);
                });
            });
        }
        
        // Set up test user functionality if in emulator mode
        setupTestUserBanner();
    });
    
    // Consolidated form submission handler
    function submitForm() {
        console.log('submitForm() called');
        const submitButton = document.getElementById('submitButton');
        if (submitButton.classList.contains('processing')) {
            console.log('Form already being processed');
            return;
        }
        
        console.log('Validating form...');
        // Get form validation result and data
        const result = validateFormAndGetData();
        console.log('Validation result:', result);
        
        if (!result.valid) {
            console.log('Form validation failed, not submitting');
            return false; // Form validation failed
        }
        
        console.log('Form validation passed, proceeding with submission');
        
        // Show processing state
        submitButton.classList.add('processing');
        
        // Get form type from the component
        const formType = currentFormType;
        console.log('Form type when submitting:', formType);
        
        // Submit to server based on form type
        if (formType === 'purchase' || formType === 'trial') {
            submitRegisterForm(result.data);
        } else if (formType === 'download') {
            submitSignupForm(result.data);
        } else {
            console.log("Unknown form type:", formType);
            submitButton.classList.remove('processing');
        }
    }
    
    // Server submission for registration
    function submitRegisterForm(formData) {
        // Get the host URL
        const hostURL = window.getHostUrl ? window.getHostUrl() : 
                       (useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 
                        'https://us-central1-eagleeyessearch.cloudfunctions.net');
        
        const fetch_url = hostURL + '/submit_register_form';
        console.log("Fetch URL:", fetch_url);
        
        // Final verification for trial form use_case field
        if (currentFormType === 'trial' && !formData.hasOwnProperty('use_case')) {
            console.error("Critical error: use_case field missing from trial form submission!");
            
            // Try to recover the value from the DOM
            const useCaseElement = document.getElementById('use-case');
            if (useCaseElement && useCaseElement.value) {
                console.log("Recovered use_case value: " + useCaseElement.value);
                formData.use_case = useCaseElement.value;
            } else {
                // If we can't recover, show an error to the user
                submitButton.classList.remove('processing');
                $("#status").html("Please fill in what you would use Eagle Eyes for").show();
                return; // Abort submission
            }
        }
        
        // Log what we're about to send
        console.log("Submitting form data to Firebase:", JSON.stringify(formData, null, 2));
        console.log("Form data keys:", Object.keys(formData));
        
        // Get auth token and submit
        firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                data: JSON.stringify(formData),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    console.log("Success", data);
                    submitButton.classList.remove('processing');

                    // Track successful trial request in Fathom Analytics
                    if (currentFormType === 'trial' && typeof fathom !== 'undefined') {
                        fathom.trackEvent('Trial Requested');
                        console.log('Fathom: Tracked Trial Requested');
                    }

                    // Hide form and sign-in elements
                    $("#form-container").hide();
                    $("#signin").hide();

                    // Display a different success message based on the form type
                    if (currentFormType === 'purchase') {
                        $("#post-form").html(
                          "<div style='text-align: center; padding: 20px;'>" +
                          "<strong>Thank you!</strong><br>" +
                          "Your verification request will typically be processed within 24 hours.<br>" +
                          "Once approved, you will be able to purchase a license using a credit card.<br>" +
                          "If you have any questions, please contact <a href='mailto:info@eagleeyessearch.com'>info@eagleeyessearch.com</a>." +
                          "</div>"
                        );
                    } else {
                        $("#post-form").html(
                          "<div style='text-align: center; padding: 20px;'>" +
                          "Your 30-day trial request was submitted successfully. We will contact you soon. " +
                          "Please reach out to <a href='mailto:info@eagleeyessearch.com'>info@eagleeyessearch.com</a> if you have any questions." +
                          "</div>"
                        );
                    }
                    
                    $("#post-form").show();
                    
                    // // Redirect after a short delay
                    // setTimeout(() => {
                    //     window.location.href = getUrlWithEmulatorParam('{{ '/account/' | relative_url }}');
                    // }, 2000);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    submitButton.classList.remove('processing');
                    console.error("Server error:", jqXHR.responseText);
                    requestErrorHandler(jqXHR, textStatus, errorThrown);
                }
            });
        }).catch(function(error) {
            console.error("Error getting auth token:", error);
            submitButton.classList.remove('processing');
        });
    }
    
    // Server submission for signup
    function submitSignupForm(formData) {
        // Get the host URL
        const hostURL = window.getHostUrl ? window.getHostUrl() : 
                      (useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 
                       'https://us-central1-eagleeyessearch.cloudfunctions.net');
        
        const fetch_url = hostURL + '/submit_signup_form';
        console.log("Fetch URL:", fetch_url);
        
        // Get auth token and submit
        firebase.auth().currentUser.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                data: JSON.stringify(formData),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    console.log("Signup Success", data);
                    submitButton.classList.remove('processing');

                    // Show success UI
                    $("#form-container").hide();
                    $("#signin").hide();
                    $("#post-form").html("<p style='text-align: center; padding: 20px;'>Success! Your download account has been created.<br>Redirecting...</p>").show();

                    // After a short delay, redirect appropriately
                    setTimeout(() => {
                        if (window.formReturnURL) {
                            console.log("Redirecting to returnURL:", window.formReturnURL);
                            window.location.href = decodeURIComponent(window.formReturnURL);
                        } else {
                            window.location.href = getUrlWithEmulatorParam('{{ '/account/' | relative_url }}');
                        }
                    }, 2000);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    submitButton.classList.remove('processing');
                    console.error("Server error:", jqXHR.responseText);  // Log the error response
                    requestErrorHandler(jqXHR, textStatus, errorThrown);
                }
            });
        }).catch(function(error) {
            console.error("Error getting auth token:", error);
            submitButton.classList.remove('processing');
        });
    }
    
    // Function to check if user has already filled in form
    function checkExistingForm(user) {
        const formContainer = document.getElementById('form-container');
        const hangOnMessage = document.getElementById('hang-on-message');
        const postForm = document.getElementById('post-form');

        // If success message is already showing, don't check again (form was already submitted)
        if (postForm) {
            const postFormStyle = window.getComputedStyle(postForm);
            if (postFormStyle.display !== 'none' && postForm.innerHTML.trim() !== '') {
                console.log('Form already submitted, success message is showing. Skipping check.');
                return;
            }
        }

        // Ensure the form is hidden until we get a result.
        formContainer.style.display = 'none';
        hangOnMessage.style.display = 'block';

        // Get the host URL for API calls
        const hostURL = window.getHostUrl ? window.getHostUrl() : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
        const fetch_url = hostURL + '/has_user_already_filled_in_form';

        user.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    hangOnMessage.style.display = 'none';
                    
                    console.log("Got reply from has_user_already_filled_in_form:", data);
                    // Parse the response if it's a string
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                    const formOrNull = parsedData.form;
                    
                    if (formOrNull === null) {
                        // User has not filled in the form yet: show the form now.
                        console.log('User did not fill in form yet.');
                        formContainer.style.display = 'block';
                    } else {
                        // Store the form data for prefilling
                        window.existingUserFormData = formOrNull;
                        console.log("Retrieved existing form data:", formOrNull);

                        // User has already filled in the form: redirect appropriately
                        if (window.formReturnURL) {
                            console.log("User already filled in form. Redirecting back to returnURL");
                            window.location.href = decodeURIComponent(window.formReturnURL);
                        } else {
                            console.log("User already filled in form. Redirecting to account/");
                            window.location.href = getUrlWithEmulatorParam('{{ '/account/' | relative_url }}');
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    hangOnMessage.style.display = 'none';
                    console.error("Error checking form:", textStatus, errorThrown, jqXHR.responseText);
                    
                    // On error, show the form anyway.
                    formContainer.style.display = 'block';
                }
            });
        }).catch(function(error) {
            hangOnMessage.style.display = 'none';
            console.error("Error getting ID token:", error);
            // On error, show the form anyway.
            formContainer.style.display = 'block';
        });
    }
    
    // Function to get existing user data for prefilling forms
    function fetchUserDataForPrefill(user, callback) {
        // Get the host URL for API calls
        const hostURL = window.getHostUrl ? window.getHostUrl() : 
                      (useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 
                       'https://us-central1-eagleeyessearch.cloudfunctions.net');
        
        const fetch_url = hostURL + '/has_user_already_filled_in_form';

        user.getIdToken(true).then(function(idToken) {
            $.ajax({
                url: fetch_url,
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(data) {
                    // Parse the response if it's a string
                    const parsedData = typeof data === 'string' ? JSON.parse(data) : data;
                    const formOrNull = parsedData.form;
                    
                    if (formOrNull !== null) {
                        console.log("Retrieved existing form data for prefill");
                        window.existingUserFormData = formOrNull;
                        
                        // Call callback with the data
                        if (callback && typeof callback === 'function') {
                            callback(formOrNull);
                        }
                    } else {
                        console.log("No existing form data found for prefill");
                        window.existingUserFormData = null;
                        
                        // Call callback with null
                        if (callback && typeof callback === 'function') {
                            callback(null);
                        }
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching user data for prefill:", textStatus);
                    window.existingUserFormData = null;
                    
                    if (callback && typeof callback === 'function') {
                        callback(null);
                    }
                }
            });
        }).catch(function(error) {
            console.error("Error getting ID token for prefill");
            window.existingUserFormData = null;
            
            if (callback && typeof callback === 'function') {
                callback(null);
            }
        });
    }
    
    // Function to prefill form fields with user data
    function prefillFormFields(formData) {
        if (!formData) {
            return;
        }
        
        // Simple direct field mapping for all fields
        const fieldIds = [
            'first_name', 
            'last_name', 
            'title',
            'team',         // Organization name
            'website',      // Organization website
            'location',     // Location
            'use-case'
        ];
        
        // Prefill fields by their direct IDs
        fieldIds.forEach(fieldId => {
            const element = document.getElementById(fieldId);
            // Use different property name for "use-case" field
            const dataKey = fieldId === 'use-case' ? 'use_case' : fieldId;
            
            if (element && formData[dataKey]) {
                element.value = formData[dataKey];
            }
        });
        
        // Try direct querySelector as backup
        if (formData.team) {
            const teamElements = document.querySelectorAll('[name="team"]');
            if (teamElements.length > 0) {
                teamElements[0].value = formData.team;
            }
        }
        
        if (formData.website) {
            const websiteElements = document.querySelectorAll('[name="website"]');
            if (websiteElements.length > 0) {
                websiteElements[0].value = formData.website;
            }
        }
        
        if (formData.location) {
            const locationElements = document.querySelectorAll('[name="location"]');
            if (locationElements.length > 0) {
                locationElements[0].value = formData.location;
            }
        }
        
        // Handle radio buttons
        for (const [key, value] of Object.entries(formData)) {
            const radioButtons = document.querySelectorAll(`input[type="radio"][name="${key}"]`);
            if (radioButtons.length > 0) {
                radioButtons.forEach(radio => {
                    if (radio.value === value) {
                        radio.checked = true;
                    }
                });
            }
        }
        
        // Handle checkboxes
        for (const [key, value] of Object.entries(formData)) {
            if (typeof value === 'boolean') {
                const checkbox = document.querySelector(`input[type="checkbox"][name="${key}"]`);
                if (checkbox) {
                    checkbox.checked = value;
                }
            }
        }
    }
    
    // Toggle the sign in overlay
    function toggleSignIn() {
        const overlay = document.getElementById('signin-overlay');
        
        // Check if user is already authenticated - don't show overlay if they are
        const currentUser = firebase.auth().currentUser;
        if (currentUser) {
            console.log('User is already authenticated, not showing sign-in overlay');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
            return;
        }
        
        // Toggle overlay visibility for unauthenticated users
        const isCurrentlyVisible = overlay.style.display === 'block';
        overlay.style.display = isCurrentlyVisible ? 'none' : 'block';
        document.body.style.overflow = isCurrentlyVisible ? 'auto' : 'hidden';
    }
    
    // Utility function to preserve important parameters when redirecting
    function getUrlWithEmulatorParam(url) {
        // Get current URL parameters to preserve important ones
        const currentParams = new URLSearchParams(window.location.search);
        const newParams = new URLSearchParams();
        
        // Always preserve emulator parameter if present
        if (currentParams.has('is_emulator')) {
            newParams.set('is_emulator', currentParams.get('is_emulator'));
        }
        
        // Preserve important parameters that should carry over to account page
        const preserveParams = ['device_count', 'machine_id'];
        preserveParams.forEach(param => {
            if (currentParams.has(param)) {
                newParams.set(param, currentParams.get(param));
            }
        });
        
        // Add parameters to URL if any exist
        if (newParams.toString()) {
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}${newParams.toString()}`;
        }
        
        return url;
    }
    
    // Get emulator status from URL
    function getIsEmulatorFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('is_emulator')?.toLowerCase() === 'true';
    }
    
    // Setup test user banner
    function setupTestUserBanner() {
        // Check if we're in emulator mode
        const urlParams = new URLSearchParams(window.location.search);
        const isEmulator = urlParams.get('is_emulator') === 'true';
        
        if (isEmulator) {
            // Show the test user banner
            const banner = document.getElementById('test-user-banner');
            if (banner) banner.style.display = 'block';
            
            // Set up the test user login button
            const testUserBtn = document.getElementById('test-user-login');
            if (testUserBtn) {
                testUserBtn.addEventListener('click', function() {
                    // Test user credentials
                    const testEmail = 'test@example.com';
                    const testPassword = 'password123';
                    
                    // Store current URL with parameters before sign-in
                    const currentUrl = window.location.href;
                    
                    // Try to sign in first
                    firebase.auth().signInWithEmailAndPassword(testEmail, testPassword)
                        .then((userCredential) => {
                            console.log('Test user signed in successfully');
                            // If the page reloads, ensure we come back to a URL with the emulator param
                            window.history.replaceState(null, document.title, currentUrl);
                        })
                        .catch((error) => {
                            // If sign-in fails, create the user first
                            if (error.code === 'auth/user-not-found') {
                                console.log('Test user not found, creating account...');
                                firebase.auth().createUserWithEmailAndPassword(testEmail, testPassword)
                                    .then((userCredential) => {
                                        console.log('Test user created and signed in successfully');
                                        // If the page reloads, ensure we come back to a URL with the emulator param
                                        window.history.replaceState(null, document.title, currentUrl);
                                    })
                                    .catch((createError) => {
                                        console.error('Error creating test user:', createError);
                                    });
                } else {
                                console.error('Error signing in with test user:', error);
                            }
                        });
                });
            }
        }
    }
    
    // Error handler function
    function requestErrorHandler(jqXHR, textStatus, errorThrown) {
        $("#hang-on-message").hide();
        console.log("Error: " + errorThrown);
        console.log("Status: " + textStatus);
        console.log("Response: " + (jqXHR && jqXHR.responseText ? jqXHR.responseText : "No response"));
        showError("Error: " + errorThrown + " Status: " + textStatus + " Response: " + (jqXHR && jqXHR.responseText ? jqXHR.responseText : "No response"));
    }

    function showError(message) {
        // Show an error message to the user
        var errorBox = document.createElement('div');
        errorBox.classList.add('error-box');
        // Width 80% of the screen
        errorBox.style.width = '80%';
        // Center horizontally
        errorBox.style.margin = '0 auto';

        errorBox.textContent = message;
        document.body.appendChild(errorBox);

        // Scroll to the bottom of the page
        window.scrollTo(0, document.body.scrollHeight);
    }
    
    // Initialize the component - called by parent page

    
    // Method to validate form and return result
    function validateFormAndGetData() {
        const isValid = validateForm();
        
        if (!isValid) {
            console.log("Form validation failed");
            $("#status").html("Please complete all required fields").show();
            return { valid: false, data: null };
        }
        
        // If valid, collect the form data
        const formData = collectFormData();
        return { valid: true, data: formData };
    }
    
    // Setup function - binds internal events
 

    function redirectOrNot(user) {
        // Check if form was already successfully submitted
        const postForm = document.getElementById('post-form');
        if (postForm) {
            const postFormStyle = window.getComputedStyle(postForm);
            if (postFormStyle.display !== 'none' && postForm.innerHTML.trim() !== '') {
                console.log('Form already submitted, success message is showing. Skipping redirectOrNot.');
                return;
            }
        }

        // Get URL parameters first
        const urlParams = new URLSearchParams(window.location.search);
        const reason = urlParams.get('reason');
        const hangOnMessage = document.getElementById('hang-on-message');
        const formContainer = document.getElementById('form-container');
        
        // First check URL parameters to see if we should show a specific form
        if (reason === 'trial' || reason === 'purchase') {
            // Hide the loading message
            hangOnMessage.style.display = 'none';
            
            // Find and select the corresponding radio button
            const radioButton = document.querySelector(`input[name="signup_type"][value="${reason}"]`);
            if (radioButton) {
                radioButton.checked = true;
                setFormType(reason);
                hideSignupTypeSection();
                showFormSection(reason);
                
                // Make sure user is authenticated before fetching data
                if (user) {
                    // Show the form first to ensure all fields are in the DOM
                    formContainer.style.display = 'block';
                    
                    // Fetch user data for prefill with a delay to ensure DOM is ready
                    setTimeout(() => {
                        fetchUserDataForPrefill(user, function(formData) {
                            // Prefill form if we have data
                            if (formData) {
                                prefillFormFields(formData);
                            }
                        });
                    }, 500);
                } else {
                    formContainer.style.display = 'block';
                }
            } else {
                // Fallback - just show the form with the radio buttons
                // Hide the loading message
                hangOnMessage.style.display = 'none';
                
                // Show the form container without pre-selecting any option
                formContainer.style.display = 'block';
            }
        } else {
            // No reason parameter, check if user has already filled the form
            checkExistingForm(user);
        }
    }
    
    // Initialize form type variables
    var currentFormType = "";  // Current form type
    var prevFormType = "";     // Previous form type for detecting changes
    var useLocalFirebaseEmulator = getIsEmulatorFromURL();
    var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
    
    // Function to set and validate form type
    function setFormType(type) {
        // Store previous value before changing
        prevFormType = currentFormType;
        
        // Validate type is one of the allowed values
        if (['download', 'purchase', 'trial'].includes(type)) {
            currentFormType = type;
            } else {
            console.error("Invalid form type: " + type + ". Must be download, purchase, or trial.");
            currentFormType = ""; // Reset to empty if invalid
        }
        
        // Log form type change to console
        if (prevFormType !== currentFormType) {
            console.log("Form type changed from: " + (prevFormType || "none") + " to: " + currentFormType);
        }
        
        return currentFormType;
    }
    
    // Handle signup type change
    function handleSignupTypeChange(radio) {
        // Set and validate the form type
        const formType = setFormType(radio.value);
        
        // Show the appropriate form section
        showFormSection(formType);
        
        // If we have a signed-in user, fetch their form data for prefill
        const user = firebase.auth().currentUser;
        if (user && (formType === 'purchase' || formType === 'trial')) {
            // Add a slight delay to ensure DOM is ready
            setTimeout(() => {
                fetchUserDataForPrefill(user, prefillFormFields);
            }, 300);
        }
    }
    
    // Handle "How did you hear about us?" change - show/hide "Other" text input
    function handleHearAboutUsChange(radio) {
        const otherInput = document.getElementById('hear_about_us_other');
        if (!otherInput || radio.disabled) {
            return;
        }

        if (radio.value === 'Other') {
            otherInput.style.display = 'block';
            otherInput.disabled = false;
            otherInput.required = true;
            otherInput.focus();
        } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
            otherInput.disabled = true;
            otherInput.value = ''; // Clear the value when hidden
        }
    }

    function setSectionInputsEnabled(container, shouldEnable) {
        if (!container) {
            return;
        }

        // Only process inputs that are actually inside this container
        // This prevents accidentally disabling common fields
        const inputs = container.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            // Double-check the input is actually a child of this container
            if (!container.contains(input)) {
                return;
            }
            
            input.disabled = !shouldEnable;

            if (!shouldEnable) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            }
        });
    }

    function setVerificationFieldsVisibility(shouldShow) {
        const verificationFields = document.getElementById('verification-fields');
        if (!verificationFields) {
            return;
        }

        verificationFields.style.display = shouldShow ? 'block' : 'none';

        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
            phoneInput.disabled = !shouldShow;
            if (!shouldShow) {
                phoneInput.value = '';
            }
        }

        const websiteInput = document.getElementById('website');
        if (websiteInput) {
            websiteInput.disabled = !shouldShow;
            websiteInput.required = shouldShow;
            if (!shouldShow) {
                websiteInput.value = '';
            }
        }

        const hearAboutUsRadios = document.querySelectorAll('input[name="hear_about_us"]');
        hearAboutUsRadios.forEach(radio => {
            radio.disabled = !shouldShow;
            radio.required = shouldShow;
            if (!shouldShow) {
                radio.checked = false;
            }
        });

        const hearAboutUsOtherInput = document.getElementById('hear_about_us_other');
        if (hearAboutUsOtherInput) {
            hearAboutUsOtherInput.disabled = true;
            hearAboutUsOtherInput.required = false;
            hearAboutUsOtherInput.style.display = 'none';
            if (!shouldShow) {
                hearAboutUsOtherInput.value = '';
            }
        }
    }
    
    // Function to show/hide appropriate form sections
    function showFormSection(formType) {
        const additionalFields = document.getElementById('additional-fields');
        const downloadQuestions = document.getElementById('download-questions');
        const trialQuestions = document.getElementById('trial-questions');
        const purchaseQuestions = document.getElementById('purchase-questions');
        const titleElement = document.getElementById('formTypeTitle');
        const descriptionElement = document.getElementById('formTypeDescription');
        
        // First, show the additional fields
        additionalFields.style.display = 'block';
        
        // Hide all question sections first and disable their inputs
        downloadQuestions.style.display = 'none';
        trialQuestions.style.display = 'none';
        purchaseQuestions.style.display = 'none';

        setSectionInputsEnabled(downloadQuestions, false);
        setSectionInputsEnabled(trialQuestions, false);
        setSectionInputsEnabled(purchaseQuestions, false);
        
        // Set default empty values for title and description
        titleElement.innerHTML = '';
        descriptionElement.innerHTML = '';
        
        // Show or hide verification-only fields for trial/purchase forms
        setVerificationFieldsVisibility(formType === 'trial' || formType === 'purchase');

        // Show the appropriate question section and update title/description based on form type
        switch(formType) {
            case 'trial':
                trialQuestions.style.display = 'block';
                setSectionInputsEnabled(trialQuestions, true);
                titleElement.innerHTML = 'Register for a 30-day trial';
                descriptionElement.innerHTML = 'To access a trial license, your account needs to be verified first. Please complete this form to submit your verification request. ' +
                    'Verification can take up to 3 business days, though most requests are processed within 24 hours. Once verified, we will set you up with a trial license and you\'ll be able to activate Eagle Eyes Pilot and/or Eagle Eyes Scan on up to 5 devices using your trial license.';
                break;
            
            case 'download':
                downloadQuestions.style.display = 'block';
                setSectionInputsEnabled(downloadQuestions, true);
                titleElement.innerHTML = 'Create an account to download Eagle Eyes';
                descriptionElement.innerHTML = 'Already have an active license for yourself or your team? Complete this form to create an account and you\'ll get immediate access to the downloads section.<br><br>' +
                    '<i>Note: An active license is required to activate Eagle Eyes on your device.</i>';
                break;
            
            case 'purchase':
                purchaseQuestions.style.display = 'block';
                setSectionInputsEnabled(purchaseQuestions, true);
                titleElement.innerHTML = 'Get verified to purchase a license';
                descriptionElement.innerHTML = 'To purchase a license, your account needs to be verified first. Please complete this form to submit your verification request. ' + 
                    'Verification can take up to 3 business days, though most requests are processed within 24 hours. We\'ll send you a confirmation by email as soon as your account is verified.';
                break;
            
            default:
                // If no valid form type, hide additional fields
                additionalFields.style.display = 'none';
                return;
        }
        
        // Check if we should prefill form fields
        if (window.existingUserFormData) {
            // Use timeout to ensure form is fully visible before prefill
            setTimeout(() => {
                prefillFormFields(window.existingUserFormData);
            }, 300);
        }
        
        // Smooth scroll to the additional fields
        additionalFields.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function isElementVisible(element) {
        // Check if element is hidden with display:none
        if (element.offsetParent === null) return false;
        
        // Also check parent containers
        let parent = element.parentElement;
        while (parent) {
            const style = window.getComputedStyle(parent);
            if (style.display === 'none' || style.visibility === 'hidden') {
                return false;
            }
            parent = parent.parentElement;
        }
        
        return true;
    }
    
    function validateForm() {
        var isValid = true;
        var requiredFields = document.querySelectorAll('#fields [required]');
        var radioGroups = {};
        var validationErrors = [];

        // Only log once at the start
        console.log(`Validating form (type: ${currentFormType})`);
        
        // Special handling for use_case field in trial form
        if (currentFormType === 'trial') {
            const useCaseElement = document.getElementById('use-case');
            if (useCaseElement) {
                console.log("Validating use-case element:", useCaseElement);
                console.log("use-case visibility:", isElementVisible(useCaseElement));
                console.log("use-case value:", useCaseElement.value);
                
                // Force validate this field separately
                if (!useCaseElement.value || !useCaseElement.value.trim()) {
                    isValid = false;
                    useCaseElement.style.borderColor = 'red';
                    validationErrors.push("Empty field: What are you interested in using Eagle Eyes for?");
                } else {
                    useCaseElement.style.borderColor = '';
                }
            }
        }
        
        requiredFields.forEach(function(field) {
            // Skip fields that are not visible
            if (!isElementVisible(field)) return;

            if (field.hasAttribute('required')) {
                if (field.type === 'radio') {
                    if (!radioGroups[field.name]) {
                        radioGroups[field.name] = [];
                    }
                    radioGroups[field.name].push(field);
                } else if (field.type === 'checkbox' && !field.checked) {
                    isValid = false;
                    field.nextElementSibling.style.color = 'red';
                    validationErrors.push(`Checkbox not checked: ${field.name}`);
                } else if (field.type !== 'checkbox' && field.type !== 'radio') {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.style.borderColor = 'red';
                        const fieldLabel = field.previousElementSibling ? field.previousElementSibling.textContent : field.name;
                        validationErrors.push(`Empty field: ${fieldLabel.trim()}`);
                    } else {
                        field.style.borderColor = '';
                    }
                }
            }
        });
        
        // Validate radio button groups
        Object.keys(radioGroups).forEach(function(groupName) {
            var group = radioGroups[groupName];
            var groupIsValid = group.some(function(radio) {
                return radio.checked;
            });
            
            if (!groupIsValid) {
                isValid = false;
                group.forEach(function(radio) {
                    radio.nextElementSibling.style.color = 'red';
                });
                validationErrors.push(`No selection made for: ${groupName}`);
            } else {
                group.forEach(function(radio) {
                    radio.nextElementSibling.style.color = '';
                });
            }
        });

        // Only log errors if validation failed
        if (!isValid) {
            console.group('Form Validation Failed');
            console.log(`${validationErrors.length} error(s):`);
            validationErrors.forEach(error => console.log('- ' + error));
            console.groupEnd();
        }
        
        return isValid;
    }

    // Collect form data into a standardized object
    function collectFormData() {
        var formData = {}; // Initialize the object
        
        // Pack the form data into an object
        var formInputs = document.querySelectorAll('input[name], select[name], textarea[name]');
        formInputs.forEach(function(input) {
            if (input.disabled) {
                return;
            }

            if (input.type === 'checkbox') {
                formData[input.name] = input.checked;
            } else if (input.type === 'radio') {
                if (input.checked) {
                    formData[input.name] = input.value;
                }
            } else {
                formData[input.name] = input.value;
            }
        });

        // Log the use_case field explicitly for debugging purposes
        console.log("use_case field before cleanup:", formData['use_case']);
        
        // Check if this is a trial form
        if (currentFormType === 'trial') {
            const useCaseElement = document.getElementById('use-case');
            console.log("use-case element:", useCaseElement);
            if (useCaseElement) {
                console.log("use-case visibility:", isElementVisible(useCaseElement));
                console.log("use-case value:", useCaseElement.value);
            }
        }

        // Remove empty keys or invalid entries
        for (var key in formData) {
            if (formData[key] === null || formData[key] === undefined || 
                (typeof formData[key] === 'string' && formData[key].trim() === "")) {
                delete formData[key];
            }
        }

        // Ensure phone number stays a string (may contain + or leading zeros)
        if (formData.hasOwnProperty('phone')) {
            formData['phone'] = String(formData['phone']).trim();
            if (formData['phone'] === "") {
                delete formData['phone'];
            }
        }

        // Add combined name field
        if (formData['first_name'] && formData['last_name']) {
            formData['name'] = formData['first_name'].trim() + ' ' + formData['last_name'].trim();
        }

        if (currentFormType == 'trial') {
            // Add the trial type to the form data
            formData['trial_request'] = true;
            
            // Explicitly ensure use_case field is included for trial forms
            if (!formData.hasOwnProperty('use_case')) {
                console.warn("use_case field missing from trial form data!");
                const useCaseElement = document.getElementById('use-case');
                if (useCaseElement && useCaseElement.value) {
                    console.log("Manually adding use_case from element:", useCaseElement.value);
                    formData.use_case = useCaseElement.value;
                } else {
                    console.log("Could not retrieve use_case value from element");
                }
            }
        } else {
            formData['trial_request'] = false;
        }
        
        // Final check of the form data before returning
        console.log("Final form data:", formData);
        return formData;
    }

    // Function to hide the signup type question section
    function hideSignupTypeSection() {
        // Find the container that holds the radio buttons
        const radioGroupContainer = document.querySelector('.radio-group');
        
        if (radioGroupContainer) {
            // If there's a heading or label before the radio group, hide it too
            const previousElement = radioGroupContainer.previousElementSibling;
            if (previousElement && (previousElement.tagName === 'H3' || 
                                   previousElement.tagName === 'H4' || 
                                   previousElement.tagName === 'LABEL')) {
                previousElement.style.display = 'none';
            }
            
            // Hide the radio group itself
            radioGroupContainer.style.display = 'none';
        }
    }
</script>