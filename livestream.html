---
permalink: /livestream/
---
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Favicon -->
    <link rel="icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" type="image/png">
    <link rel="shortcut icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" type="image/png">

    <!-- PWA Configuration -->
    <link rel="manifest" href="{{ '/manifest.json' | relative_url }}">
    <meta name="theme-color" content="#314268">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Eagle Eyes Livestream">

    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Eagle Eyes Livestream">
    <link rel="apple-touch-icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="167x167" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:image" content="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    
    <title>Eagle Eyes Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      #main-content {
        flex: 1;
        display: flex;
        min-height: 0;
      }
      /* Portrait/narrow (aspect ratio < 1:1): video top, map bottom */
      @media (max-aspect-ratio: 1/1) {
        #main-content {
          flex-direction: column;
        }
      }
      /* Landscape/wide (aspect ratio >= 1:1): video left, map right */
      @media (min-aspect-ratio: 1/1) {
        #main-content {
          flex-direction: row;
        }
      }
      #video-panel,
      #map-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #000;
        min-height: 0;
      }
      /* Landscape: video gets 2/3 width, map gets 1/3 width (fixed) */
      @media (min-aspect-ratio: 1/1) {
        #video-panel {
          flex: 0 0 66.666667%;
        }
        #map-panel {
          flex: 0 0 33.333333%;
        }
      }
      /* Portrait: flexible sizing with constraints to optimize space */
      @media (max-aspect-ratio: 1/1) {
        #video-panel {
          flex: 1 1 auto;
          min-height: 40%;
          max-height: 70%;
        }
        #map-panel {
          flex: 1 1 auto;
          min-height: 30%;
        }
      }
      /* Full size for single-view modes */
      #video-panel.full-view,
      #map-panel.full-view {
        flex: 1 1 100%;
      }
      #map-panel {
        background-color: #181818;
      }
      #videoContainer,
      #map {
        width: 100%;
        flex: 1;
        min-height: 0;
      }
      #videoContainer {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      /* In portrait mode, align video to top instead of center */
      @media (max-aspect-ratio: 1/1) {
        #videoContainer {
          align-items: flex-start;
        }
      }
      #remoteVideo {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
        z-index: 2;
      }
      /* Play button overlay when video is paused */
      .play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 3;
        transition: all 0.3s ease;
      }
      .play-overlay:hover {
        background-color: rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%) scale(1.1);
      }
      .play-overlay i {
        color: white;
        font-size: 32px;
        margin-left: 4px; /* Compensate for play icon visual centering */
      }
      /* Remove shadow/gradient overlay from video controls */
      #remoteVideo::-webkit-media-controls-panel {
        background-image: none !important;
        background: transparent !important;
      }
      #remoteVideo::-webkit-media-controls-enclosure {
        background-image: none !important;
        background: transparent !important;
      }
      .stale-data-banner {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.96);
        color: #fff;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: clamp(11px, 2.8vw, 14px);
        font-weight: 600;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.28);
        display: inline-flex;
        flex-direction: column;
        gap: 4px;
        max-width: min(360px, calc(100% - 16px));
        width: auto;
        backdrop-filter: blur(3px);
        word-break: break-word;
      }
      .stale-data-banner__header {
        display: flex;
        align-items: center;
        gap: 8px;
        line-height: 1.3;
        font-size: inherit;
      }
      .stale-data-banner__header i {
        font-size: 1.05em;
      }
      .stale-data-banner__meta {
        font-size: clamp(10px, 2.4vw, 12px);
        font-weight: 500;
        opacity: 0.9;
        line-height: 1.4;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }
      .gps-signal-banner {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(220, 53, 69, 0.95);
        color: #ffffff;
        border-radius: 10px;
        padding: 12px 16px;
        box-shadow: 0 12px 28px rgba(220, 53, 69, 0.25);
        display: inline-flex;
        flex-direction: column;
        gap: 6px;
        max-width: min(340px, calc(100% - 16px));
        z-index: 2050;
        font-size: clamp(13px, 3.2vw, 14px);
        pointer-events: none;
      }
      .gps-signal-banner__header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        line-height: 1.35;
      }
      .gps-signal-banner__header i {
        font-size: 1.15em;
      }
      .gps-signal-banner__meta {
        font-size: clamp(11px, 2.8vw, 13px);
        line-height: 1.45;
        opacity: 0.95;
      }
      @media (max-width: 576px) {
        .gps-signal-banner {
          top: 8px;
          right: 8px;
          padding: 10px 14px;
          border-radius: 8px;
          max-width: calc(100% - 12px);
        }
      }
      .basemap-popup {
        position: absolute;
        top: 52px;
        left: 12px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18), 0 6px 14px rgba(15, 23, 42, 0.12);
        padding: 16px;
        min-width: 200px;
        max-width: min(92vw, 360px);
        max-height: calc(100vh - 120px);
        overflow: hidden;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        backdrop-filter: blur(6px);
        touch-action: pan-y;
      }
      .basemap-popup__content {
        overflow-y: auto;
        overscroll-behavior: contain;
        padding-right: 4px;
        margin-right: -2px;
        display: flex;
        flex-direction: column;
      }
      .basemap-popup label {
        margin: 6px 0 !important;
        font-size: 12.5px !important;
      }
      .basemap-popup__content::-webkit-scrollbar {
        width: 6px;
      }
      .basemap-popup__content::-webkit-scrollbar-track {
        background: transparent;
      }
      .basemap-popup__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        color: #1f2937;
        font-size: clamp(14px, 3.5vw, 16px);
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .basemap-popup__close {
        background: none;
        border: none;
        color: #6b7280;
        font-size: clamp(16px, 4vw, 20px);
        font-weight: 500;
        line-height: 1;
        padding: 4px 6px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .basemap-popup__close:focus {
        outline: 2px solid rgba(59, 130, 246, 0.45);
        outline-offset: 2px;
      }
      .basemap-popup__close:hover {
        color: #374151;
        background: #f3f4f6;
      }
      .basemap-popup__content::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }
      .measurement-popup {
        position: absolute;
        top: 52px;
        left: 12px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.12), 0 4px 10px rgba(0,0,0,0.08);
        padding: 12px;
        max-width: min(260px, calc(100vw - 24px));
        min-width: 180px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        touch-action: pan-y;
      }
      .measurement-popup__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        color: #1f2937;
        font-size: clamp(13px, 3.5vw, 14px);
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .measurement-popup__title {
        flex: 1;
      }
      .measurement-popup__close {
        background: none;
        border: none;
        color: #6b7280;
        font-size: clamp(18px, 4vw, 20px);
        line-height: 1;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .measurement-popup__close:hover {
        background: #f3f4f6;
        color: #374151;
      }
      .measurement-popup__close:focus {
        outline: 2px solid rgba(59, 130, 246, 0.45);
        outline-offset: 2px;
      }
      .measurement-popup__content {
        overflow-y: auto;
        padding-right: 4px;
        margin-right: -2px;
      }
      .measurement-popup__content::-webkit-scrollbar {
        width: 6px;
      }
      .measurement-popup__content::-webkit-scrollbar-track {
        background: transparent;
      }
      .measurement-popup__content::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }
      @media (max-width: 768px) {
        .basemap-popup {
          top: 12px;
          left: 50%;
          transform: translateX(-50%);
          width: calc(100vw - 24px);
          max-width: calc(100vw - 24px);
          max-height: calc(100vh - 80px);
          padding: 14px;
        }
        .basemap-popup__content {
          padding-right: 2px;
          margin-right: -1px;
        }
        .measurement-popup {
          top: 12px;
          left: 50%;
          transform: translateX(-50%);
          max-width: calc(100vw - 24px);
        }
      }
      @media (max-width: 480px) {
        .basemap-popup {
          top: 10px;
          border-radius: 10px;
          padding: 12px;
          font-size: 13px;
        }
      }
      #mobileControls .offcanvas-body {
        overflow-y: auto;
        max-height: calc(100vh - 58px);
        padding-bottom: 1.5rem;
      }
      @media (max-width: 576px) {
        .stale-data-banner {
          top: 8px;
          padding: 9px 14px;
          border-radius: 8px;
          max-width: calc(100% - 12px);
        }
        .stale-data-banner__header {
          font-size: clamp(12px, 3vw, 13px);
        }
        .stale-data-banner__meta {
          font-size: clamp(10px, 2.8vw, 11.5px);
        }
      }
      #videoMenuOverlayBtn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(34, 44, 62, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #f8fafc;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 5;
        backdrop-filter: blur(4px);
        box-shadow: 0 6px 12px rgba(15, 23, 42, 0.18);
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }
      #videoMenuOverlayBtn i {
        font-size: 16px;
      }
      #videoMenuOverlayBtn:hover {
        background: rgba(37, 47, 69, 0.82);
        border-color: rgba(148, 163, 184, 0.55);
      }
      #videoMenuOverlayBtn:focus {
        outline: 2px solid rgba(59, 130, 246, 0.55);
        outline-offset: 2px;
      }
      #video-panel.full-view #videoMenuOverlayBtn {
        display: flex;
      }
      @media (max-width: 576px) {
        #videoMenuOverlayBtn {
          top: 10px;
          right: 10px;
          width: 28px;
          height: 28px;
        }
        #videoMenuOverlayBtn i {
          font-size: 14px;
        }
      }
      @media (max-height: 520px) and (orientation: landscape) {
        .stale-data-banner {
          top: 6px;
          padding: 7px 12px;
          border-radius: 8px;
          max-width: calc(100% - 10px);
        }
        .stale-data-banner__header {
          gap: 6px;
          font-size: clamp(11px, 2.2vw, 13px);
        }
        .stale-data-banner__meta {
          font-size: clamp(9.5px, 2vw, 11px);
        }
      }
      .placeholder {
        width: 100%;
        height: 100%;
        color: #6c757d;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #050505;
        position: relative;
        z-index: 1;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }
      .status.connecting .status-dot {
        background-color: #0d6efd;
      }
      .status.waiting .status-dot {
        background-color: #ffc107;
      }
      .status.connected .status-dot {
        background-color: #b0b0b0;
      }
      .status.error .status-dot {
        background-color: #dc3545;
      }
      .beta-badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        background-color: #ffc107;
        color: #000;
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      /* Force show map when in fullscreen map mode */
      #map-panel[data-force-show="true"] {
        display: flex !important;
      }
      #roomIdToast,
      #coordsCopiedToast {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 193, 7, 0.95);
        color: #000;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1060;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      #coordsCopiedToast {
        background-color: rgba(70, 83, 115, 0.95);
        color: #fff;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      /* Dark theme for Leaflet map controls */
      .leaflet-bar,
      .leaflet-control {
        background-color: #2c2c2c !important;
        border: 1px solid #444 !important;
      }
      .leaflet-bar a,
      .leaflet-control a {
        background-color: #2c2c2c !important;
        color: #fff !important;
        border-bottom: 1px solid #444 !important;
      }
      .leaflet-bar a:hover,
      .leaflet-control a:hover {
        background-color: #3c3c3c !important;
      }
      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        color: #fff !important;
      }
      /* Dark theme for attribution text */
      .leaflet-control-attribution {
        background-color: rgba(44, 44, 44, 0.8) !important;
        color: #ccc !important;
      }
      .leaflet-control-attribution a {
        color: #b0b0b0 !important;
        background-color: transparent !important;
        border: none !important;
      }
      /* Dark theme for scale control */
      .leaflet-control-scale {
        background: none !important;
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
        z-index: 1000 !important;
      }
      .leaflet-control-scale-line {
        background: none !important;
        background-color: transparent !important;
        border: 2px solid #fff !important;
        border-top: none !important;
        color: #fff !important;
      }
      /* Ensure map popups appear above scale bar */
      .leaflet-popup {
        z-index: 2000 !important;
      }
      .leaflet-popup-pane {
        z-index: 2000 !important;
      }
      /* Style layer control to be visible */
      .leaflet-control-layers {
        width: auto !important;
        height: auto !important;
      }
      
      /* Disable hover behavior - only open on click */
      .leaflet-control-layers:hover .leaflet-control-layers-expanded {
        display: none !important;
      }
      
      /* Additional CSS to prevent hover behavior */
      .leaflet-control-layers a:hover + .leaflet-control-layers-expanded,
      .leaflet-control-layers a:focus + .leaflet-control-layers-expanded {
        display: none !important;
      }
      
      /* Ensure expanded panel is hidden by default */
      .leaflet-control-layers-expanded {
        display: none;
      }
      
      /* Only show when explicitly opened via click */
      .leaflet-control-layers.leaflet-control-layers-expanded .leaflet-control-layers-expanded,
      .leaflet-control-layers.leaflet-control-layers-expanded .leaflet-control-layers-list {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      .leaflet-control-layers-toggle {
        width: 40px !important;
        height: 40px !important;
        background-size: 20px 20px !important;
        background-position: center !important;
      }
      
      /* Mobile optimization for layer control */
      @media (max-width: 768px) {
        .leaflet-control-layers-toggle {
          width: 35px !important;
          height: 35px !important;
          background-size: 18px 18px !important;
        }
      }
      /* Fix layer control text visibility */
      .leaflet-control-layers label {
        color: #000 !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        text-shadow: 2px 2px 4px rgba(255,255,255,0.9) !important;
        background: rgba(255,255,255,0.9) !important;
        padding: 4px 8px !important;
        border-radius: 3px !important;
        margin: 2px 0 !important;
        display: block !important;
      }
      .leaflet-control-layers input[type="radio"] {
        margin-right: 8px !important;
      }
      .leaflet-control-layers-expanded {
        background: rgba(255,255,255,0.95) !important;
        border-radius: 5px !important;
        padding: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
      }
      
      /* North arrow control styling */
      .north-arrow-control {
        background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
        border: 2px solid #2c3e50 !important;
        border-radius: 4px !important;
        width: 40px !important;
        height: 40px !important;
        cursor: pointer !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        margin-bottom: 5px !important;
        font-family: Arial, sans-serif !important;
      }
      
      /* Mobile optimization for north arrow */
      @media (max-width: 768px) {
        .north-arrow-control {
          width: 35px !important;
          height: 35px !important;
        }
      }
      
      .north-arrow-control:hover {
        transform: scale(1.05) !important;
        box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
      }
      
      /* User-facing mode (blue) */
      .north-arrow-control.user-facing {
        background: linear-gradient(135deg, #3498db, #2980b9) !important;
        border-color: #1f4e79 !important;
      }
      
      .north-arrow-control.user-facing:hover {
        background: linear-gradient(135deg, #5dade2, #3498db) !important;
      }
      
      /* North mode (light) */
      .north-arrow-control.north-oriented {
        background: linear-gradient(135deg, #ffffff, #f8f9fa) !important;
        border-color: #2c3e50 !important;
      }
      
      .north-arrow-control.north-oriented:hover {
        background: linear-gradient(135deg, #ffffff, #e8f4fd) !important;
      }
      
      .north-arrow {
        width: 0 !important;
        height: 0 !important;
        border-left: 5px solid transparent !important;
        border-right: 5px solid transparent !important;
        border-bottom: 12px solid #e74c3c !important;
        transition: transform 0.3s ease !important;
        transform-origin: center bottom !important;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)) !important;
      }
      
      .north-label {
        font-size: 8px !important;
        font-weight: bold !important;
        color: #2c3e50 !important;
        margin-top: 1px !important;
        text-shadow: 0 1px 2px rgba(255,255,255,0.8) !important;
      }
      
      .mode-indicator {
        position: absolute !important;
        top: -4px !important;
        right: -4px !important;
        width: 10px !important;
        height: 10px !important;
        border-radius: 50% !important;
        background: #27ae60 !important;
        border: 1px solid white !important;
        font-size: 6px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: white !important;
        font-weight: bold !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
      }
      
      /* Fullscreen control styling */
      .fullscreen-control {
        background-color: rgba(44, 44, 44, 0.6) !important;
        border: 1px solid #444 !important;
        border-radius: 4px !important;
        width: 40px !important;
        height: 40px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        margin-bottom: 5px !important;
        font-family: Arial, sans-serif !important;
      }
      
      /* Mobile optimization for fullscreen control */
      @media (max-width: 768px) {
        .fullscreen-control {
          width: 35px !important;
          height: 35px !important;
        }
      }
      
      /* Center on drone control styling */
      .leaflet-control-center {
        width: 40px !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-bottom: 0px !important;
      }
      
      .leaflet-control-center img {
        width: 24px !important;
        height: 24px !important;
      }
      
      /* Measurement (ruler) control styling */
      .leaflet-control-measurement {
        width: 40px !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-bottom: 0px !important;
        margin-top: 0px !important;
      }
      
      .leaflet-control-measurement img {
        width: 24px !important;
        height: 24px !important;
      }
      
      /* Custom base map control styling */
      .leaflet-control-basemap {
        width: 40px !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-bottom: 0px !important;
        margin-top: 0px !important;
      }
      
      /* Remove default margins from widget container divs for tight stacking */
      .leaflet-top.leaflet-left .leaflet-bar.leaflet-control {
        margin-bottom: 0px !important;
      }
      
      /* Base map popup styling */
      .basemap-popup .leaflet-popup-content-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        padding: 0;
      }
      
      .basemap-popup .leaflet-popup-content {
        margin: 0;
        padding: 0;
      }
      
      .basemap-popup .leaflet-popup-tip {
        background: white;
      }
      
      /* User marker popup styling - compact and mobile-friendly */
      .user-marker-popup .leaflet-popup-content-wrapper {
        padding: 0 !important;
        border-radius: 4px !important;
      }
      
      .user-marker-popup .leaflet-popup-content {
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .user-marker-popup .leaflet-popup-content button {
        touch-action: manipulation !important; /* Better touch handling on mobile */
        -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
      }
      
      /* Mobile optimization for user marker popups */
      @media (max-width: 768px) {
        .user-marker-popup {
          max-width: 160px !important;
        }
        
        .user-marker-popup .leaflet-popup-content {
          font-size: 11px !important;
        }
      }
      
      /* Multi-hit popup styling - fixed dimensions with scrolling */
      .multi-hit-popup .leaflet-popup-content-wrapper {
        padding: 0 !important;
        overflow: hidden !important;
        border-radius: 8px !important;
      }
      
      .multi-hit-popup .leaflet-popup-content {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        height: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* Position close button properly - ensure it's above navigation buttons */
      .multi-hit-popup .leaflet-popup-close-button {
        z-index: 1001 !important;
        width: 28px !important;
        height: 28px !important;
        line-height: 28px !important;
        font-size: 20px !important;
        padding: 0 !important;
        margin: 0 !important;
        top: 8px !important;
        right: 8px !important;
        text-align: center !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 50% !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      }
      
      /* Ensure buttons are visible and not cut off */
      .multi-hit-popup button {
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: rgba(0,0,0,0.1) !important;
        flex-shrink: 0 !important;
      }
      
      /* Style navigation buttons to not overlap close button */
      .multi-hit-popup .leaflet-popup-content button {
        min-width: 36px !important;
        min-height: 32px !important;
        padding: 6px 10px !important;
      }
      
      /* Visible scrollbar styling for popup content - always visible */
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content {
        /* Force scrollbar to always be visible */
        overflow-y: scroll !important;
        scrollbar-width: thin !important;
        scrollbar-color: #999 #f0f0f0 !important;
      }
      
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content::-webkit-scrollbar {
        width: 10px !important;
        -webkit-appearance: none !important;
      }
      
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content::-webkit-scrollbar-track {
        background: #f0f0f0 !important;
        border-radius: 4px !important;
        -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0.1) !important;
      }
      
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content::-webkit-scrollbar-thumb {
        background: #999 !important;
        border-radius: 4px !important;
        border: 1px solid #f0f0f0 !important;
        -webkit-box-shadow: inset 0 0 1px rgba(0,0,0,0.2) !important;
      }
      
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content::-webkit-scrollbar-thumb:hover {
        background: #777 !important;
      }
      
      /* Ensure scrollbar is always visible, not just on hover */
      .multi-hit-popup .leaflet-popup-content .popup-scrollable-content::-webkit-scrollbar-thumb:active {
        background: #666 !important;
      }
      
      /* Mobile optimization for center control */
      @media (max-width: 768px) {
        .leaflet-control-center {
          width: 35px !important;
          height: 35px !important;
        }
        .leaflet-control-center img {
          width: 20px !important;
          height: 20px !important;
        }
        
        .leaflet-control-measurement {
          width: 35px !important;
          height: 35px !important;
        }
        .leaflet-control-measurement img {
          width: 20px !important;
          height: 20px !important;
        }
        
        /* Base map control should match center control size on mobile */
        .leaflet-control-basemap {
          width: 35px !important;
          height: 35px !important;
        }
        .leaflet-control-basemap > div {
          width: 18px !important;
          height: 18px !important;
          background-size: 18px 18px !important;
        }
      }
      
      /* Mobile optimization for all map controls */
      @media (max-width: 768px) {
        /* Increase touch targets for mobile */
        .leaflet-control {
          margin: 2px !important;
        }
        
        /* Scale control positioning for mobile - all the way to the left */
        .leaflet-control-scale {
          margin-left: 0 !important;
        }
        
        /* Make scale control more readable on mobile */
        .leaflet-control-scale-line {
          font-size: 12px !important;
          padding: 2px 4px !important;
        }
        
        /* Ensure controls don't overlap on small screens */
        .leaflet-control-zoom {
          margin: 2px !important;
        }
        
        /* Optimize layer control popup for mobile */
        .leaflet-control-layers-expanded {
          max-width: 250px !important;
          font-size: 14px !important;
        }
        
        /* Make north arrow text more readable on mobile */
        .north-label {
          font-size: 8px !important;
        }
        
        .mode-indicator {
          font-size: 6px !important;
        }
      }
      
      .fullscreen-control:hover {
        background-color: rgba(60, 60, 60, 0.7) !important;
        transform: scale(1.05) !important;
        box-shadow: 0 3px 8px rgba(0,0,0,0.4) !important;
      }
      
      .fullscreen-icon {
        width: 16px !important;
        height: 16px !important;
        position: relative !important;
      }
      
      .expand-icon, .close-icon {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-size: contain !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        transition: opacity 0.3s ease !important;
      }
      
      /* Scale control positioning - all the way to the left */
      .leaflet-control-scale {
        margin-left: 0 !important;
      }
      /* Hide navbar brand text on narrow screens */
      @media (max-width: 991px) {
        .navbar-brand span:not(.beta-badge) {
          display: none;
        }
      }
      /* Hide history dropdown at medium sizes to prevent navbar overflow */
      @media (min-width: 768px) and (max-width: 991px) {
        #historyDropdown {
          display: none !important;
        }
      }
      /* Reduce navbar spacing at medium sizes */
      @media (min-width: 768px) and (max-width: 991px) {
        .navbar .btn,
        .navbar .btn-group {
          margin-right: 0.5rem !important;
        }
        /* Remove margin from viewer count at medium sizes */
        #viewerCount {
          margin-right: 0 !important;
        }
      }
      /* Hide viewer count text at smaller medium sizes, keep icon */
      @media (min-width: 768px) and (max-width: 900px) {
        #viewerCount {
          display: none !important;
        }
      }
      /* Compact navbar styling */
      .navbar {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      .navbar-brand {
        margin-right: 0.5rem;
        font-size: 0.9rem;
      }
      .navbar-brand img {
        height: 32px !important;
        margin-right: 0.5rem !important;
      }
      #fullscreenNavBtn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 0.35rem 0.5rem;
        font-size: 0.9rem;
        line-height: 1;
      }
      #fullscreenNavBtn .fullscreen-nav-icon-expand,
      #fullscreenNavBtn .fullscreen-nav-icon-close {
        font-size: 1.05rem;
        line-height: 1;
      }
      #fullscreenNavBtn .fullscreen-nav-icon-close {
        display: none;
      }
      #fullscreenNavBtn:focus {
        outline: 2px solid rgba(59, 130, 246, 0.45);
        outline-offset: 2px;
      }
      .navbar .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
      }
      .navbar .btn-group .btn {
        padding: 0.375rem 0.5rem;
      }
      #status {
        margin-left: 0.5rem;
      }
      @media (min-width: 992px) {
        #status {
          margin-left: 1rem;
        }
      }
      .navbar #status {
        font-size: 0.8rem;
      }
      .navbar #status .status-dot {
        width: 8px;
        height: 8px;
      }
      /* Compact CalTopo button */
      #caltopoBtn {
        padding: 0.5rem 0.5rem !important;
        gap: 0.15rem !important;
      }
      #caltopoBtn div {
        font-size: 0.75rem !important;
      }
      #caltopoBtn img {
        height: 14px !important;
      }
      /* Reduce spacing between all navbar items */
      .navbar .me-3 {
        margin-right: 0.5rem !important;
      }
      .navbar .me-2 {
        margin-right: 0.35rem !important;
      }
      /* Compact viewer count */
      .navbar .text-white {
        font-size: 0.85rem;
      }
      /* Force default cursor everywhere to prevent loading spinner cursor */
      body, #videoContainer, .placeholder {
        cursor: default !important;
      }
    </style>

    <!-- Eruda Mobile Console for debugging -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script> -->
  </head>
  <body>
    <!-- Hidden elements required by client.js -->
    <input type="hidden" id="roomIdInput" />
    <input type="hidden" id="roomIdInputMobile" />
    <button type="button" id="leaveBtn" style="display: none;" onclick="leaveRoom()"></button>
    
    <!-- Toast notification for room ID validation -->
    <div id="roomIdToast"></div>

    <!-- Toast notification for coordinates copied -->
    <div id="coordsCopiedToast"></div>

    <!-- Coordinate dialog modal -->
    <div id="coordinateDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="hideCoordinateDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        color: white;
      " onclick="event.stopPropagation()">
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <span style="font-weight: 500;">üåê Location:</span>
            <span id="dialogLocation" class="font-monospace" style="flex: 1;">Waiting for location data...</span>
            <button onclick="copyLocationCoordinates()" style="
              background-color: #465373;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 13px;
              white-space: nowrap;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-clipboard"></i> Copy
            </button>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüè† Altitude (home):</span>
            <span id="dialogAltHome" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüåä Altitude (sea level):</span>
            <span id="dialogAltSea" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüõ∞Ô∏è Altitude (GPS/Ellipsoid):</span>
            <span id="dialogAltEllipsoid" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">üß≠ Bearing:</span>
            <span id="dialogBearing" class="font-monospace">N/A</span>
          </div>
          <div>
            <span style="font-weight: 500;">üîã Battery:</span>
            <span id="dialogBattery" class="font-monospace">N/A</span>
          </div>
        </div>
        <button onclick="hideCoordinateDialog()" style="
          background-color: #465373;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          width: 100%;
        " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
          OK
        </button>
      </div>
    </div>

    <!-- Viewer info input dialog modal -->
    <div id="viewerInfoDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    ">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Join Stream</h5>
          <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #aaa;">Enter your information (optional)</p>
        </div>
        <form id="viewerInfoForm" style="padding: 20px;">
          <div style="margin-bottom: 15px;">
            <label for="viewerNameInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Name</label>
            <input type="text" id="viewerNameInput" placeholder="Your name"
              minlength="3"
              maxlength="100"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <div style="margin-bottom: 20px;">
            <label for="viewerEmailInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Email</label>
            <input type="email" id="viewerEmailInput" placeholder="your.email@example.com"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <button type="submit" id="confirmJoinBtn" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Join Stream
          </button>
        </form>
      </div>
    </div>

    <!-- Viewer list dialog modal -->
    <div id="viewerListDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="if(window.viewer) window.viewer.hideViewerListDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Viewers</h5>
        </div>
        <div id="viewerListContainer" style="
          flex: 1;
          overflow-y: auto;
        ">
          <!-- Populated by JavaScript -->
        </div>
        <div style="padding: 15px; border-top: 1px solid #444;">
          <button onclick="if(window.viewer) window.viewer.hideViewerListDialog()" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
      <div class="container-fluid d-flex align-items-center">
        <div class="d-flex align-items-center">
          <a class="navbar-brand d-flex align-items-center" href="https://www.eagleeyessearch.com/">
            <img src="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" alt="Eagle Eyes Logo" style="height: 40px; margin-right: 10px; border-radius: 6px;">
            <span>Eagle Eyes Viewer</span>
          </a>
          <button
            id="fullscreenNavBtn"
            type="button"
            class="btn btn-outline-secondary btn-sm ms-2"
            aria-pressed="false"
            title="Enter fullscreen mode"
          >
            <i class="bi bi-arrows-fullscreen fullscreen-nav-icon-expand" aria-hidden="true"></i>
            <i class="bi bi-fullscreen-exit fullscreen-nav-icon-close" aria-hidden="true"></i>
          </button>
        </div>

        <div
          id="status"
          class="status d-flex align-items-center text-white ms-auto me-2 ms-lg-3"
        >
          <span class="status-dot"></span>
          <span class="status-text small"></span>
        </div>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileControls"
          aria-controls="mobileControls"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse">
          <div class="d-flex align-items-center ms-auto">
            <button
              id="caltopoBtn"
              class="btn me-3"
              style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.75rem 0.75rem;"
              onclick="openCaltopoMap()"
              title="Open CalTopo Map"
            >
              <div style="font-size: 0.85rem; white-space: nowrap; line-height: 1.2;">View <span id="caltopoMapName"></span> on</div>
              <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto; margin-top: 2px;">
            </button>

            <div class="btn-group me-3" role="group">
              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="split-view"
                autocomplete="off"
                checked
              />
              <label
                class="btn btn-outline-secondary"
                for="split-view"
                title="Split View"
                ><i class="bi bi-layout-split"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="video-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="video-only"
                title="Video Only"
                ><i class="bi bi-camera-video"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="map-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="map-only"
                title="Map Only"
                ><i class="bi bi-map"></i
              ></label>
            </div>

            <div class="dropdown me-3">
              <button
                class="btn dropdown-toggle"
                type="button"
                id="historyDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="History"
                style="border-color: #b0b0b0; color: #b0b0b0;"
              >
                <i class="bi bi-clock-history"></i>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="historyDropdown"
                style="min-width: 300px;"
              >
                <li><h6 class="dropdown-header">History</h6></li>
                <li>
                  <div id="historyList" class="text-muted text-center px-3">
                    No recent streams
                  </div>
                </li>
              </ul>
            </div>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              title="Connect to a Stream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-box-arrow-in-right"></i>
            </button>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#shareModal"
              title="Share Livestream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-share"></i>
            </button>

            <button
              class="btn me-3 d-none d-lg-inline-block"
              type="button"
              id="menuBtnDesktop"
              data-bs-toggle="offcanvas"
              data-bs-target="#mobileControls"
              aria-controls="mobileControls"
              title="Menu"
              style="background-color: #6c757d; border-color: #6c757d; color: white;"
            >
              <i class="bi bi-list"></i>
            </button>

            <div class="text-white me-3" style="cursor: pointer;" onclick="if(window.viewer) window.viewer.showViewerListDialog()" title="View viewer list">
              <i class="bi bi-people"></i> <span id="viewerCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Connect to Stream Modal -->
    <div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="joinModalLabel">Connect to a Stream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Manual Stream ID Entry -->
            <div class="mb-4">
              <label for="modalRoomIdInput" class="form-label">Enter Stream ID</label>
              <div class="input-group">
                <input
                  type="text"
                  id="modalRoomIdInput"
                  class="form-control"
                  placeholder="Stream ID"
                  list="streamHistoryDatalist"
                />
                <datalist id="streamHistoryDatalist">
                  <!-- Populated dynamically by JavaScript -->
                </datalist>
                <button
                  class="btn"
                  type="button"
                  onclick="joinRoomFromModal()"
                  style="background-color: #314268; border-color: #314268; color: white;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect
                </button>
              </div>
            </div>

            <!-- Divider -->
            <div class="text-center text-muted mb-4">
              <hr class="my-2">
              <small>Or</small>
              <hr class="my-2">
            </div>

            <!-- QR Code Scanner -->
            <div class="text-center">
              <h6 class="mb-3">Scan a QR Code on this device</h6>
              <div id="qrScannerContainer" style="display: none; margin: 0 auto;">
                <div id="qrReader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                <div id="qrScanResult" class="mt-2 text-success"></div>
              </div>
              <button
                id="activateCameraBtn"
                class="btn btn-primary w-100"
                type="button"
                onclick="activateQRScanner()"
              >
                <i class="bi bi-camera"></i> Activate Camera
              </button>
              <button
                id="stopCameraBtn"
                class="btn btn-danger w-100 mt-2"
                type="button"
                onclick="stopQRScanner()"
                style="display: none;"
              >
                <i class="bi bi-camera-video-off"></i> Stop Camera
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="shareModalLabel">Share Livestream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p class="mb-3">Scan the QR code to view this livestream on another device</p>
            <div id="qrcode" class="d-flex justify-content-center mb-3" style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 0 auto;"></div>
            <button class="btn btn-primary w-100 mb-3" onclick="shareLivestream()">
              <i class="bi bi-share"></i> Share Livestream Link
            </button>
            <div class="text-muted small">
              <div class="mb-1">Or</div>
              <div class="mb-2">Share this Stream ID for others to enter in <i class="bi bi-box-arrow-in-right"></i> "Connect to a Stream":</div>
              <div class="font-monospace text-white fs-5" id="modalRoomId" onclick="copyRoomId()" style="cursor: pointer; user-select: all;" title="Click to copy">-</div>
              <div id="roomIdCopiedMessage" style="color: #28a745; font-size: 12px; margin-top: 8px; display: none;">Copied to clipboard</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification - Below share button -->
    <div class="toast-container position-fixed" id="toastContainer" style="display: none;">
      <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="width: auto; min-width: fit-content;">
        <div class="d-flex align-items-center justify-content-center">
          <div class="toast-body text-center" style="padding: 8px 16px;">
            <i class="bi bi-check-circle"></i> URL copied to clipboard
          </div>
          <button type="button" class="btn-close btn-close-white me-2" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- Mobile Offcanvas Sidebar -->
    <div
      class="offcanvas offcanvas-start bg-dark text-white"
      tabindex="-1"
      id="mobileControls"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Eagle Eyes Viewer</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#joinModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
            </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#shareModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-share"></i> Share Livestream
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <div class="text-white text-center" style="cursor: pointer;" onclick="if(window.viewer) window.viewer.showViewerListDialog()" title="View viewer list">
            <i class="bi bi-people"></i> <span id="viewerCountMobile">0</span> viewers
          </div>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="leaveBtnMobile"
            class="btn btn-dark"
            onclick="leaveRoom()"
            disabled
          >
            <i class="bi bi-stop-fill"></i> Disconnect
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="caltopoBtnMobile"
            class="btn"
            style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.75rem 0.75rem;"
            onclick="openCaltopoMap()"
            title="Open CalTopo Map"
          >
            <div style="font-size: 0.85rem; line-height: 1.2;">View <span id="caltopoMapNameMobile"></span> on</div>
            <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto; margin-top: 2px;">
          </button>
        </div>
        <hr />
        <h6>View Mode</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="split-view-mobile"
            autocomplete="off"
            checked
          />
          <label class="btn btn-outline-secondary" for="split-view-mobile"
            >Split</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="video-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="video-only-mobile"
            >Video</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="map-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="map-only-mobile"
            >Map</label
          >
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-secondary" onclick="centerOnDrone()">
            <i class="bi bi-bullseye"></i> Center on Drone
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn" onclick="toggleMyLocation()" id="myLocationBtn" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-geo-alt"></i> Show My Location
          </button>
        </div>
        <hr />
        <h6>History</h6>
        <div class="mb-3">
          <div id="historyListMobile" class="text-muted text-center">
            No recent streams
          </div>
        </div>
        <hr />
        <p>
          <strong>Stream:</strong> <span id="roomIdDisplay">Not connected</span>
        </p>
        <p>
          <strong>Connection:</strong>
          <span id="connectionStatus">Disconnected</span>
        </p>
        <strong>Coordinates:</strong>
        <p
          id="coordinateDisplay"
          class="bg-black px-2 py-1 rounded font-monospace small"
        >
          Waiting for location data...
        </p>
      </div>
    </div>

    <main id="main-content" class="row g-0" style="position: relative;">
      <!-- Shared disconnected overlay -->
      <div id="sharedDisconnectedOverlay" style="
        position: absolute;
        top: 52px;
        left: 10px;
        right: 10px;
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 1040;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: none;
        flex-direction: column;
        gap: 12px;
        max-width: calc(100vw - 20px);
        word-wrap: break-word;
      ">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-wifi-off" style="font-size: 16px;"></i>
          <span>Stream disconnected. Attempting to reconnect...</span>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button onclick="if(window.viewer) window.viewer.retryConnection()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 6px;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
            transition: background-color 0.2s ease;
          " title="Try to reconnect now" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Try Again
          </button>
          <button onclick="if(window.viewer) window.viewer.closeStream()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 6px;
            min-height: 44px;
            flex: 1;
            min-width: 120px;
            transition: background-color 0.2s ease;
          " title="Close this stream" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Close Stream
          </button>
        </div>
      </div>

      <!-- Connection failed overlay -->
      <div id="connectionFailedOverlay" style="
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1050;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: none;
        flex-direction: column;
        gap: 8px;
        max-width: 90%;
        width: auto;
      ">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-exclamation-triangle-fill" style="font-size: 16px;"></i>
          <span style="font-weight: 600;">Connection Failed</span>
          <button onclick="hideConnectionFailedMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin: 0 0 0 auto;
            line-height: 1;
            opacity: 0.9;
            display: flex;
            align-items: center;
          " title="Dismiss">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div style="font-size: 12px; font-weight: 400; line-height: 1.4; opacity: 0.95;">
          Streaming may not work on mobile data unless you're connected to the same hotspot. VPNs can also cause connection issues.
        </div>
      </div>

      <div id="video-panel" style="position: relative;">
        <div id="coordinateStripContainer" class="bg-dark text-white px-2 py-1 border-top border-secondary" style="flex: 0 0 auto; display: none; cursor: pointer;" onclick="showCoordinateDialog()">
          <div
            id="coordinateStrip"
            class="font-monospace small"
            style="display: flex; gap: 0.75rem; overflow: hidden; align-items: center;"
          >
            <span style="white-space: nowrap; flex-shrink: 0;">Waiting for location data...</span>
          </div>
        </div>
        <button
          id="videoMenuOverlayBtn"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileControls"
          aria-controls="mobileControls"
          aria-label="Open menu"
        >
          <i class="bi bi-list"></i>
        </button>
        <div id="videoContainer">
          <div class="placeholder">
            <i class="bi bi-camera-video-off" style="font-size: 5rem"></i>
            <p id="placeholderTitle">No video stream</p>
            <button
              id="placeholderConnectBtn"
              class="btn btn-lg"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              style="background-color: #314268; border-color: #314268; color: white; padding: 12px 24px; font-weight: 500; margin-top: 1rem;"
              onmouseover="this.style.backgroundColor='#3d5282'"
              onmouseout="this.style.backgroundColor='#314268'"
            >
              <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
            </button>
            <div id="connectingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="connectingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Connecting...</span>
                </div>
                Attempting to connect to <span id="connectingRoomIdInline" style="font-family: monospace; color: #ffc107;"></span>...
              </div>
              <div id="connectingTimeoutWarning" style="display: none; margin-top: 0.5rem; font-size: 0.9em; line-height: 1.4; color: #ffc107;">
                This is taking longer than expected. Check your internet connection.
              </div>
            </div>
            <div id="videoLoadingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="videoLoadingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Loading video...</span>
                </div>
                Found stream, attempting to load video...
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="connectedNoStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="noDataRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                You've connected to the stream but video is not loading. This is likely due to your internet connection type (some mobile data plans do not allow P2P streaming). Try switching to WiFi or share this stream with a device on a different connection.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  id="connectedNoStreamRetryBtn"
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="noStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="attemptedRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load this stream. The publisher may have stopped streaming, or the Stream ID may have been mistyped.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="roomFullDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="roomFullRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load stream: Streams are limited to 3 viewers to avoid network congestion. Ask other viewers to disconnect
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <a id="getHelpLink" href="https://www.eagleeyessearch.com/faq?query=livestreaming" target="_blank" style="
              margin-top: 1rem;
              display: inline-block;
              background-color: #465373;
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-question-circle"></i> Get Help
            </a>
          </div>
          <video id="remoteVideo" autoplay playsinline muted controls></video>
          <div class="play-overlay" id="playOverlay" onclick="resumeVideo()">
            <i class="bi bi-play-fill"></i>
        </div>
      </div>
      </div>
      <div id="map-panel" style="position: relative;">
        <div id="map"></div>
      </div>
    </main>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Esri Leaflet -->
    <script src="https://unpkg.com/esri-leaflet"></script>
    <script src="{{ '/js/livestream/map.js' | relative_url }}"></script>
    <script src="{{ '/js/livestream/client.js' | relative_url }}"></script>
    <script>
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('Service Worker registered:', registration))
            .catch(error => console.log('Service Worker registration failed:', error));
        });
      }
      // Video play/pause overlay functionality
      function setupVideoControls() {
        const video = document.getElementById('remoteVideo');
        const playOverlay = document.getElementById('playOverlay');
        
        if (video && playOverlay) {
          // Show/hide play overlay based on video state
          video.addEventListener('pause', () => {
            if (video.style.display !== 'none') {
              playOverlay.style.display = 'flex';
            }
          });
          
          video.addEventListener('play', () => {
            playOverlay.style.display = 'none';
          });
          
          // Hide overlay when video ends
          video.addEventListener('ended', () => {
            playOverlay.style.display = 'none';
          });
        }
      }
      
      function resumeVideo() {
        const video = document.getElementById('remoteVideo');
        if (video && video.paused) {
          video.play();
        }
      }
      
      // Picture-in-Picture functionality
      function setupPictureInPicture() {
        const video = document.getElementById('remoteVideo');
        
        if (video && 'pictureInPictureEnabled' in document) {
          // Enter PiP when page loses visibility (user switches tabs/apps)
          document.addEventListener('visibilitychange', async () => {
            if (document.hidden && !video.paused) {
              await activatePictureInPicture();
            }
          });
          
          // Optional: Exit PiP when page becomes visible again and not in map-only mode
          document.addEventListener('visibilitychange', async () => {
            const mapPanel = document.getElementById('map-panel');
            const isMapFullScreen = mapPanel && mapPanel.classList.contains('full-view');
            
            if (!document.hidden && document.pictureInPictureElement && !isMapFullScreen) {
              try {
                await document.exitPictureInPicture();
                console.log('PiP exited due to page visibility change');
              } catch (error) {
                console.log('Exit PiP failed:', error);
              }
            }
          });
        }
      }
      
      // Function to manually trigger PiP
      async function activatePictureInPicture() {
        const video = document.getElementById('remoteVideo');
        
        if (!video) {
          console.warn('Video element not found');
          return false;
        }
        
        if (!('pictureInPictureEnabled' in document)) {
            console.warn('Picture-in-Picture not supported');
          return false;
        }
        
        if (video.paused) {
          console.log('Video not playing, cannot activate PiP');
          return false;
        }
        
        // Check if already in PiP mode
        if (video === document.pictureInPictureElement) {
          console.log('Already in PiP mode');
          return true;
        }

        const videoPanel = document.getElementById('video-panel');
        const restoreCallbacks = [];

        if (videoPanel) {
          const previousClassName = videoPanel.className;
          const hadDNone = videoPanel.classList.contains('d-none');
          const previousStyles = {
            display: videoPanel.style.display,
            position: videoPanel.style.position,
            width: videoPanel.style.width,
            height: videoPanel.style.height,
            opacity: videoPanel.style.opacity,
            pointerEvents: videoPanel.style.pointerEvents,
            zIndex: videoPanel.style.zIndex
          };

          if (hadDNone) {
            videoPanel.classList.remove('d-none');
          }

          videoPanel.style.setProperty('display', 'block', 'important');
          videoPanel.style.position = 'fixed';
          videoPanel.style.width = '1px';
          videoPanel.style.height = '1px';
          videoPanel.style.opacity = '0';
          videoPanel.style.pointerEvents = 'none';
          videoPanel.style.zIndex = '-1';

          restoreCallbacks.push(() => {
            videoPanel.style.display = previousStyles.display;
            videoPanel.style.position = previousStyles.position;
            videoPanel.style.width = previousStyles.width;
            videoPanel.style.height = previousStyles.height;
            videoPanel.style.opacity = previousStyles.opacity;
            videoPanel.style.pointerEvents = previousStyles.pointerEvents;
            videoPanel.style.zIndex = previousStyles.zIndex;
            videoPanel.className = previousClassName;
          });
        }

        const previousVideoStyles = {
          display: video.style.display,
          width: video.style.width,
          height: video.style.height,
          opacity: video.style.opacity,
          position: video.style.position,
          pointerEvents: video.style.pointerEvents,
          zIndex: video.style.zIndex
        };

        const videoComputed = window.getComputedStyle(video);
        if (videoComputed.display === 'none' || videoComputed.visibility === 'hidden') {
          video.style.setProperty('display', 'block', 'important');
          video.style.width = '1px';
          video.style.height = '1px';
          video.style.opacity = '0';
          video.style.position = 'fixed';
          video.style.pointerEvents = 'none';
          video.style.zIndex = '-1';

          restoreCallbacks.push(() => {
            video.style.display = previousVideoStyles.display;
            video.style.width = previousVideoStyles.width;
            video.style.height = previousVideoStyles.height;
            video.style.opacity = previousVideoStyles.opacity;
            video.style.position = previousVideoStyles.position;
            video.style.pointerEvents = previousVideoStyles.pointerEvents;
            video.style.zIndex = previousVideoStyles.zIndex;
          });
        }
        
        try {
          await video.requestPictureInPicture();
          console.log('PiP activated manually');
          return true;
        } catch (error) {
          console.error('Failed to activate PiP:', error);
          return false;
        } finally {
          while (restoreCallbacks.length) {
            const restore = restoreCallbacks.pop();
            if (typeof restore === 'function') {
              restore();
            }
          }
        }
      }
      
      // Function to exit PiP
      async function deactivatePictureInPicture() {
        if (document.pictureInPictureElement) {
          try {
            await document.exitPictureInPicture();
            console.log('PiP deactivated');
            return true;
          } catch (error) {
            console.error('Failed to exit PiP:', error);
            return false;
          }
        }
        return false;
      }
      
      document.addEventListener("DOMContentLoaded", () => {
        const videoPanel = document.getElementById("video-panel");
        const mapPanel = document.getElementById("map-panel");
        
        // Initialize video controls and PiP
        setupVideoControls();
        setupPictureInPicture();

        // Function to hide coordinate segments that don't fit completely
        function updateCoordinateSegmentVisibility() {
          const coordStrip = document.getElementById("coordinateStrip");
          if (!coordStrip) return;

          const segments = Array.from(coordStrip.children);
          if (segments.length === 0) return;

          // Show all segments first to measure
          segments.forEach(seg => seg.style.display = '');

          const containerWidth = coordStrip.offsetWidth;
          let totalWidth = 0;
          const gap = 12; // 0.75rem in pixels (approximate)

          // Hide segments from right to left if they don't fit
          for (let i = 0; i < segments.length; i++) {
            const segmentWidth = segments[i].offsetWidth;
            const widthWithGap = totalWidth + segmentWidth + (i > 0 ? gap : 0);

            if (widthWithGap > containerWidth) {
              // This segment and all following don't fit
              for (let j = i; j < segments.length; j++) {
                segments[j].style.display = 'none';
              }
              break;
            }
            totalWidth = widthWithGap;
          }
        }

        // Create ResizeObserver for coordinate strip
        const coordStripContainer = document.getElementById("coordinateStripContainer");
        if (coordStripContainer) {
          const resizeObserver = new ResizeObserver(() => {
            updateCoordinateSegmentVisibility();
          });
          resizeObserver.observe(coordStripContainer);

          // Also update when content changes (via MutationObserver)
          const mutationObserver = new MutationObserver(() => {
            updateCoordinateSegmentVisibility();
          });
          const coordStrip = document.getElementById("coordinateStrip");
          if (coordStrip) {
            mutationObserver.observe(coordStrip, { childList: true, subtree: true });
          }
        }

        const desktopViewRadios = document.querySelectorAll('input[name="view-mode"]');
        const mobileViewRadios = document.querySelectorAll('input[name="view-mode-mobile"]');
        let currentViewMode = 'split';

        function syncViewModeRadios(mode) {
          const desktopIdMap = {
            split: 'split-view',
            video: 'video-only',
            map: 'map-only'
          };
          const mobileIdMap = {
            split: 'split-view-mobile',
            video: 'video-only-mobile',
            map: 'map-only-mobile'
          };
          const desktopTarget = desktopIdMap[mode];
          desktopViewRadios.forEach((radio) => {
            radio.checked = radio.id === desktopTarget;
          });
          const mobileTarget = mobileIdMap[mode];
          mobileViewRadios.forEach((radio) => {
            radio.checked = radio.id === mobileTarget;
          });
        }

        function setViewMode(mode) {
          const coordStrip = document.getElementById("coordinateStripContainer");

          if (mode === "video") {
            videoPanel.className = "full-view";
            videoPanel.style.flex = "1 1 100%";
            mapPanel.className = "d-none";
            mapPanel.style.flex = "";
            // Remove the force-show flag when switching away from map mode
            mapPanel.removeAttribute('data-force-show');
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
            // Reposition disconnected overlay for video mode
            repositionDisconnectedOverlay();
            // Exit PiP when returning to video or split view
            deactivatePictureInPicture();
          } else if (mode === "map") {
            videoPanel.className = "d-none";
            videoPanel.style.flex = "";
            mapPanel.className = "full-view";
            mapPanel.style.flex = "1 1 100%";
            // Remove any hiding classes
            mapPanel.classList.remove('d-none');
            // Set a flag to prevent JavaScript client from hiding the map
            mapPanel.setAttribute('data-force-show', 'true');
            // Force show map panel even when no drone is connected with !important
            mapPanel.style.setProperty('display', 'flex', 'important');
            // Ensure map container is visible
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
              mapContainer.style.display = 'block';
            }
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-none";
            
            // Center map - zoom to drone if connected, otherwise user location, otherwise North America
            if (window.droneMap && window.droneMap.map) {
              setTimeout(() => {
                // Check if a drone is connected (has current location)
                if (window.droneMap.currentLocation && Array.isArray(window.droneMap.currentLocation)) {
                  // Zoom to connected drone location
                  window.droneMap.map.setView(window.droneMap.currentLocation, 15);
                  console.log('Zooming to connected drone location:', window.droneMap.currentLocation);
                } else if (window.droneMap.isMyLocationVisible && window.droneMap.myLocationMarker) {
                  // No drone, but user location is available - zoom to user location
                  const userLatlng = window.droneMap.myLocationMarker.getLatLng();
                  window.droneMap.map.invalidateSize();
                  window.droneMap.map.setView(userLatlng, 15, { animate: false });
                  // Force another invalidate after setting view
                  setTimeout(() => {
                    window.droneMap.map.invalidateSize();
                  }, 50);
                  console.log('Zooming to user location in map-only mode:', userLatlng);
                } else {
                  // No drone or user location - show North America scale
                  window.droneMap.map.setView([45.0, -100.0], 3);
                  console.log('No drone or user location - showing North America scale');
                }
                // Invalidate size to ensure map tiles render properly
                window.droneMap.map.invalidateSize();
                // Check if map is visible and show beta disclaimer if needed
                if (window.droneMap.checkMapVisibilityAndShowDisclaimer) {
                  window.droneMap.checkMapVisibilityAndShowDisclaimer();
                }
              }, 200);
            } else if (window.droneMap && typeof window.droneMap.resize === 'function') {
              // If map exists but tiles aren't loading, try resize
              setTimeout(() => {
                window.droneMap.resize();
                // Check if map is visible and show beta disclaimer if needed
                if (window.droneMap.checkMapVisibilityAndShowDisclaimer) {
                  window.droneMap.checkMapVisibilityAndShowDisclaimer();
                }
              }, 100);
            }
            // Reposition disconnected overlay for map mode
            repositionDisconnectedOverlay();
            
            // Activate Picture-in-Picture when switching to full-screen map
            // Wait a bit for the UI transition to complete
            setTimeout(() => {
              activatePictureInPicture();
            }, 300);
          } else {
            // split - let CSS aspect ratio media queries handle layout
            videoPanel.className = "";
            videoPanel.style.flex = "";
            mapPanel.className = "";
            mapPanel.style.flex = "";
            // Remove the force-show flag when switching away from map mode
            mapPanel.removeAttribute('data-force-show');
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
            // Reposition disconnected overlay for split mode
            repositionDisconnectedOverlay();
            // Exit PiP when returning to split view
            deactivatePictureInPicture();
            
            // Center map - zoom to drone if connected, otherwise North America
            if (window.droneMap && window.droneMap.map) {
              setTimeout(() => {
                // Check if a drone is connected (has current location)
                if (window.droneMap.currentLocation && Array.isArray(window.droneMap.currentLocation)) {
                  // Zoom to connected drone location
                  window.droneMap.map.setView(window.droneMap.currentLocation, 15);
                  console.log('Zooming to connected drone location (split mode):', window.droneMap.currentLocation);
                } else {
                  // No drone connected - show North America scale
                  window.droneMap.map.setView([45.0, -100.0], 3);
                  console.log('No drone connected - showing North America scale (split mode)');
                }
                // Invalidate size to ensure map tiles render properly
                window.droneMap.map.invalidateSize();
              }, 100);
            }
          }
          if (window.droneMap) {
            setTimeout(() => window.droneMap.resize(), 150);
          }
          currentViewMode = mode;
          syncViewModeRadios(mode);
        }

        desktopViewRadios.forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only", "")
                .replace("-view", "");
              setViewMode(mode);
              // Sync mobile radios with correct ID mapping
              const mobileId = e.target.id + "-mobile";
              const mobileRadio = document.getElementById(mobileId);
              if (mobileRadio) {
                mobileRadio.checked = true;
              }
            });
          });
        mobileViewRadios.forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only-mobile", "")
                .replace("-view-mobile", "");
              setViewMode(mode);
              // Sync desktop radios with correct ID mapping
              const desktopId = e.target.id.replace("-mobile", "");
              const desktopRadio = document.getElementById(desktopId);
              if (desktopRadio) {
                desktopRadio.checked = true;
              }
            });
          });

        syncViewModeRadios(currentViewMode);

        const prefersCoarsePointer = window.matchMedia('(pointer: coarse)');
        const isTouchDevice = prefersCoarsePointer.matches || 'ontouchstart' in window;
        if (isTouchDevice && videoPanel) {
          let swipeStartX = null;
          let swipeStartY = null;
          const SWIPE_THRESHOLD = 70;

          videoPanel.addEventListener('touchstart', (event) => {
            if (currentViewMode !== 'video' || event.touches.length !== 1) {
              swipeStartX = null;
              swipeStartY = null;
              return;
            }
            const touch = event.touches[0];
            swipeStartX = touch.clientX;
            swipeStartY = touch.clientY;
          }, { passive: true });

          videoPanel.addEventListener('touchend', (event) => {
            if (swipeStartX === null || swipeStartY === null || event.changedTouches.length !== 1) {
              swipeStartX = null;
              swipeStartY = null;
              return;
            }
            const touch = event.changedTouches[0];
            const deltaX = touch.clientX - swipeStartX;
            const deltaY = touch.clientY - swipeStartY;
            swipeStartX = null;
            swipeStartY = null;

            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > SWIPE_THRESHOLD) {
              if (deltaX > 0) {
                setViewMode('map');
              } else {
                setViewMode('split');
              }
            }
          }, { passive: true });
        }
      });

      function centerOnDrone() {
        if (window.droneMap) window.droneMap.centerOnDrone();
      }

      function toggleMyLocation() {
        console.log('toggleMyLocation called, window.droneMap:', window.droneMap);
        
        if (window.droneMap && typeof window.droneMap.toggleMyLocation === 'function') {
          console.log('Calling toggleMyLocation on droneMap');
          window.droneMap.toggleMyLocation();
        } else {
          console.error('DroneMap not ready or toggleMyLocation method not available');
          console.log('window.droneMap:', window.droneMap);
          console.log('typeof window.droneMap.toggleMyLocation:', typeof window.droneMap?.toggleMyLocation);
          
          // Try to initialize the map if it's not ready
          if (!window.droneMap) {
            console.log('Attempting to initialize DroneMap...');
            setTimeout(() => {
              if (window.droneMap && typeof window.droneMap.toggleMyLocation === 'function') {
                console.log('DroneMap now available, calling toggleMyLocation');
                window.droneMap.toggleMyLocation();
              } else {
                console.error('DroneMap still not available after retry');
                alert('Map is not ready yet. Please wait a moment and try again.');
              }
            }, 500);
          } else {
            alert('Map is not ready yet. Please wait a moment and try again.');
          }
        }
      }

      function openCaltopoMap() {
        if (window.droneMap && window.droneMap.caltopoInfo) {
          const mapId = window.droneMap.caltopoInfo.map_id;
          if (mapId) {
            window.open(`https://caltopo.com/m/${mapId}`, '_blank');
          }
        }
      }

      function hideDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function showDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          // Move overlay to the appropriate panel based on current view mode
          repositionDisconnectedOverlay();
          overlay.style.display = 'flex';
        }
      }
      
      function repositionDisconnectedOverlay() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        const videoPanel = document.getElementById('video-panel');
        const mapPanel = document.getElementById('map-panel');
        
        if (!overlay || !videoPanel || !mapPanel) return;
        
        // Check which panel is currently visible
        const isMapFullScreen = mapPanel.classList.contains('full-view');
        const isVideoFullScreen = videoPanel.classList.contains('full-view');
        
        if (isMapFullScreen) {
          // Full-screen map mode - move overlay to map panel
          if (overlay.parentElement !== mapPanel) {
            mapPanel.insertBefore(overlay, mapPanel.firstChild);
          }
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.right = '0';
          overlay.style.borderRadius = '0 0 8px 8px';
        } else {
          // Video visible (either full-screen or split) - move overlay to video panel
          if (overlay.parentElement !== videoPanel) {
            videoPanel.insertBefore(overlay, videoPanel.firstChild);
          }
          overlay.style.top = '52px';
          overlay.style.left = '0';
          overlay.style.right = '0';
          overlay.style.borderRadius = '0 0 8px 8px';
        }
      }

      function hideConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function hideNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');

        if (placeholderTitle) placeholderTitle.style.display = 'block';
        if (placeholderConnectBtn) placeholderConnectBtn.style.display = 'inline-block';
        if (noStreamDetails) noStreamDetails.style.display = 'none';

        // Show map panel, coordinate strip, and restore normal layout when hiding notification
        const mapPanel = document.getElementById('map-panel');
        const videoPanel = document.getElementById('video-panel');
        const coordStripContainer = document.getElementById('coordinateStripContainer');
        if (mapPanel) mapPanel.style.display = 'block';
        if (videoPanel) videoPanel.classList.remove('col-12');
        if (coordStripContainer) coordStripContainer.style.display = 'flex';
      }

      function showNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');
        const attemptedRoomId = document.getElementById('attemptedRoomId');

        // Get the current room ID from the viewer
        const roomId = window.viewer ? window.viewer.currentRoomId : null;

        if (roomId && noStreamDetails && placeholderConnectBtn && attemptedRoomId) {
          // Hide the title and connect button, show the no stream details
          if (placeholderTitle) placeholderTitle.style.display = 'none';
          placeholderConnectBtn.style.display = 'none';
          attemptedRoomId.textContent = roomId;
          noStreamDetails.style.display = 'block';

          // Hide map panel, coordinate strip, and expand video panel when unable to load stream
          const mapPanel = document.getElementById('map-panel');
          const videoPanel = document.getElementById('video-panel');
          const coordStripContainer = document.getElementById('coordinateStripContainer');
          if (mapPanel) mapPanel.style.display = 'none';
          if (videoPanel) videoPanel.classList.add('col-12');
          if (coordStripContainer) coordStripContainer.style.display = 'none';
        }
      }

      function showConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function showCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');

        // Get current location data from the viewer
        if (window.viewer && window.viewer.currentLocation) {
          const loc = window.viewer.currentLocation;

          // Format with N/S/E/W for display
          const latDir = loc.latitude >= 0 ? 'N' : 'S';
          const lonDir = loc.longitude >= 0 ? 'E' : 'W';
          const latFormatted = `${Math.abs(loc.latitude).toFixed(5)}¬∞${latDir}`;
          const lonFormatted = `${Math.abs(loc.longitude).toFixed(5)}¬∞${lonDir}`;

          document.getElementById('dialogLocation').textContent = `${latFormatted}, ${lonFormatted}`;
          // Store plain coordinates for copying
          document.getElementById('dialogLocation').setAttribute('data-plain', `${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`);

          document.getElementById('dialogAltHome').textContent =
            loc.altitude_ahl != null ? `${loc.altitude_ahl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltSea').textContent =
            loc.altitude_asl != null ? `${loc.altitude_asl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltEllipsoid').textContent =
            loc.altitude_ellipsoid != null ? `${loc.altitude_ellipsoid.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogBearing').textContent =
            `${loc.bearing.toFixed(1)}¬∞ from True North`;

          document.getElementById('dialogBattery').textContent =
            loc.battery_percent != null ? `${loc.battery_percent}%` : 'N/A';
        }

        if (dialog) {
          dialog.style.display = 'flex';
        }
      }

      function hideCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');
        if (dialog) {
          dialog.style.display = 'none';
        }
      }

      function copyLocationCoordinates() {
        const locationElement = document.getElementById('dialogLocation');
        const plainText = locationElement.getAttribute('data-plain');
        navigator.clipboard.writeText(plainText).then(() => {
          const toast = document.getElementById('coordsCopiedToast');
          if (toast) {
            toast.textContent = `Copied '${plainText}' to clipboard`;
            toast.style.display = 'block';
            setTimeout(() => {
              toast.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy coordinates:', err);
        });
      }

      // Share functionality
      // Generate QR code when modal is shown
      const shareModal = document.getElementById('shareModal');
      shareModal.addEventListener('show.bs.modal', function () {
        // Always regenerate QR code to ensure it reflects current URL
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = ''; // Clear any existing QR code
        const currentUrl = window.location.href;

        // Only generate if there's a stream in the URL
        if (currentUrl.includes('?stream=') || currentUrl.includes('&stream=') ||
            currentUrl.includes('?room=') || currentUrl.includes('&room=')) {
          console.log('Generating QR code for URL:', currentUrl);
          new QRCode(qrcodeContainer, {
            text: currentUrl,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          console.log('QR code generated successfully');
        } else {
          // Show message if no stream is active
          console.log('No stream in URL, cannot generate QR code');
          qrcodeContainer.innerHTML = '<div style="padding: 20px; color: #6c757d;">Connect to a stream first to generate QR code</div>';
        }
        
        // Update Stream ID display in share modal
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomId = document.getElementById('modalRoomId');
        if (roomIdInput && modalRoomId) {
          let currentRoomId = roomIdInput.value.trim();

          // If roomIdInput is empty, try to get it from URL
          if (!currentRoomId) {
            const urlParams = new URLSearchParams(window.location.search);
            // Try 'stream' first, then 'room' for backwards compatibility
            currentRoomId = urlParams.get('stream') || urlParams.get('room') || '';
          }

          // If it's a URL, extract just the stream ID
          if (currentRoomId.includes('http://') || currentRoomId.includes('https://') || currentRoomId.includes('?')) {
            try {
              const url = new URL(currentRoomId);
              // Try 'stream' first, then 'room' for backwards compatibility
              currentRoomId = url.searchParams.get('stream') || url.searchParams.get('room') || '';
            } catch (e) {
              // Try to extract from query string manually
              const match = currentRoomId.match(/[?&](stream|room)=([^&]+)/);
              if (match) {
                currentRoomId = match[2];
              }
            }
          }

          modalRoomId.textContent = currentRoomId || '-';
        }
      });

      function joinRoomFromModal() {
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomIdInputMobile = document.getElementById('roomIdInputMobile');
        const roomId = modalRoomIdInput.value.trim();

        if (!roomId) {
          alert("Please enter a stream ID");
          return;
        }
        
        // Update both hidden room ID inputs with the modal value
        if (roomIdInput) {
          roomIdInput.value = roomId;
          console.log('Updated hidden roomIdInput with:', roomId);
        } else {
          console.error('roomIdInput element not found!');
        }
        
        if (roomIdInputMobile) {
          roomIdInputMobile.value = roomId;
          console.log('Updated hidden roomIdInputMobile with:', roomId);
        }
        
        // Close the modal
        const joinModalElement = document.getElementById('joinModal');
        const joinModalInstance = bootstrap.Modal.getInstance(joinModalElement);
        if (joinModalInstance) {
          joinModalInstance.hide();
        } else {
          // If no instance exists yet, create one and hide it
          const modal = new bootstrap.Modal(joinModalElement);
          modal.hide();
        }
        
        // Call the main joinRoom function
        console.log('Calling joinRoom()...');
        if (window.joinRoom) {
          joinRoom();
        } else {
          console.error('joinRoom function not found!');
        }
      }

      function copyRoomId() {
        const roomIdElement = document.getElementById('modalRoomId');
        const roomId = roomIdElement.textContent.trim();
        
        // Don't copy if it's just a dash (no room ID)
        if (roomId === '-') {
          return;
        }
        
        navigator.clipboard.writeText(roomId).then(() => {
          // Show the "Copied to clipboard" message
          const copiedMessage = document.getElementById('roomIdCopiedMessage');
          if (copiedMessage) {
            copiedMessage.style.display = 'block';
            
            // Hide the message after 2 seconds
            setTimeout(() => {
              copiedMessage.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy room ID:', err);
        });
      }

      async function shareLivestream() {
        const currentUrl = window.location.href;
        
        // Check if device is mobile and Web Share API is available
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile && navigator.share) {
          try {
            await navigator.share({
              title: 'Eagle Eyes Livestream',
              text: 'Join this Eagle Eyes livestream',
              url: currentUrl
            });
          } catch (err) {
            // User cancelled share or error occurred
            if (err.name !== 'AbortError') {
              console.error('Error sharing:', err);
              copyToClipboard(currentUrl);
            }
          }
        } else {
          // Desktop or fallback: always copy to clipboard
          copyToClipboard(currentUrl);
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          // Position toast below the share button
          const shareButton = document.querySelector('#shareModal .btn-primary');
          const toastContainer = document.getElementById('toastContainer');
          const modalDialog = document.querySelector('#shareModal .modal-dialog');
          
          if (shareButton && toastContainer && modalDialog) {
            const buttonRect = shareButton.getBoundingClientRect();
            const modalRect = modalDialog.getBoundingClientRect();
            
            // Position toast below the button, aligned horizontally with modal
            toastContainer.style.left = `${modalRect.left}px`;
            toastContainer.style.top = `${buttonRect.bottom + 10}px`;
            toastContainer.style.display = 'block';
          }
          
          // Show toast notification
          const toastEl = document.getElementById('copyToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        }).catch(err => {
          console.error('Failed to copy:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            
            // Position toast below the share button (fallback)
            const shareButton = document.querySelector('#shareModal .btn-primary');
            const toastContainer = document.getElementById('toastContainer');
            const modalDialog = document.querySelector('#shareModal .modal-dialog');
            
            if (shareButton && toastContainer && modalDialog) {
              const buttonRect = shareButton.getBoundingClientRect();
              const modalRect = modalDialog.getBoundingClientRect();
              toastContainer.style.left = `${modalRect.left}px`;
              toastContainer.style.top = `${buttonRect.bottom + 10}px`;
              toastContainer.style.display = 'block';
            }
            
            const toastEl = document.getElementById('copyToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
          } catch (err) {
            console.error('Fallback copy failed:', err);
          }
          document.body.removeChild(textArea);
        });
      }

      // Handle Enter key in join modal input
      document.getElementById('modalRoomIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          joinRoomFromModal();
        }
      });

      // Add room ID validation to modal input (same as navbar inputs)
      document.getElementById('modalRoomIdInput').addEventListener('input', function(e) {
        // Use the same validation function as the navbar inputs
        if (window.viewer && window.viewer.validateAndFormatRoomId) {
          const validated = window.viewer.validateAndFormatRoomId(e.target.value);
          e.target.value = validated;
          
          // Also sync with hidden navbar inputs
          const roomIdInput = document.getElementById('roomIdInput');
          const roomIdInputMobile = document.getElementById('roomIdInputMobile');
          if (roomIdInput) roomIdInput.value = validated;
          if (roomIdInputMobile) roomIdInputMobile.value = validated;
        }
      });

      // Pre-populate modal with current stream ID when opened
      document.getElementById('joinModal').addEventListener('show.bs.modal', function () {
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        if (roomIdInput && modalRoomIdInput) {
          const currentRoomId = roomIdInput.value.trim();
          if (currentRoomId) {
            modalRoomIdInput.value = currentRoomId;
            modalRoomIdInput.placeholder = 'Enter a different Stream ID or use current';
          } else {
            modalRoomIdInput.placeholder = 'Stream ID';
          }
        }
      });

      // QR Code Scanner functionality
      let html5QrCode = null;
      let qrScannerActive = false;

      async function activateQRScanner() {
        const qrScannerContainer = document.getElementById('qrScannerContainer');
        const activateBtn = document.getElementById('activateCameraBtn');
        const stopBtn = document.getElementById('stopCameraBtn');
        const qrScanResult = document.getElementById('qrScanResult');

        try {
          qrScannerContainer.style.display = 'block';
          activateBtn.style.display = 'none';
          stopBtn.style.display = 'block';
          qrScanResult.textContent = 'Point your camera at a QR code...';

          html5QrCode = new Html5Qrcode("qrReader");
          
          const config = { 
            fps: 30, 
            qrbox: { width: 200, height: 200 },
            aspectRatio: 1.0,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          };
          
          await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
              // QR code successfully scanned
              console.log('QR Code scanned! Raw text:', decodedText);
              qrScanResult.textContent = 'QR Code detected! Joining livestream...';
              
              // Extract stream ID from URL if it's a full URL, or use as-is if it's just an ID
              let roomId = decodedText;
              try {
                const url = new URL(decodedText);
                // Try 'stream' first, then 'room' for backwards compatibility
                const urlRoomId = url.searchParams.get('stream') || url.searchParams.get('room');
                if (urlRoomId) {
                  roomId = urlRoomId;
                  console.log('Extracted stream ID from URL:', roomId);
                } else {
                  console.log('No stream parameter in URL, using full URL as stream ID');
                }
              } catch (e) {
                // Not a URL, use as-is
                console.log('Not a valid URL, using raw text as stream ID:', roomId);
              }
              
              // Keep room ID in uppercase (don't normalize to lowercase)
              roomId = roomId.toUpperCase();
              console.log('Final room ID (uppercase):', roomId);
              
              // Stop scanner and join
              stopQRScanner();
              
              // Close modal
              const joinModal = bootstrap.Modal.getInstance(document.getElementById('joinModal'));
              if (joinModal) {
                joinModal.hide();
              }
              
              // Update the hidden roomIdInput field
              const hiddenRoomIdInput = document.getElementById('roomIdInput');
              const hiddenRoomIdInputMobile = document.getElementById('roomIdInputMobile');
              if (hiddenRoomIdInput) {
                hiddenRoomIdInput.value = roomId;
              }
              if (hiddenRoomIdInputMobile) {
                hiddenRoomIdInputMobile.value = roomId;
              }
              
              // Call the joinRoom function
              if (window.joinRoom) {
                joinRoom();
              }
            },
            (errorMessage) => {
              // QR code parsing error (usually means no QR code in view)
              // This is called frequently, so we don't show errors here
              // Only log if it's not a common "No QR code found" message
              if (!errorMessage.includes('No QR code found') && !errorMessage.includes('NotFoundException')) {
                console.log('QR scan error:', errorMessage);
              }
            }
          );
          
          qrScannerActive = true;
        } catch (err) {
          console.error('Error starting QR scanner:', err);
          qrScanResult.textContent = 'Error: Could not access camera. Please check permissions.';
          qrScanResult.classList.remove('text-success');
          qrScanResult.classList.add('text-danger');
          activateBtn.style.display = 'block';
          stopBtn.style.display = 'none';
          qrScannerContainer.style.display = 'none';
        }
      }

      function stopQRScanner() {
        if (html5QrCode && qrScannerActive) {
          html5QrCode.stop().then(() => {
            const qrScannerContainer = document.getElementById('qrScannerContainer');
            const activateBtn = document.getElementById('activateCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const qrScanResult = document.getElementById('qrScanResult');
            
            qrScannerContainer.style.display = 'none';
            activateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            qrScanResult.textContent = '';
            qrScanResult.classList.remove('text-danger');
            qrScanResult.classList.add('text-success');
            
            qrScannerActive = false;
          }).catch(err => {
            console.error('Error stopping QR scanner:', err);
          });
        }
      }

      // Clean up QR scanner when modal is closed
      document.getElementById('joinModal').addEventListener('hidden.bs.modal', function () {
        if (qrScannerActive) {
          stopQRScanner();
        }
      });

    </script>
  </body>
</html>
