---
permalink: /livestream/
---
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link rel="icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" type="image/png">
    <link rel="shortcut icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" type="image/png">

    <!-- PWA Configuration -->
    <link rel="manifest" href="{{ '/manifest.json' | relative_url }}">
    <meta name="theme-color" content="#314268">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Eagle Eyes Livestream">

    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Eagle Eyes Livestream">
    <link rel="apple-touch-icon" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    <link rel="apple-touch-icon" sizes="167x167" href="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">

    <!-- Open Graph / Facebook -->
    <meta property="og:image" content="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}">
    
    <title>Eagle Eyes Livestream Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      #main-content {
        flex: 1;
        display: flex;
        min-height: 0;
      }
      /* Portrait/narrow (aspect ratio < 1:1): video top, map bottom */
      @media (max-aspect-ratio: 1/1) {
        #main-content {
          flex-direction: column;
        }
      }
      /* Landscape/wide (aspect ratio >= 1:1): video left, map right */
      @media (min-aspect-ratio: 1/1) {
        #main-content {
          flex-direction: row;
        }
      }
      #video-panel,
      #map-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #000;
        min-height: 0;
      }
      /* Landscape: video gets 2/3 width, map gets 1/3 width (fixed) */
      @media (min-aspect-ratio: 1/1) {
        #video-panel {
          flex: 0 0 66.666667%;
        }
        #map-panel {
          flex: 0 0 33.333333%;
        }
      }
      /* Portrait: flexible sizing with constraints to optimize space */
      @media (max-aspect-ratio: 1/1) {
        #video-panel {
          flex: 1 1 auto;
          min-height: 40%;
          max-height: 70%;
        }
        #map-panel {
          flex: 1 1 auto;
          min-height: 30%;
        }
      }
      /* Full size for single-view modes */
      #video-panel.full-view,
      #map-panel.full-view {
        flex: 1 1 100%;
      }
      #map-panel {
        background-color: #181818;
      }
      #videoContainer,
      #map {
        width: 100%;
        flex: 1;
        min-height: 0;
      }
      #videoContainer {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      /* In portrait mode, align video to top instead of center */
      @media (max-aspect-ratio: 1/1) {
        #videoContainer {
          align-items: flex-start;
        }
      }
      #remoteVideo {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
        z-index: 2;
      }
      /* Play button overlay when video is paused */
      .play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80px;
        height: 80px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 3;
        transition: all 0.3s ease;
      }
      .play-overlay:hover {
        background-color: rgba(0, 0, 0, 0.8);
        transform: translate(-50%, -50%) scale(1.1);
      }
      .play-overlay i {
        color: white;
        font-size: 32px;
        margin-left: 4px; /* Compensate for play icon visual centering */
      }
      /* Remove shadow/gradient overlay from video controls */
      #remoteVideo::-webkit-media-controls-panel {
        background-image: none !important;
        background: transparent !important;
      }
      #remoteVideo::-webkit-media-controls-enclosure {
        background-image: none !important;
        background: transparent !important;
      }
      .placeholder {
        width: 100%;
        height: 100%;
        color: #6c757d;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #050505;
        position: relative;
        z-index: 1;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }
      .status.connecting .status-dot {
        background-color: #0d6efd;
      }
      .status.waiting .status-dot {
        background-color: #ffc107;
      }
      .status.connected .status-dot {
        background-color: #b0b0b0;
      }
      .status.error .status-dot {
        background-color: #dc3545;
      }
      .beta-badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        background-color: #ffc107;
        color: #000;
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      #roomIdToast,
      #coordsCopiedToast {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 193, 7, 0.95);
        color: #000;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1060;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      #coordsCopiedToast {
        background-color: rgba(70, 83, 115, 0.95);
        color: #fff;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      /* Dark theme for Leaflet map controls */
      .leaflet-bar,
      .leaflet-control {
        background-color: #2c2c2c !important;
        border: 1px solid #444 !important;
      }
      .leaflet-bar a,
      .leaflet-control a {
        background-color: #2c2c2c !important;
        color: #fff !important;
        border-bottom: 1px solid #444 !important;
      }
      .leaflet-bar a:hover,
      .leaflet-control a:hover {
        background-color: #3c3c3c !important;
      }
      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        color: #fff !important;
      }
      /* Dark theme for attribution text */
      .leaflet-control-attribution {
        background-color: rgba(44, 44, 44, 0.8) !important;
        color: #ccc !important;
      }
      .leaflet-control-attribution a {
        color: #b0b0b0 !important;
        background-color: transparent !important;
        border: none !important;
      }
      /* Dark theme for scale control */
      .leaflet-control-scale {
        background: none !important;
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
      }
      .leaflet-control-scale-line {
        background: none !important;
        background-color: transparent !important;
        border: 2px solid #fff !important;
        border-top: none !important;
        color: #fff !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.8), 1px -1px 2px rgba(0, 0, 0, 0.8), -1px 1px 2px rgba(0, 0, 0, 0.8) !important;
      }
      /* Hide navbar brand text on narrow screens */
      @media (max-width: 991px) {
        .navbar-brand span:not(.beta-badge) {
          display: none;
        }
      }
      /* Hide history dropdown at medium sizes to prevent navbar overflow */
      @media (min-width: 768px) and (max-width: 991px) {
        #historyDropdown {
          display: none !important;
        }
      }
      /* Reduce navbar spacing at medium sizes */
      @media (min-width: 768px) and (max-width: 991px) {
        .navbar .btn,
        .navbar .btn-group {
          margin-right: 0.5rem !important;
        }
        /* Remove margin from viewer count at medium sizes */
        #viewerCount {
          margin-right: 0 !important;
        }
      }
      /* Hide viewer count text at smaller medium sizes, keep icon */
      @media (min-width: 768px) and (max-width: 900px) {
        #viewerCount {
          display: none !important;
        }
      }
      /* Compact navbar styling */
      .navbar {
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }
      .navbar-brand {
        margin-right: 0.5rem;
        font-size: 0.9rem;
      }
      .navbar-brand img {
        height: 32px !important;
        margin-right: 0.5rem !important;
      }
      .navbar .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
      }
      .navbar .btn-group .btn {
        padding: 0.375rem 0.5rem;
      }
      .navbar #status {
        font-size: 0.8rem;
      }
      .navbar #status .status-dot {
        width: 8px;
        height: 8px;
      }
      /* Compact CalTopo button */
      #caltopoBtn {
        padding: 0.5rem 0.5rem !important;
        gap: 0.15rem !important;
      }
      #caltopoBtn div {
        font-size: 0.75rem !important;
      }
      #caltopoBtn img {
        height: 14px !important;
      }
      /* Reduce spacing between all navbar items */
      .navbar .me-3 {
        margin-right: 0.5rem !important;
      }
      .navbar .me-2 {
        margin-right: 0.35rem !important;
      }
      /* Compact viewer count */
      .navbar .text-white {
        font-size: 0.85rem;
      }
      /* Force default cursor everywhere to prevent loading spinner cursor */
      body, #videoContainer, .placeholder {
        cursor: default !important;
      }
    </style>

    <!-- Eruda Mobile Console for debugging -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script> -->
  </head>
  <body>
    <!-- Hidden elements required by client.js -->
    <input type="hidden" id="roomIdInput" />
    <input type="hidden" id="roomIdInputMobile" />
    <button type="button" id="leaveBtn" style="display: none;" onclick="leaveRoom()"></button>
    
    <!-- Toast notification for room ID validation -->
    <div id="roomIdToast"></div>

    <!-- Toast notification for coordinates copied -->
    <div id="coordsCopiedToast"></div>

    <!-- Coordinate dialog modal -->
    <div id="coordinateDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="hideCoordinateDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        color: white;
      " onclick="event.stopPropagation()">
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <span style="font-weight: 500;">🌐 Location:</span>
            <span id="dialogLocation" class="font-monospace" style="flex: 1;">Waiting for location data...</span>
            <button onclick="copyLocationCoordinates()" style="
              background-color: #465373;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 13px;
              white-space: nowrap;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-clipboard"></i> Copy
            </button>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">↑🏠 Altitude (home):</span>
            <span id="dialogAltHome" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">↑🌊 Altitude (sea level):</span>
            <span id="dialogAltSea" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">↑🛰️ Altitude (GPS/Ellipsoid):</span>
            <span id="dialogAltEllipsoid" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">🧭 Bearing:</span>
            <span id="dialogBearing" class="font-monospace">N/A</span>
          </div>
          <div>
            <span style="font-weight: 500;">🔋 Battery:</span>
            <span id="dialogBattery" class="font-monospace">N/A</span>
          </div>
        </div>
        <button onclick="hideCoordinateDialog()" style="
          background-color: #465373;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          width: 100%;
        " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
          OK
        </button>
      </div>
    </div>

    <!-- Viewer info input dialog modal -->
    <div id="viewerInfoDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    ">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Join Stream</h5>
          <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #aaa;">Enter your information (optional)</p>
        </div>
        <form id="viewerInfoForm" style="padding: 20px;">
          <div style="margin-bottom: 15px;">
            <label for="viewerNameInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Name</label>
            <input type="text" id="viewerNameInput" placeholder="Your name"
              minlength="3"
              maxlength="100"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <div style="margin-bottom: 20px;">
            <label for="viewerEmailInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Email</label>
            <input type="email" id="viewerEmailInput" placeholder="your.email@example.com"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <button type="submit" id="confirmJoinBtn" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Join Stream
          </button>
        </form>
      </div>
    </div>

    <!-- Viewer list dialog modal -->
    <div id="viewerListDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="if(window.viewer) window.viewer.hideViewerListDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Viewers</h5>
        </div>
        <div id="viewerListContainer" style="
          flex: 1;
          overflow-y: auto;
        ">
          <!-- Populated by JavaScript -->
        </div>
        <div style="padding: 15px; border-top: 1px solid #444;">
          <button onclick="if(window.viewer) window.viewer.hideViewerListDialog()" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="https://www.eagleeyessearch.com/">
          <img src="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" alt="Eagle Eyes Logo" style="height: 40px; margin-right: 10px; border-radius: 6px;">
          <span>Eagle Eyes Livestream Viewer</span>
        </a>

        <div
          id="status"
          class="status d-flex align-items-center text-white ms-auto me-2"
        >
          <span class="status-dot"></span>
          <span class="status-text small"></span>
        </div>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileControls"
          aria-controls="mobileControls"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse">
          <div class="d-flex align-items-center ms-auto">
            <button
              id="caltopoBtn"
              class="btn me-3"
              style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.75rem 0.75rem;"
              onclick="openCaltopoMap()"
              title="Open CalTopo Map"
            >
              <div style="font-size: 0.85rem; white-space: nowrap; line-height: 1.2;">View <span id="caltopoMapName"></span> on</div>
              <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto; margin-top: 2px;">
            </button>

            <div class="btn-group me-3" role="group">
              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="split-view"
                autocomplete="off"
                checked
              />
              <label
                class="btn btn-outline-secondary"
                for="split-view"
                title="Split View"
                ><i class="bi bi-layout-split"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="video-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="video-only"
                title="Video Only"
                ><i class="bi bi-camera-video"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="map-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="map-only"
                title="Map Only"
                ><i class="bi bi-map"></i
              ></label>
            </div>

            <div class="dropdown me-3">
              <button
                class="btn dropdown-toggle"
                type="button"
                id="historyDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="History"
                style="border-color: #b0b0b0; color: #b0b0b0;"
              >
                <i class="bi bi-clock-history"></i>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="historyDropdown"
                style="min-width: 300px;"
              >
                <li><h6 class="dropdown-header">History</h6></li>
                <li>
                  <div id="historyList" class="text-muted text-center px-3">
                    No recent streams
                  </div>
                </li>
              </ul>
            </div>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              title="Connect to a Stream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-box-arrow-in-right"></i>
            </button>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#shareModal"
              title="Share Livestream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-share"></i>
            </button>

            <button
              class="btn me-3 d-none d-lg-inline-block"
              type="button"
              id="leaveBtnDesktop"
              onclick="leaveRoom()"
              title="Disconnect"
              style="background-color: #dc3545; border-color: #dc3545; color: white;"
              disabled
            >
              <i class="bi bi-stop-fill"></i>
            </button>

            <div class="text-white me-3" style="cursor: pointer;" onclick="if(window.viewer) window.viewer.showViewerListDialog()" title="View viewer list">
              <i class="bi bi-people"></i> <span id="viewerCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Connect to Stream Modal -->
    <div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="joinModalLabel">Connect to a Stream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Manual Stream ID Entry -->
            <div class="mb-4">
              <label for="modalRoomIdInput" class="form-label">Enter Stream ID</label>
              <div class="input-group">
                <input
                  type="text"
                  id="modalRoomIdInput"
                  class="form-control"
                  placeholder="Stream ID"
                  list="streamHistoryDatalist"
                />
                <datalist id="streamHistoryDatalist">
                  <!-- Populated dynamically by JavaScript -->
                </datalist>
                <button
                  class="btn"
                  type="button"
                  onclick="joinRoomFromModal()"
                  style="background-color: #314268; border-color: #314268; color: white;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect
                </button>
              </div>
            </div>

            <!-- Divider -->
            <div class="text-center text-muted mb-4">
              <hr class="my-2">
              <small>Or</small>
              <hr class="my-2">
            </div>

            <!-- QR Code Scanner -->
            <div class="text-center">
              <h6 class="mb-3">Scan a QR Code on this device</h6>
              <div id="qrScannerContainer" style="display: none; margin: 0 auto;">
                <div id="qrReader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                <div id="qrScanResult" class="mt-2 text-success"></div>
              </div>
              <button
                id="activateCameraBtn"
                class="btn btn-primary w-100"
                type="button"
                onclick="activateQRScanner()"
              >
                <i class="bi bi-camera"></i> Activate Camera
              </button>
              <button
                id="stopCameraBtn"
                class="btn btn-danger w-100 mt-2"
                type="button"
                onclick="stopQRScanner()"
                style="display: none;"
              >
                <i class="bi bi-camera-video-off"></i> Stop Camera
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="shareModalLabel">Share Livestream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p class="mb-3">Scan the QR code to view this livestream on another device</p>
            <div id="qrcode" class="d-flex justify-content-center mb-3" style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 0 auto;"></div>
            <button class="btn btn-primary w-100 mb-3" onclick="shareLivestream()">
              <i class="bi bi-share"></i> Share Livestream Link
            </button>
            <div class="text-muted small">
              <div class="mb-1">Or</div>
              <div class="mb-2">Share this Stream ID for others to enter in <i class="bi bi-box-arrow-in-right"></i> "Connect to a Stream":</div>
              <div class="font-monospace text-white fs-5" id="modalRoomId" onclick="copyRoomId()" style="cursor: pointer; user-select: all;" title="Click to copy">-</div>
              <div id="roomIdCopiedMessage" style="color: #28a745; font-size: 12px; margin-top: 8px; display: none;">Copied to clipboard</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification - Below share button -->
    <div class="toast-container position-fixed" id="toastContainer" style="display: none;">
      <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="width: auto; min-width: fit-content;">
        <div class="d-flex align-items-center justify-content-center">
          <div class="toast-body text-center" style="padding: 8px 16px;">
            <i class="bi bi-check-circle"></i> URL copied to clipboard
          </div>
          <button type="button" class="btn-close btn-close-white me-2" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- Mobile Offcanvas Sidebar -->
    <div
      class="offcanvas offcanvas-start bg-dark text-white"
      tabindex="-1"
      id="mobileControls"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Eagle Eyes Livestream Viewer</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#joinModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="leaveBtnMobile"
            class="btn btn-dark"
            onclick="leaveRoom()"
            disabled
          >
            <i class="bi bi-stop-fill"></i> Disconnect
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="caltopoBtnMobile"
            class="btn"
            style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.75rem 0.75rem;"
            onclick="openCaltopoMap()"
            title="Open CalTopo Map"
          >
            <div style="font-size: 0.85rem; line-height: 1.2;">View <span id="caltopoMapNameMobile"></span> on</div>
            <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto; margin-top: 2px;">
          </button>
        </div>
        <hr />
        <h6>View Mode</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="split-view-mobile"
            autocomplete="off"
            checked
          />
          <label class="btn btn-outline-secondary" for="split-view-mobile"
            >Split</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="video-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="video-only-mobile"
            >Video</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="map-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="map-only-mobile"
            >Map</label
          >
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-secondary" onclick="centerOnDrone()">
            <i class="bi bi-bullseye"></i> Center on Drone
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#shareModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-share"></i> Share Livestream
          </button>
        </div>
        <hr />
        <h6>History</h6>
        <div class="mb-3">
          <div id="historyListMobile" class="text-muted text-center">
            No recent streams
          </div>
        </div>
        <hr />
        <p>
          <strong>Stream:</strong> <span id="roomIdDisplay">Not connected</span>
        </p>
        <p>
          <strong>Connection:</strong>
          <span id="connectionStatus">Disconnected</span>
        </p>
        <strong>Coordinates:</strong>
        <p
          id="coordinateDisplay"
          class="bg-black px-2 py-1 rounded font-monospace small"
        >
          Waiting for location data...
        </p>
      </div>
    </div>

    <main id="main-content" class="row g-0" style="position: relative;">
      <!-- Shared disconnected overlay -->
      <div id="sharedDisconnectedOverlay" style="
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        z-index: 1040;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        gap: 8px;
        width: fit-content;
        white-space: nowrap;
      ">
        <i class="bi bi-wifi-off"></i>
        <span>Stream disconnected. Attempting to reconnect...</span>
        <div style="display: flex; gap: 6px; margin-left: 8px;">
          <button onclick="if(window.viewer) window.viewer.retryConnection()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
          " title="Try to reconnect now" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Try Again
          </button>
          <button onclick="if(window.viewer) window.viewer.closeStream()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
          " title="Close this stream" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Close this stream
          </button>
        </div>
      </div>

      <!-- Connection failed overlay -->
      <div id="connectionFailedOverlay" style="
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1050;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: none;
        flex-direction: column;
        gap: 8px;
        max-width: 90%;
        width: auto;
      ">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-exclamation-triangle-fill" style="font-size: 16px;"></i>
          <span style="font-weight: 600;">Connection Failed</span>
          <button onclick="hideConnectionFailedMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin: 0 0 0 auto;
            line-height: 1;
            opacity: 0.9;
            display: flex;
            align-items: center;
          " title="Dismiss">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div style="font-size: 12px; font-weight: 400; line-height: 1.4; opacity: 0.95;">
          Streaming may not work on mobile data unless you're connected to the same hotspot. VPNs can also cause connection issues.
        </div>
      </div>

      <div id="video-panel">
        <div id="coordinateStripContainer" class="bg-dark text-white px-2 py-1 border-top border-secondary" style="flex: 0 0 auto; display: none; cursor: pointer;" onclick="showCoordinateDialog()">
          <div
            id="coordinateStrip"
            class="font-monospace small"
            style="display: flex; gap: 0.75rem; overflow: hidden; align-items: center;"
          >
            <span style="white-space: nowrap; flex-shrink: 0;">Waiting for location data...</span>
          </div>
        </div>
        <div id="videoContainer">
          <div class="placeholder">
            <i class="bi bi-camera-video-off" style="font-size: 5rem"></i>
            <p id="placeholderTitle">No video stream</p>
            <button
              id="placeholderConnectBtn"
              class="btn btn-lg"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              style="background-color: #314268; border-color: #314268; color: white; padding: 12px 24px; font-weight: 500; margin-top: 1rem;"
              onmouseover="this.style.backgroundColor='#3d5282'"
              onmouseout="this.style.backgroundColor='#314268'"
            >
              <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
            </button>
            <div id="connectingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="connectingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Connecting...</span>
                </div>
                Attempting to connect to <span id="connectingRoomIdInline" style="font-family: monospace; color: #ffc107;"></span>...
              </div>
              <div id="connectingTimeoutWarning" style="display: none; margin-top: 0.5rem; font-size: 0.9em; line-height: 1.4; color: #ffc107;">
                This is taking longer than expected. Check your internet connection.
              </div>
            </div>
            <div id="videoLoadingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="videoLoadingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Loading video...</span>
                </div>
                Found stream, attempting to load video...
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="connectedNoStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="noDataRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                You've connected to the stream but video is not loading. This is likely due to your internet connection type (some mobile data plans do not allow P2P streaming). Try switching to WiFi or share this stream with a device on a different connection.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  id="connectedNoStreamRetryBtn"
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="noStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="attemptedRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load this stream. The publisher may have stopped streaming, or the Stream ID may have been mistyped.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="roomFullDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="roomFullRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load stream: Streams are limited to 3 viewers to avoid network congestion. Ask other viewers to disconnect
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <a id="getHelpLink" href="https://www.eagleeyessearch.com/faq?query=livestreaming" target="_blank" style="
              margin-top: 1rem;
              display: inline-block;
              background-color: #465373;
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-question-circle"></i> Get Help
            </a>
          </div>
          <video id="remoteVideo" autoplay playsinline muted controls></video>
          <div class="play-overlay" id="playOverlay" onclick="resumeVideo()">
            <i class="bi bi-play-fill"></i>
          </div>
        </div>
      </div>
      <div id="map-panel">
        <div id="map"></div>
      </div>
    </main>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ '/js/livestream/map.js' | relative_url }}"></script>
    <script src="{{ '/js/livestream/client.js' | relative_url }}"></script>
    <script>
      // Register service worker for PWA functionality
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('Service Worker registered:', registration))
            .catch(error => console.log('Service Worker registration failed:', error));
        });
      }
      // Video play/pause overlay functionality
      function setupVideoControls() {
        const video = document.getElementById('remoteVideo');
        const playOverlay = document.getElementById('playOverlay');
        
        if (video && playOverlay) {
          // Show/hide play overlay based on video state
          video.addEventListener('pause', () => {
            if (video.style.display !== 'none') {
              playOverlay.style.display = 'flex';
            }
          });
          
          video.addEventListener('play', () => {
            playOverlay.style.display = 'none';
          });
          
          // Hide overlay when video ends
          video.addEventListener('ended', () => {
            playOverlay.style.display = 'none';
          });
        }
      }
      
      function resumeVideo() {
        const video = document.getElementById('remoteVideo');
        if (video && video.paused) {
          video.play();
        }
      }
      
      // Picture-in-Picture functionality
      function setupPictureInPicture() {
        const video = document.getElementById('remoteVideo');
        
        if (video && 'pictureInPictureEnabled' in document) {
          // Enter PiP when page loses visibility
          document.addEventListener('visibilitychange', async () => {
            if (document.hidden && !video.paused && video.style.display !== 'none') {
              try {
                if (video !== document.pictureInPictureElement) {
                  await video.requestPictureInPicture();
                }
              } catch (error) {
                console.log('PiP failed:', error);
              }
            }
          });
          
          // Optional: Exit PiP when page becomes visible again
          document.addEventListener('visibilitychange', async () => {
            if (!document.hidden && document.pictureInPictureElement) {
              try {
                await document.exitPictureInPicture();
              } catch (error) {
                console.log('Exit PiP failed:', error);
              }
            }
          });
        }
      }
      
      document.addEventListener("DOMContentLoaded", () => {
        const videoPanel = document.getElementById("video-panel");
        const mapPanel = document.getElementById("map-panel");
        
        // Initialize video controls and PiP
        setupVideoControls();
        setupPictureInPicture();

        // Function to hide coordinate segments that don't fit completely
        function updateCoordinateSegmentVisibility() {
          const coordStrip = document.getElementById("coordinateStrip");
          if (!coordStrip) return;

          const segments = Array.from(coordStrip.children);
          if (segments.length === 0) return;

          // Show all segments first to measure
          segments.forEach(seg => seg.style.display = '');

          const containerWidth = coordStrip.offsetWidth;
          let totalWidth = 0;
          const gap = 12; // 0.75rem in pixels (approximate)

          // Hide segments from right to left if they don't fit
          for (let i = 0; i < segments.length; i++) {
            const segmentWidth = segments[i].offsetWidth;
            const widthWithGap = totalWidth + segmentWidth + (i > 0 ? gap : 0);

            if (widthWithGap > containerWidth) {
              // This segment and all following don't fit
              for (let j = i; j < segments.length; j++) {
                segments[j].style.display = 'none';
              }
              break;
            }
            totalWidth = widthWithGap;
          }
        }

        // Create ResizeObserver for coordinate strip
        const coordStripContainer = document.getElementById("coordinateStripContainer");
        if (coordStripContainer) {
          const resizeObserver = new ResizeObserver(() => {
            updateCoordinateSegmentVisibility();
          });
          resizeObserver.observe(coordStripContainer);

          // Also update when content changes (via MutationObserver)
          const mutationObserver = new MutationObserver(() => {
            updateCoordinateSegmentVisibility();
          });
          const coordStrip = document.getElementById("coordinateStrip");
          if (coordStrip) {
            mutationObserver.observe(coordStrip, { childList: true, subtree: true });
          }
        }

        function setViewMode(mode) {
          const coordStrip = document.getElementById("coordinateStripContainer");

          if (mode === "video") {
            videoPanel.className = "full-view";
            videoPanel.style.flex = "1 1 100%";
            mapPanel.className = "d-none";
            mapPanel.style.flex = "";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
          } else if (mode === "map") {
            videoPanel.className = "d-none";
            videoPanel.style.flex = "";
            mapPanel.className = "full-view";
            mapPanel.style.flex = "1 1 100%";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-none";
          } else {
            // split - let CSS aspect ratio media queries handle layout
            videoPanel.className = "";
            videoPanel.style.flex = "";
            mapPanel.className = "";
            mapPanel.style.flex = "";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
          }
          if (window.droneMap) {
            setTimeout(() => window.droneMap.resize(), 150);
          }
        }

        document
          .querySelectorAll('input[name="view-mode"]')
          .forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only", "")
                .replace("-view", "");
              setViewMode(mode);
              // Sync mobile radios
              document.getElementById(mode + "-view-mobile").checked = true;
            });
          });
        document
          .querySelectorAll('input[name="view-mode-mobile"]')
          .forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only-mobile", "")
                .replace("-view-mobile", "");
              setViewMode(mode);
              // Sync desktop radios
              document.getElementById(mode + "-view").checked = true;
            });
          });
      });

      function centerOnDrone() {
        if (window.droneMap) window.droneMap.centerOnDrone();
      }

      function openCaltopoMap() {
        if (window.droneMap && window.droneMap.caltopoInfo) {
          const mapId = window.droneMap.caltopoInfo.map_id;
          if (mapId) {
            window.open(`https://caltopo.com/m/${mapId}`, '_blank');
          }
        }
      }

      function hideDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function showDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function hideConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function hideNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');

        if (placeholderTitle) placeholderTitle.style.display = 'block';
        if (placeholderConnectBtn) placeholderConnectBtn.style.display = 'inline-block';
        if (noStreamDetails) noStreamDetails.style.display = 'none';

        // Show map panel, coordinate strip, and restore normal layout when hiding notification
        const mapPanel = document.getElementById('map-panel');
        const videoPanel = document.getElementById('video-panel');
        const coordStripContainer = document.getElementById('coordinateStripContainer');
        if (mapPanel) mapPanel.style.display = 'block';
        if (videoPanel) videoPanel.classList.remove('col-12');
        if (coordStripContainer) coordStripContainer.style.display = 'flex';
      }

      function showNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');
        const attemptedRoomId = document.getElementById('attemptedRoomId');

        // Get the current room ID from the viewer
        const roomId = window.viewer ? window.viewer.currentRoomId : null;

        if (roomId && noStreamDetails && placeholderConnectBtn && attemptedRoomId) {
          // Hide the title and connect button, show the no stream details
          if (placeholderTitle) placeholderTitle.style.display = 'none';
          placeholderConnectBtn.style.display = 'none';
          attemptedRoomId.textContent = roomId;
          noStreamDetails.style.display = 'block';

          // Hide map panel, coordinate strip, and expand video panel when unable to load stream
          const mapPanel = document.getElementById('map-panel');
          const videoPanel = document.getElementById('video-panel');
          const coordStripContainer = document.getElementById('coordinateStripContainer');
          if (mapPanel) mapPanel.style.display = 'none';
          if (videoPanel) videoPanel.classList.add('col-12');
          if (coordStripContainer) coordStripContainer.style.display = 'none';
        }
      }

      function showConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function showCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');

        // Get current location data from the viewer
        if (window.viewer && window.viewer.currentLocation) {
          const loc = window.viewer.currentLocation;

          // Format with N/S/E/W for display
          const latDir = loc.latitude >= 0 ? 'N' : 'S';
          const lonDir = loc.longitude >= 0 ? 'E' : 'W';
          const latFormatted = `${Math.abs(loc.latitude).toFixed(5)}°${latDir}`;
          const lonFormatted = `${Math.abs(loc.longitude).toFixed(5)}°${lonDir}`;

          document.getElementById('dialogLocation').textContent = `${latFormatted}, ${lonFormatted}`;
          // Store plain coordinates for copying
          document.getElementById('dialogLocation').setAttribute('data-plain', `${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`);

          document.getElementById('dialogAltHome').textContent =
            loc.altitude_ahl != null ? `${loc.altitude_ahl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltSea').textContent =
            loc.altitude_asl != null ? `${loc.altitude_asl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltEllipsoid').textContent =
            loc.altitude_ellipsoid != null ? `${loc.altitude_ellipsoid.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogBearing').textContent =
            `${loc.bearing.toFixed(1)}° from True North`;

          document.getElementById('dialogBattery').textContent =
            loc.battery_percent != null ? `${loc.battery_percent}%` : 'N/A';
        }

        if (dialog) {
          dialog.style.display = 'flex';
        }
      }

      function hideCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');
        if (dialog) {
          dialog.style.display = 'none';
        }
      }

      function copyLocationCoordinates() {
        const locationElement = document.getElementById('dialogLocation');
        const plainText = locationElement.getAttribute('data-plain');
        navigator.clipboard.writeText(plainText).then(() => {
          const toast = document.getElementById('coordsCopiedToast');
          if (toast) {
            toast.textContent = `Copied '${plainText}' to clipboard`;
            toast.style.display = 'block';
            setTimeout(() => {
              toast.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy coordinates:', err);
        });
      }

      // Share functionality
      // Generate QR code when modal is shown
      const shareModal = document.getElementById('shareModal');
      shareModal.addEventListener('show.bs.modal', function () {
        // Always regenerate QR code to ensure it reflects current URL
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = ''; // Clear any existing QR code
        const currentUrl = window.location.href;

        // Only generate if there's a stream in the URL
        if (currentUrl.includes('?stream=') || currentUrl.includes('&stream=') ||
            currentUrl.includes('?room=') || currentUrl.includes('&room=')) {
          console.log('Generating QR code for URL:', currentUrl);
          new QRCode(qrcodeContainer, {
            text: currentUrl,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          console.log('QR code generated successfully');
        } else {
          // Show message if no stream is active
          console.log('No stream in URL, cannot generate QR code');
          qrcodeContainer.innerHTML = '<div style="padding: 20px; color: #6c757d;">Connect to a stream first to generate QR code</div>';
        }
        
        // Update Stream ID display in share modal
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomId = document.getElementById('modalRoomId');
        if (roomIdInput && modalRoomId) {
          let currentRoomId = roomIdInput.value.trim();

          // If roomIdInput is empty, try to get it from URL
          if (!currentRoomId) {
            const urlParams = new URLSearchParams(window.location.search);
            // Try 'stream' first, then 'room' for backwards compatibility
            currentRoomId = urlParams.get('stream') || urlParams.get('room') || '';
          }

          // If it's a URL, extract just the stream ID
          if (currentRoomId.includes('http://') || currentRoomId.includes('https://') || currentRoomId.includes('?')) {
            try {
              const url = new URL(currentRoomId);
              // Try 'stream' first, then 'room' for backwards compatibility
              currentRoomId = url.searchParams.get('stream') || url.searchParams.get('room') || '';
            } catch (e) {
              // Try to extract from query string manually
              const match = currentRoomId.match(/[?&](stream|room)=([^&]+)/);
              if (match) {
                currentRoomId = match[2];
              }
            }
          }

          modalRoomId.textContent = currentRoomId || '-';
        }
      });

      function joinRoomFromModal() {
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomIdInputMobile = document.getElementById('roomIdInputMobile');
        const roomId = modalRoomIdInput.value.trim();

        if (!roomId) {
          alert("Please enter a stream ID");
          return;
        }
        
        // Update both hidden room ID inputs with the modal value
        if (roomIdInput) {
          roomIdInput.value = roomId;
          console.log('Updated hidden roomIdInput with:', roomId);
        } else {
          console.error('roomIdInput element not found!');
        }
        
        if (roomIdInputMobile) {
          roomIdInputMobile.value = roomId;
          console.log('Updated hidden roomIdInputMobile with:', roomId);
        }
        
        // Close the modal
        const joinModalElement = document.getElementById('joinModal');
        const joinModalInstance = bootstrap.Modal.getInstance(joinModalElement);
        if (joinModalInstance) {
          joinModalInstance.hide();
        } else {
          // If no instance exists yet, create one and hide it
          const modal = new bootstrap.Modal(joinModalElement);
          modal.hide();
        }
        
        // Call the main joinRoom function
        console.log('Calling joinRoom()...');
        if (window.joinRoom) {
          joinRoom();
        } else {
          console.error('joinRoom function not found!');
        }
      }

      function copyRoomId() {
        const roomIdElement = document.getElementById('modalRoomId');
        const roomId = roomIdElement.textContent.trim();
        
        // Don't copy if it's just a dash (no room ID)
        if (roomId === '-') {
          return;
        }
        
        navigator.clipboard.writeText(roomId).then(() => {
          // Show the "Copied to clipboard" message
          const copiedMessage = document.getElementById('roomIdCopiedMessage');
          if (copiedMessage) {
            copiedMessage.style.display = 'block';
            
            // Hide the message after 2 seconds
            setTimeout(() => {
              copiedMessage.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy room ID:', err);
        });
      }

      async function shareLivestream() {
        const currentUrl = window.location.href;
        
        // Check if device is mobile and Web Share API is available
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile && navigator.share) {
          try {
            await navigator.share({
              title: 'Eagle Eyes Livestream',
              text: 'Join this Eagle Eyes livestream',
              url: currentUrl
            });
          } catch (err) {
            // User cancelled share or error occurred
            if (err.name !== 'AbortError') {
              console.error('Error sharing:', err);
              copyToClipboard(currentUrl);
            }
          }
        } else {
          // Desktop or fallback: always copy to clipboard
          copyToClipboard(currentUrl);
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          // Position toast below the share button
          const shareButton = document.querySelector('#shareModal .btn-primary');
          const toastContainer = document.getElementById('toastContainer');
          const modalDialog = document.querySelector('#shareModal .modal-dialog');
          
          if (shareButton && toastContainer && modalDialog) {
            const buttonRect = shareButton.getBoundingClientRect();
            const modalRect = modalDialog.getBoundingClientRect();
            
            // Position toast below the button, aligned horizontally with modal
            toastContainer.style.left = `${modalRect.left}px`;
            toastContainer.style.top = `${buttonRect.bottom + 10}px`;
            toastContainer.style.display = 'block';
          }
          
          // Show toast notification
          const toastEl = document.getElementById('copyToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        }).catch(err => {
          console.error('Failed to copy:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            
            // Position toast below the share button (fallback)
            const shareButton = document.querySelector('#shareModal .btn-primary');
            const toastContainer = document.getElementById('toastContainer');
            const modalDialog = document.querySelector('#shareModal .modal-dialog');
            
            if (shareButton && toastContainer && modalDialog) {
              const buttonRect = shareButton.getBoundingClientRect();
              const modalRect = modalDialog.getBoundingClientRect();
              toastContainer.style.left = `${modalRect.left}px`;
              toastContainer.style.top = `${buttonRect.bottom + 10}px`;
              toastContainer.style.display = 'block';
            }
            
            const toastEl = document.getElementById('copyToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
          } catch (err) {
            console.error('Fallback copy failed:', err);
          }
          document.body.removeChild(textArea);
        });
      }

      // Handle Enter key in join modal input
      document.getElementById('modalRoomIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          joinRoomFromModal();
        }
      });

      // Add room ID validation to modal input (same as navbar inputs)
      document.getElementById('modalRoomIdInput').addEventListener('input', function(e) {
        // Use the same validation function as the navbar inputs
        if (window.viewer && window.viewer.validateAndFormatRoomId) {
          const validated = window.viewer.validateAndFormatRoomId(e.target.value);
          e.target.value = validated;
          
          // Also sync with hidden navbar inputs
          const roomIdInput = document.getElementById('roomIdInput');
          const roomIdInputMobile = document.getElementById('roomIdInputMobile');
          if (roomIdInput) roomIdInput.value = validated;
          if (roomIdInputMobile) roomIdInputMobile.value = validated;
        }
      });

      // Pre-populate modal with current stream ID when opened
      document.getElementById('joinModal').addEventListener('show.bs.modal', function () {
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        if (roomIdInput && modalRoomIdInput) {
          const currentRoomId = roomIdInput.value.trim();
          if (currentRoomId) {
            modalRoomIdInput.value = currentRoomId;
            modalRoomIdInput.placeholder = 'Enter a different Stream ID or use current';
          } else {
            modalRoomIdInput.placeholder = 'Stream ID';
          }
        }
      });

      // QR Code Scanner functionality
      let html5QrCode = null;
      let qrScannerActive = false;

      async function activateQRScanner() {
        const qrScannerContainer = document.getElementById('qrScannerContainer');
        const activateBtn = document.getElementById('activateCameraBtn');
        const stopBtn = document.getElementById('stopCameraBtn');
        const qrScanResult = document.getElementById('qrScanResult');

        try {
          qrScannerContainer.style.display = 'block';
          activateBtn.style.display = 'none';
          stopBtn.style.display = 'block';
          qrScanResult.textContent = 'Point your camera at a QR code...';

          html5QrCode = new Html5Qrcode("qrReader");
          
          const config = { 
            fps: 30, 
            qrbox: { width: 200, height: 200 },
            aspectRatio: 1.0,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          };
          
          await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
              // QR code successfully scanned
              console.log('QR Code scanned! Raw text:', decodedText);
              qrScanResult.textContent = 'QR Code detected! Joining livestream...';
              
              // Extract stream ID from URL if it's a full URL, or use as-is if it's just an ID
              let roomId = decodedText;
              try {
                const url = new URL(decodedText);
                // Try 'stream' first, then 'room' for backwards compatibility
                const urlRoomId = url.searchParams.get('stream') || url.searchParams.get('room');
                if (urlRoomId) {
                  roomId = urlRoomId;
                  console.log('Extracted stream ID from URL:', roomId);
                } else {
                  console.log('No stream parameter in URL, using full URL as stream ID');
                }
              } catch (e) {
                // Not a URL, use as-is
                console.log('Not a valid URL, using raw text as stream ID:', roomId);
              }
              
              // Keep room ID in uppercase (don't normalize to lowercase)
              roomId = roomId.toUpperCase();
              console.log('Final room ID (uppercase):', roomId);
              
              // Stop scanner and join
              stopQRScanner();
              
              // Close modal
              const joinModal = bootstrap.Modal.getInstance(document.getElementById('joinModal'));
              if (joinModal) {
                joinModal.hide();
              }
              
              // Update the hidden roomIdInput field
              const hiddenRoomIdInput = document.getElementById('roomIdInput');
              const hiddenRoomIdInputMobile = document.getElementById('roomIdInputMobile');
              if (hiddenRoomIdInput) {
                hiddenRoomIdInput.value = roomId;
              }
              if (hiddenRoomIdInputMobile) {
                hiddenRoomIdInputMobile.value = roomId;
              }
              
              // Call the joinRoom function
              if (window.joinRoom) {
                joinRoom();
              }
            },
            (errorMessage) => {
              // QR code parsing error (usually means no QR code in view)
              // This is called frequently, so we don't show errors here
              // Only log if it's not a common "No QR code found" message
              if (!errorMessage.includes('No QR code found') && !errorMessage.includes('NotFoundException')) {
                console.log('QR scan error:', errorMessage);
              }
            }
          );
          
          qrScannerActive = true;
        } catch (err) {
          console.error('Error starting QR scanner:', err);
          qrScanResult.textContent = 'Error: Could not access camera. Please check permissions.';
          qrScanResult.classList.remove('text-success');
          qrScanResult.classList.add('text-danger');
          activateBtn.style.display = 'block';
          stopBtn.style.display = 'none';
          qrScannerContainer.style.display = 'none';
        }
      }

      function stopQRScanner() {
        if (html5QrCode && qrScannerActive) {
          html5QrCode.stop().then(() => {
            const qrScannerContainer = document.getElementById('qrScannerContainer');
            const activateBtn = document.getElementById('activateCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const qrScanResult = document.getElementById('qrScanResult');
            
            qrScannerContainer.style.display = 'none';
            activateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            qrScanResult.textContent = '';
            qrScanResult.classList.remove('text-danger');
            qrScanResult.classList.add('text-success');
            
            qrScannerActive = false;
          }).catch(err => {
            console.error('Error stopping QR scanner:', err);
          });
        }
      }

      // Clean up QR scanner when modal is closed
      document.getElementById('joinModal').addEventListener('hidden.bs.modal', function () {
        if (qrScannerActive) {
          stopQRScanner();
        }
      });

    </script>
  </body>
</html>
