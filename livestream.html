---
permalink: /livestream/
---
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Beta Logo for Livestream Page Only -->
    <link rel="icon" href="{{ '/images/eagle-eyes-beta-logo.png' | relative_url }}" type="image/png">
    <link rel="shortcut icon" href="{{ '/images/eagle-eyes-beta-logo.png' | relative_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ '/images/eagle-eyes-beta-logo.png' | relative_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:image" content="{{ '/images/eagle-eyes-beta-logo.png' | absolute_url }}">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="{{ '/images/eagle-eyes-beta-logo.png' | absolute_url }}">
    
    <title>Eagle Eyes Livestream Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
      }
      #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      /* Desktop: Video left, map right */
      @media (min-width: 992px) {
        #main-content {
          flex-direction: row !important;
        }
      }
      
      /* Large desktop screens (1200px+) - wider map panel */
      @media (min-width: 1200px) {
        #video-panel {
          flex: 0 0 60% !important;
        }
        #map-panel {
          flex: 0 0 40% !important;
        }
      }
      
      /* Medium desktop screens (992px-1199px) - balanced split */
      @media (min-width: 992px) and (max-width: 1199px) {
        #video-panel {
          flex: 0 0 65% !important;
        }
        #map-panel {
          flex: 0 0 35% !important;
        }
      }
      
      /* Small desktop/large tablet (768px-991px) - more video space */
      @media (min-width: 768px) and (max-width: 991px) {
        #main-content {
          flex-direction: row !important;
        }
        #video-panel {
          flex: 0 0 70% !important;
        }
        #map-panel {
          flex: 0 0 30% !important;
        }
      }
      
      /* Responsive navbar adjustments */
      @media (min-width: 1200px) {
        .navbar {
          padding: 0.75rem 1.5rem;
        }
        .navbar-brand {
          font-size: 1.1rem;
        }
        .navbar-brand img {
          height: 45px;
        }
      }
      
      @media (min-width: 992px) and (max-width: 1199px) {
        .navbar {
          padding: 0.6rem 1.2rem;
        }
        .navbar-brand {
          font-size: 1rem;
        }
        .navbar-brand img {
          height: 40px;
        }
      }
      
      @media (min-width: 768px) and (max-width: 991px) {
        .navbar {
          padding: 0.4rem 1rem;
        }
        .navbar-brand {
          font-size: 0.9rem;
        }
        .navbar-brand img {
          height: 35px;
        }
        .navbar-brand span {
          display: none; /* Hide text on smaller screens */
        }
      }
      
      /* Responsive control buttons */
      @media (min-width: 1200px) {
        .btn-group .btn {
          padding: 0.5rem 0.75rem;
          font-size: 0.9rem;
        }
        #caltopoBtn {
          padding: 0.5rem 0.75rem;
          font-size: 0.85rem;
        }
      }
      
      @media (min-width: 992px) and (max-width: 1199px) {
        .btn-group .btn {
          padding: 0.4rem 0.6rem;
          font-size: 0.85rem;
        }
        #caltopoBtn {
          padding: 0.4rem 0.6rem;
          font-size: 0.8rem;
        }
      }
      
      @media (min-width: 768px) and (max-width: 991px) {
        .btn-group .btn {
          padding: 0.3rem 0.5rem;
          font-size: 0.8rem;
        }
        #caltopoBtn {
          padding: 0.3rem 0.5rem;
          font-size: 0.75rem;
        }
        #caltopoBtn div {
          font-size: 0.75rem;
        }
      }
      
      /* Responsive coordinate strip */
      @media (min-width: 1200px) {
        .coordinate-strip {
          padding: 0.5rem 1rem;
          font-size: 0.9rem;
        }
      }
      
      @media (min-width: 992px) and (max-width: 1199px) {
        .coordinate-strip {
          padding: 0.4rem 0.8rem;
          font-size: 0.85rem;
        }
      }
      
      @media (min-width: 768px) and (max-width: 991px) {
        .coordinate-strip {
          padding: 0.3rem 0.6rem;
          font-size: 0.8rem;
        }
      }
      
      /* Responsive video and map content */
      @media (min-width: 1200px) {
        #remoteVideo {
          object-fit: contain;
        }
        .map-container {
          font-size: 0.9rem;
        }
        .leaflet-control-zoom {
          font-size: 1.1rem;
        }
      }
      
      @media (min-width: 992px) and (max-width: 1199px) {
        #remoteVideo {
          object-fit: contain;
        }
        .map-container {
          font-size: 0.85rem;
        }
        .leaflet-control-zoom {
          font-size: 1rem;
        }
      }
      
      @media (min-width: 768px) and (max-width: 991px) {
        #remoteVideo {
          object-fit: contain;
        }
        .map-container {
          font-size: 0.8rem;
        }
        .leaflet-control-zoom {
          font-size: 0.9rem;
        }
        .leaflet-control-zoom a {
          width: 28px;
          height: 28px;
          line-height: 28px;
        }
      }
      #video-panel,
      #map-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #000;
        min-height: 0;
      }
      /* Mobile: Optimized split screen layout */
      @media (max-width: 991px) {
        #video-panel {
          flex: 0 0 60%; /* Better balance for mobile */
        }
        #map-panel {
          flex: 0 0 40%; /* More map space for better usability */
        }
      }
      @media (min-width: 992px) {
        #video-panel {
          flex: 0 0 60%; /* Optimized for 16:9 video mode */
        }
        #map-panel {
          flex: 0 0 40%; /* More map space for better balance */
        }
      }
      /* Dynamic sizing for photo mode - eliminates black bars */
      @media (min-width: 992px) {
        #video-panel.dynamic-sized {
          flex: 0 0 auto !important;
          max-width: none !important;
        }
        #map-panel.dynamic-sized {
          flex: 1 1 auto !important;
        }
      }
      
      /* Mobile vertical optimization for photo mode */
      @media (max-width: 991px) {
        #video-panel.dynamic-sized {
          flex: 0 0 auto !important;
          max-height: none !important;
        }
        #map-panel.dynamic-sized {
          flex: 1 1 auto !important;
        }
      }
      /* Full size for single-view modes */
      #video-panel.full-view,
      #map-panel.full-view {
        flex: 1 1 100% !important;
        width: 100% !important;
        height: 100% !important;
        min-width: 0;
        min-height: 0;
        max-width: 100% !important;
        max-height: 100% !important;
      }
      /* Override media query restrictions for fullscreen modes */
      @media (min-width: 992px) {
        #video-panel.full-view,
        #map-panel.full-view {
          flex: 1 1 100% !important;
        }
      }
      #map-panel {
        background-color: #181818;
      }
      #videoContainer,
      #map {
        width: 100%;
        flex: 1;
        min-height: 0;
      }
      #videoContainer {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }
      #remoteVideo {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
        z-index: 2;
      }
      /* Smart video fitting based on view mode */
      #remoteVideo {
        object-fit: contain; /* Default: show full video without cropping */
      }
      
      /* Video fullscreen mode: use cover to fill space */
      #video-panel.full-view #remoteVideo {
        object-fit: cover;
      }
      
      /* Mobile landscape optimization: 50/50 split */
      @media (max-width: 991px) and (orientation: landscape) {
        #main-content {
          flex-direction: row !important; /* Video left, map right */
        }
        #video-panel {
          flex: 0 0 50% !important;
          min-width: 0;
        }
        #map-panel {
          flex: 0 0 50% !important;
          min-width: 0;
        }
        #remoteVideo {
          object-fit: contain; /* Show full video without cropping */
        }
      }
      
      /* Mobile portrait: video top, map bottom layout */
      @media (max-width: 991px) and (orientation: portrait) {
        #main-content {
          flex-direction: column !important;
        }
        #video-panel {
          flex: 0 0 50% !important;
          min-height: 0;
        }
        #map-panel {
          flex: 0 0 50% !important;
          min-height: 0;
        }
        #remoteVideo {
          object-fit: contain; /* Show full video without cropping */
        }
      }
      
      /* Additional mobile optimizations */
      @media (max-width: 991px) {
        /* Ensure panels take full height in mobile */
        #main-content {
          height: calc(100vh - 120px); /* Account for navbar height */
        }
      }
      .placeholder {
        width: 100%;
        height: 100%;
        color: #6c757d;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: #050505;
        position: relative;
        z-index: 1;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }
      .status.connecting .status-dot {
        background-color: #0d6efd;
      }
      .status.waiting .status-dot {
        background-color: #ffc107;
      }
      .status.connected .status-dot {
        background-color: #b0b0b0;
      }
      .status.error .status-dot {
        background-color: #dc3545;
      }
      .beta-badge {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
        margin-left: 0.5rem;
        background-color: #ffc107;
        color: #000;
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      #roomIdToast,
      #coordsCopiedToast {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 193, 7, 0.95);
        color: #000;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1060;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      #coordsCopiedToast {
        background-color: rgba(70, 83, 115, 0.95);
        color: #fff;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      /* Dark theme for Leaflet map controls */
      .leaflet-bar,
      .leaflet-control {
        background-color: #2c2c2c !important;
        border: 1px solid #444 !important;
      }
      .leaflet-bar a,
      .leaflet-control a {
        background-color: #2c2c2c !important;
        color: #fff !important;
        border-bottom: 1px solid #444 !important;
      }
      .leaflet-bar a:hover,
      .leaflet-control a:hover {
        background-color: #3c3c3c !important;
      }
      .leaflet-control-zoom-in,
      .leaflet-control-zoom-out {
        color: #fff !important;
      }
      /* Dark theme for attribution text */
      .leaflet-control-attribution {
        background-color: rgba(44, 44, 44, 0.8) !important;
        color: #ccc !important;
      }
      .leaflet-control-attribution a {
        color: #b0b0b0 !important;
        background-color: transparent !important;
        border: none !important;
      }
      /* Dark theme for scale control */
      .leaflet-control-scale {
        background: none !important;
        background-color: transparent !important;
        box-shadow: none !important;
        border: none !important;
      }
      .leaflet-control-scale-line {
        background: none !important;
        background-color: transparent !important;
        border: 2px solid #fff !important;
        border-top: none !important;
        color: #fff !important;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.8), 1px -1px 2px rgba(0, 0, 0, 0.8), -1px 1px 2px rgba(0, 0, 0, 0.8) !important;
      }
      /* Hide navbar brand text on narrow screens */
      @media (max-width: 991px) {
        .navbar-brand span:not(.beta-badge) {
          display: none;
        }
        
        /* Hide status text on mobile to make space for share button */
        #status .status-text {
          display: none !important;
        }
        
        /* Show mobile share button */
        #mobileShareBtn {
          display: block !important;
        }
        
        /* Mobile responsive error displays - make text and buttons smaller */
        #noStreamDetails, #connectedNoStreamDetails, #roomFullDetails {
          font-size: 10px !important;
          max-width: calc(100vw - 20px) !important;
          width: calc(100vw - 20px) !important;
          padding: 8px !important;
          margin: 0.3rem auto !important;
          word-wrap: break-word !important;
          line-height: 1.3 !important;
        }
        
        #noStreamDetails button, #connectedNoStreamDetails button, #roomFullDetails button {
          font-size: 8px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          width: auto !important;
          margin: 0.2rem 0 !important;
          white-space: normal !important;
          overflow: visible !important;
          text-overflow: initial !important;
          display: inline-block !important;
          line-height: 1.2 !important;
          min-height: auto !important;
          height: auto !important;
        }
        
        #noStreamDetails button i, #connectedNoStreamDetails button i, #roomFullDetails button i {
          font-size: 6px !important;
        }
        
        #getHelpLink {
          font-size: 8px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          max-width: calc(100vw - 20px) !important;
          width: calc(100vw - 20px) !important;
          padding: 10px !important;
          margin: 0.5rem auto !important;
          word-wrap: break-word !important;
        }
        
        #noStreamDetails button, #connectedNoStreamDetails button, #roomFullDetails button {
          font-size: 10px !important;
          padding: 4px 8px !important;
          max-width: 200px !important;
          width: auto !important;
          margin: 0.2rem 0 !important;
          white-space: nowrap !important;
          overflow: hidden !important;
          text-overflow: ellipsis !important;
          display: inline-block !important;
        }
        
        #noStreamDetails button i, #connectedNoStreamDetails button i, #roomFullDetails button i {
          font-size: 8px !important;
        }
        
        #getHelpLink {
          font-size: 8px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          width: auto !important;
          margin: 0.2rem auto !important;
          display: inline-block !important;
          text-align: center !important;
          line-height: 1.2 !important;
        }
        
        #getHelpLink i {
          font-size: 6px !important;
        }
        
        /* Make placeholder content smaller for mobile */
        .placeholder {
          padding: 15px 10px !important;
          max-width: calc(100vw - 20px) !important;
          width: calc(100vw - 20px) !important;
        }
        
        .placeholder i {
          font-size: 2.5rem !important;
          margin-bottom: 0.5rem !important;
        }
        
        .placeholder p {
          font-size: 0.9rem !important;
          margin-bottom: 1rem !important;
          padding: 0 5px !important;
        }
        
        .placeholder .btn {
          font-size: 10px !important;
          padding: 4px 8px !important;
          max-width: 200px !important;
          width: auto !important;
        }
        
        .placeholder .btn i {
          font-size: 8px !important;
        }
        
      }
      
      /* Mobile landscape orientation - video left, map right (only for split view) */
      @media (max-width: 991px) and (orientation: landscape) {
        /* Split view layout for mobile landscape - only when not in full screen modes */
        #main-content:not(.fullscreen-video):not(.fullscreen-map) {
          flex-direction: row !important; /* Video left, map right */
        }
        #video-panel:not(.full-view):not(.d-none) {
          flex: 0 0 50% !important;
          min-width: 0;
          display: flex !important;
          width: 50% !important;
        }
        #map-panel:not(.full-view):not(.d-none) {
          flex: 0 0 50% !important;
          min-width: 0;
          display: flex !important;
          width: 50% !important;
        }
        #remoteVideo {
          object-fit: contain; /* Show full video without cropping */
        }
        
        /* Force override any conflicting classes - only for split view */
        #video-panel.col-lg-8:not(.full-view):not(.d-none) {
          flex: 0 0 50% !important;
          width: 50% !important;
        }
        #map-panel.col-lg-4:not(.full-view):not(.d-none) {
          flex: 0 0 50% !important;
          width: 50% !important;
        }
      }
        #noStreamDetails, #connectedNoStreamDetails, #roomFullDetails {
          font-size: 8px !important;
          padding: 4px !important;
          margin: 0.2rem auto !important;
          max-width: calc(100vw - 5px) !important;
          width: calc(100vw - 5px) !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
          hyphens: auto !important;
          text-align: center !important;
          line-height: 1.2 !important;
        }
        
        /* Target the specific error text within the video container */
        #noStreamDetails p, #connectedNoStreamDetails p, #roomFullDetails p {
          font-size: 6px !important;
          margin: 0.05rem 0 !important;
          padding: 0 1px !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
          hyphens: auto !important;
          line-height: 1.0 !important;
          max-width: calc(100vw - 8px) !important;
          width: calc(100vw - 8px) !important;
          text-align: center !important;
        }
        
        /* Target any text elements that might be causing overflow */
        #noStreamDetails *, #connectedNoStreamDetails *, #roomFullDetails * {
          max-width: 100% !important;
          word-wrap: break-word !important;
          overflow-wrap: break-word !important;
          hyphens: auto !important;
        }
        
        #noStreamDetails button, #connectedNoStreamDetails button, #roomFullDetails button {
          font-size: 7px !important;
          padding: 2px 4px !important;
          max-width: 120px !important;
          margin: 0.1rem 0 !important;
          white-space: normal !important;
          line-height: 1.1 !important;
          height: auto !important;
          min-height: auto !important;
        }
        
        #noStreamDetails button i, #connectedNoStreamDetails button i, #roomFullDetails button i {
          font-size: 5px !important;
        }
        
        #getHelpLink {
          font-size: 7px !important;
          padding: 2px 4px !important;
          max-width: 120px !important;
        }
        
        #getHelpLink i {
          font-size: 5px !important;
        }
      }
      
      /* Mobile portrait orientation - video top, map bottom */
      @media (max-width: 991px) and (orientation: portrait) {
        /* Split view layout for mobile portrait */
        #main-content {
          flex-direction: column !important; /* Video top, map bottom */
        }
        #video-panel {
          flex: 0 0 50% !important;
          min-height: 0;
          display: flex !important;
          width: 100% !important;
        }
        #map-panel {
          flex: 0 0 50% !important;
          min-height: 0;
          display: flex !important;
          width: 100% !important;
        }
        #remoteVideo {
          object-fit: contain; /* Show full video without cropping */
        }
        
      }
      
      
      /* Force default cursor everywhere to prevent loading spinner cursor */
      body, #videoContainer, .placeholder {
        cursor: default !important;
      }

      /* Ensure d-none properly hides the map panel */
      #map-panel.d-none {
        display: none !important;
      }
      
      /* Ensure map is visible when not hidden */
      #map-panel:not(.d-none) {
        display: flex !important;
      }

      /* Laser range finder marker animation */
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Mobile responsive styles for disconnect popup */
      @media (max-width: 768px) {
        #sharedDisconnectedOverlay {
          flex-direction: column !important;
          align-items: flex-start !important;
          gap: 8px !important;
          padding: 12px !important;
          font-size: 14px !important;
          width: calc(100vw - 20px) !important;
          max-width: calc(100vw - 20px) !important;
          white-space: normal !important;
        }
        
        #sharedDisconnectedOverlay > div {
          margin-left: 0 !important;
          width: 100% !important;
          justify-content: center !important;
        }
        
        #sharedDisconnectedOverlay button {
          flex: 1 !important;
          min-width: 80px !important;
          padding: 8px 12px !important;
          font-size: 13px !important;
        }
      }

      @media (max-width: 480px) {
        #sharedDisconnectedOverlay {
          font-size: 13px !important;
          padding: 10px !important;
        }
        
        #sharedDisconnectedOverlay button {
          font-size: 12px !important;
          padding: 6px 10px !important;
        }
        
        /* Extra small mobile - even more aggressive sizing */
        #noStreamDetails, #connectedNoStreamDetails, #roomFullDetails {
          font-size: 11px !important;
          max-width: calc(100vw - 10px) !important;
          width: calc(100vw - 10px) !important;
          padding: 8px !important;
        }
        
        #noStreamDetails button, #connectedNoStreamDetails button, #roomFullDetails button {
          font-size: 9px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          width: auto !important;
        }
        
        #noStreamDetails button i, #connectedNoStreamDetails button i, #roomFullDetails button i {
          font-size: 7px !important;
        }
        
        #getHelpLink {
          font-size: 9px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          width: auto !important;
        }
        
        #getHelpLink i {
          font-size: 7px !important;
        }
        
        .placeholder {
          padding: 10px 5px !important;
          max-width: calc(100vw - 10px) !important;
          width: calc(100vw - 10px) !important;
        }
        
        .placeholder i {
          font-size: 2rem !important;
        }
        
        .placeholder p {
          font-size: 0.8rem !important;
        }
        
        .placeholder .btn {
          font-size: 9px !important;
          padding: 3px 6px !important;
          max-width: 150px !important;
          width: auto !important;
        }
        
        .placeholder .btn i {
          font-size: 7px !important;
        }
        
      }

      /* Fullscreen exit button styles */
      #fullscreenExitBtn {
        display: none !important;
      }
      
      #fullscreenExitBtn.show {
        display: flex !important;
      }
      
      /* RESPONSIVE NOTIFICATION SYSTEM - HIGHEST PRIORITY */
      /* Override all previous notification styles with compact sizing */
      .placeholder #noStreamDetails, 
      .placeholder #connectedNoStreamDetails, 
      .placeholder #roomFullDetails {
        font-size: clamp(10px, 2vw, 15px) !important;
        max-width: 95% !important;
        width: auto !important;
        padding: clamp(6px, 1.5vw, 15px) !important;
        margin: 0.3rem auto !important;
        text-align: center !important;
        line-height: 1.3 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        box-sizing: border-box !important;
      }
      
      /* Responsive text elements */
      .placeholder #noStreamDetails div, 
      .placeholder #connectedNoStreamDetails div, 
      .placeholder #roomFullDetails div {
        font-size: inherit !important;
        line-height: 1.3 !important;
        margin-bottom: clamp(5px, 1.5vw, 10px) !important;
      }
      
      .placeholder #noStreamDetails strong, 
      .placeholder #connectedNoStreamDetails strong, 
      .placeholder #roomFullDetails strong {
        font-size: clamp(11px, 2.2vw, 16px) !important;
      }
      
      /* Stream ID styling */
      .placeholder #noStreamDetails span[style*="monospace"], 
      .placeholder #connectedNoStreamDetails span[style*="monospace"], 
      .placeholder #roomFullDetails span[style*="monospace"] {
        font-size: clamp(12px, 2.4vw, 17px) !important;
        display: block !important;
        margin-top: 0.2rem !important;
        word-break: break-all !important;
      }
      
      /* Responsive buttons - more compact */
      .placeholder #noStreamDetails button, 
      .placeholder #connectedNoStreamDetails button, 
      .placeholder #roomFullDetails button {
        font-size: clamp(9px, 1.8vw, 13px) !important;
        padding: clamp(4px, 1vw, 8px) clamp(8px, 2vw, 16px) !important;
        max-width: 95% !important;
        width: auto !important;
        margin: 0.25rem auto !important;
        white-space: normal !important;
        line-height: 1.2 !important;
        height: auto !important;
        min-height: clamp(28px, 5vw, 36px) !important;
        box-sizing: border-box !important;
        display: block !important;
      }
      
      /* Responsive button icons - smaller */
      .placeholder #noStreamDetails button i, 
      .placeholder #connectedNoStreamDetails button i, 
      .placeholder #roomFullDetails button i {
        font-size: clamp(10px, 2vw, 14px) !important;
        margin-right: 0.3rem !important;
      }
      
      /* Get Help link styling - more compact */
      .placeholder #getHelpLink {
        font-size: clamp(8px, 1.6vw, 12px) !important;
        padding: clamp(3px, 0.8vw, 6px) clamp(6px, 1.5vw, 12px) !important;
        display: inline-block !important;
        margin-top: 0.3rem !important;
        max-width: 95% !important;
        white-space: normal !important;
        box-sizing: border-box !important;
      }
      
      .placeholder #getHelpLink i {
        font-size: clamp(9px, 1.8vw, 13px) !important;
        margin-right: 0.3rem !important;
      }
      
      /* Extra compact for very small screens */
      @media (max-width: 576px) {
        .placeholder #noStreamDetails, 
        .placeholder #connectedNoStreamDetails, 
        .placeholder #roomFullDetails {
          padding: clamp(4px, 1vw, 10px) !important;
          max-width: 98% !important;
          font-size: clamp(9px, 1.8vw, 13px) !important;
        }
        
        .placeholder #noStreamDetails button, 
        .placeholder #connectedNoStreamDetails button, 
        .placeholder #roomFullDetails button {
          font-size: clamp(8px, 1.6vw, 11px) !important;
          padding: clamp(3px, 0.8vw, 6px) clamp(6px, 1.5vw, 12px) !important;
          min-height: clamp(24px, 4vw, 32px) !important;
        }
      }
      
      /* Ensure container can accommodate content */
      #videoContainer .placeholder {
        overflow: visible !important;
        padding: clamp(10px, 2vw, 20px) !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
      }
    </style>

    <!-- Eruda Mobile Console for debugging -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script> -->
  </head>
  <body>
    <!-- Hidden elements required by client.js -->
    <input type="hidden" id="roomIdInput" />
    <input type="hidden" id="roomIdInputMobile" />
    <button type="button" id="leaveBtn" style="display: none;" onclick="leaveRoom()"></button>
    
    <!-- Toast notification for room ID validation -->
    <div id="roomIdToast"></div>

    <!-- Toast notification for coordinates copied -->
    <div id="coordsCopiedToast"></div>

    <!-- Coordinate dialog modal -->
    <div id="coordinateDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="hideCoordinateDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        color: white;
      " onclick="event.stopPropagation()">
        <div style="margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
            <span style="font-weight: 500;">üåê Location:</span>
            <span id="dialogLocation" class="font-monospace" style="flex: 1;">Waiting for location data...</span>
            <button onclick="copyLocationCoordinates()" style="
              background-color: #465373;
              color: white;
              border: none;
              padding: 6px 12px;
              border-radius: 4px;
              cursor: pointer;
              font-size: 13px;
              white-space: nowrap;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-clipboard"></i> Copy
            </button>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüè† Altitude (home):</span>
            <span id="dialogAltHome" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüåä Altitude (sea level):</span>
            <span id="dialogAltSea" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">‚Üëüõ∞Ô∏è Altitude (GPS/Ellipsoid):</span>
            <span id="dialogAltEllipsoid" class="font-monospace">N/A</span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight: 500;">üß≠ Bearing:</span>
            <span id="dialogBearing" class="font-monospace">N/A</span>
          </div>
          <div>
            <span style="font-weight: 500;">üîã Battery:</span>
            <span id="dialogBattery" class="font-monospace">N/A</span>
          </div>
        </div>
        <button onclick="hideCoordinateDialog()" style="
          background-color: #465373;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
          width: 100%;
        " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
          OK
        </button>
      </div>
    </div>

    <!-- Viewer info input dialog modal -->
    <div id="viewerInfoDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    ">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Join Stream</h5>
          <p style="margin: 8px 0 0 0; font-size: 0.9rem; color: #aaa;">Enter your information (optional)</p>
        </div>
        <form id="viewerInfoForm" style="padding: 20px;">
          <div style="margin-bottom: 15px;">
            <label for="viewerNameInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Name</label>
            <input type="text" id="viewerNameInput" placeholder="Your name"
              minlength="3"
              maxlength="100"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <div style="margin-bottom: 20px;">
            <label for="viewerEmailInput" style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Email</label>
            <input type="email" id="viewerEmailInput" placeholder="your.email@example.com"
              style="
              width: 100%;
              padding: 10px;
              background-color: #1a1a1a;
              border: 1px solid #444;
              border-radius: 4px;
              color: white;
              font-size: 14px;
              box-sizing: border-box;
            " />
          </div>
          <button type="submit" id="confirmJoinBtn" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Join Stream
          </button>
        </form>
      </div>
    </div>

    <!-- Viewer list dialog modal -->
    <div id="viewerListDialog" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    " onclick="if(window.viewer) window.viewer.hideViewerListDialog()">
      <div style="
        background-color: #2c2c2c;
        border-radius: 8px;
        padding: 0;
        max-width: 400px;
        width: 90%;
        color: white;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      " onclick="event.stopPropagation()">
        <div style="padding: 20px; border-bottom: 1px solid #444;">
          <h5 style="margin: 0; font-size: 1.1rem;">Viewers</h5>
        </div>
        <div id="viewerListContainer" style="
          flex: 1;
          overflow-y: auto;
        ">
          <!-- Populated by JavaScript -->
        </div>
        <div style="padding: 15px; border-top: 1px solid #444;">
          <button onclick="if(window.viewer) window.viewer.hideViewerListDialog()" style="
            background-color: #465373;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
          " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="https://www.eagleeyessearch.com/">
          <img src="{{ '/images/eagle-eyes-beta-logo-new.png' | relative_url }}" alt="Eagle Eyes Beta Logo" style="height: 40px; margin-right: 10px; border-radius: 6px;">
          <span>Eagle Eyes Livestream Viewer</span>
        </a>

        <button
          id="fullscreenBtn"
          class="btn btn-outline-light btn-sm me-3"
          onclick="toggleFullscreen()"
          title="Toggle Fullscreen"
        >
          <i class="bi bi-fullscreen"></i>
        </button>

        <div
          id="status"
          class="status d-flex align-items-center text-white ms-auto me-2"
        >
          <span class="status-dot"></span>
          <span class="status-text small"></span>
        </div>

        <button
          id="mobileShareBtn"
          class="btn btn-outline-light btn-sm me-2"
          data-bs-toggle="modal"
          data-bs-target="#shareModal"
          title="Share Stream"
          style="display: none;"
        >
          <i class="bi bi-share"></i>
        </button>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#mobileControls"
          aria-controls="mobileControls"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse">
          <div class="d-flex align-items-center ms-auto">
            <button
              id="caltopoBtn"
              class="btn me-3"
              style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.5rem 0.75rem;"
              onclick="openCaltopoMap()"
              title="Open CalTopo Map"
            >
              <div style="font-size: 0.85rem; white-space: nowrap;">View <span id="caltopoMapName"></span> on</div>
              <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto;">
            </button>

            <div class="btn-group me-3" role="group">
              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="split-view"
                autocomplete="off"
                checked
              />
              <label
                class="btn btn-outline-secondary"
                for="split-view"
                title="Split View"
                ><i class="bi bi-layout-split"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="video-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="video-only"
                title="Video Only"
                ><i class="bi bi-camera-video"></i
              ></label>

              <input
                type="radio"
                class="btn-check"
                name="view-mode"
                id="map-only"
                autocomplete="off"
              />
              <label
                class="btn btn-outline-secondary"
                for="map-only"
                title="Map Only"
                ><i class="bi bi-map"></i
              ></label>
            </div>

            <div class="dropdown me-3">
              <button
                class="btn dropdown-toggle"
                type="button"
                id="historyDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                title="History"
                style="border-color: #b0b0b0; color: #b0b0b0;"
              >
                <i class="bi bi-clock-history"></i>
              </button>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="historyDropdown"
                style="min-width: 300px;"
              >
                <li><h6 class="dropdown-header">History</h6></li>
                <li>
                  <div id="historyList" class="text-muted text-center px-3">
                    No recent streams
                  </div>
                </li>
              </ul>
            </div>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              title="Connect to a Stream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-box-arrow-in-right"></i>
            </button>

            <button
              class="btn me-3"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#shareModal"
              title="Share Livestream"
              style="background-color: #314268; border-color: #314268; color: white;"
            >
              <i class="bi bi-share"></i>
            </button>

            <button
              class="btn me-3 d-none d-lg-inline-block"
              type="button"
              id="leaveBtnDesktop"
              onclick="leaveRoom()"
              title="Disconnect"
              style="background-color: #dc3545; border-color: #dc3545; color: white;"
              disabled
            >
              <i class="bi bi-stop-fill"></i>
            </button>

            <div class="text-white me-3" style="cursor: pointer;" onclick="if(window.viewer) window.viewer.showViewerListDialog()" title="View viewer list">
              <i class="bi bi-people"></i> <span id="viewerCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Connect to Stream Modal -->
    <div class="modal fade" id="joinModal" tabindex="-1" aria-labelledby="joinModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="joinModalLabel">Connect to a Stream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Manual Stream ID Entry -->
            <div class="mb-4">
              <label for="modalRoomIdInput" class="form-label">Enter Stream ID</label>
              <div class="input-group">
                <input
                  type="text"
                  id="modalRoomIdInput"
                  class="form-control"
                  placeholder="Stream ID"
                  list="streamHistoryDatalist"
                />
                <datalist id="streamHistoryDatalist">
                  <!-- Populated dynamically by JavaScript -->
                </datalist>
                <button
                  class="btn"
                  type="button"
                  onclick="joinRoomFromModal()"
                  style="background-color: #314268; border-color: #314268; color: white;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect
                </button>
              </div>
            </div>

            <!-- Divider -->
            <div class="text-center text-muted mb-4">
              <hr class="my-2">
              <small>Or</small>
              <hr class="my-2">
            </div>

            <!-- QR Code Scanner -->
            <div class="text-center">
              <h6 class="mb-3">Scan a QR Code on this device</h6>
              <div id="qrScannerContainer" style="display: none; margin: 0 auto;">
                <div id="qrReader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                <div id="qrScanResult" class="mt-2 text-success"></div>
              </div>
              <button
                id="activateCameraBtn"
                class="btn btn-primary w-100"
                type="button"
                onclick="activateQRScanner()"
              >
                <i class="bi bi-camera"></i> Activate Camera
              </button>
              <button
                id="stopCameraBtn"
                class="btn btn-danger w-100 mt-2"
                type="button"
                onclick="stopQRScanner()"
                style="display: none;"
              >
                <i class="bi bi-camera-video-off"></i> Stop Camera
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="shareModalLabel">Share Livestream</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <p class="mb-3">Scan the QR code to view this livestream on another device</p>
            <div id="qrcode" class="d-flex justify-content-center mb-3" style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 0 auto;"></div>
            <button class="btn btn-primary w-100 mb-3" onclick="shareLivestream()">
              <i class="bi bi-share"></i> Share Livestream Link
            </button>
            <div class="text-muted small">
              <div class="mb-1">Or</div>
              <div class="mb-2">Share this Stream ID for others to enter in <i class="bi bi-box-arrow-in-right"></i> "Connect to a Stream":</div>
              <div class="font-monospace text-white fs-5" id="modalRoomId" onclick="copyRoomId()" style="cursor: pointer; user-select: all;" title="Click to copy">-</div>
              <div id="roomIdCopiedMessage" style="color: #28a745; font-size: 12px; margin-top: 8px; display: none;">Copied to clipboard</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification - Below share button -->
    <div class="toast-container position-fixed" id="toastContainer" style="display: none;">
      <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true" style="width: auto; min-width: fit-content;">
        <div class="d-flex align-items-center justify-content-center">
          <div class="toast-body text-center" style="padding: 8px 16px;">
            <i class="bi bi-check-circle"></i> URL copied to clipboard
          </div>
          <button type="button" class="btn-close btn-close-white me-2" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

    <!-- Mobile Offcanvas Sidebar -->
    <div
      class="offcanvas offcanvas-start bg-dark text-white"
      tabindex="-1"
      id="mobileControls"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Eagle Eyes Livestream Viewer</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="offcanvas-body">
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#joinModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
            </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn" data-bs-toggle="modal" data-bs-target="#shareModal" style="background-color: #314268; border-color: #314268; color: white;">
            <i class="bi bi-share"></i> Share Livestream
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="leaveBtnMobile"
            class="btn btn-dark"
            onclick="leaveRoom()"
            disabled
          >
            <i class="bi bi-stop-fill"></i> Disconnect
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="viewersBtnMobile"
            class="btn btn-dark"
            style="padding: 0.5rem 0.75rem;"
            onclick="if(window.viewer) window.viewer.showViewerListDialog()"
            title="Show Viewers"
          >
            <i class="bi bi-people-fill"></i> Viewers (<span id="viewerCountMobile">0</span>)
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button
            id="caltopoBtnMobile"
            class="btn"
            style="display: none; flex-direction: column; align-items: center; gap: 0.25rem; border: 1px solid #cc5e31; color: #cc5e31; background-color: transparent; padding: 0.5rem 0.75rem;"
            onclick="openCaltopoMap()"
            title="Open CalTopo Map"
          >
            <div style="font-size: 0.85rem;">View <span id="caltopoMapNameMobile"></span> on</div>
            <img src="{{ '/images/livestream/caltopo-full-logo.svg' | relative_url }}" alt="CalTopo" style="height: 18px; width: auto;">
          </button>
        </div>
        <hr />
        <h6>View Mode</h6>
        <div class="btn-group w-100 mb-3" role="group">
          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="split-view-mobile"
            autocomplete="off"
            checked
          />
          <label class="btn btn-outline-secondary" for="split-view-mobile"
            >Split</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="video-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="video-only-mobile"
            >Video</label
          >

          <input
            type="radio"
            class="btn-check"
            name="view-mode-mobile"
            id="map-only-mobile"
            autocomplete="off"
          />
          <label class="btn btn-outline-secondary" for="map-only-mobile"
            >Map</label
          >
        </div>
        
        <div class="d-grid gap-2 mb-3">
          <button id="pipBtn" class="btn btn-outline-secondary" onclick="togglePictureInPicture()">
            <i class="bi bi-picture-in-picture"></i> Picture-in-Picture
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button class="btn btn-secondary" onclick="centerOnDrone()">
            <i class="bi bi-bullseye"></i> Center on Drone
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button id="showMyLocationBtn" class="btn btn-outline-secondary" onclick="toggleMyLocation()">
            <i class="bi bi-geo-alt"></i> Show My Location
          </button>
        </div>
        <div class="d-grid gap-2 mb-3">
          <button id="showLaserBtn" class="btn btn-outline-secondary" onclick="toggleLaserRangeFinder()">
            <i class="bi bi-bullseye"></i> Display Laser Range Finder Location
          </button>
        </div>
        <hr />
        <h6>History</h6>
        <div class="mb-3">
          <div id="historyListMobile" class="text-muted text-center">
            No recent streams
          </div>
        </div>
        <hr />
        <p>
          <strong>Stream:</strong> <span id="roomIdDisplay">Not connected</span>
        </p>
        <p>
          <strong>Connection:</strong>
          <span id="connectionStatus">Disconnected</span>
        </p>
        <strong>Coordinates:</strong>
        <p
          id="coordinateDisplay"
          class="bg-black px-2 py-1 rounded font-monospace small"
        >
          Waiting for location data...
        </p>
      </div>
    </div>

    <main id="main-content" class="row g-0" style="position: relative;">
      <!-- Shared disconnected overlay -->
      <div id="sharedDisconnectedOverlay" style="
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        z-index: 1040;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        display: none;
        align-items: center;
        gap: 8px;
        width: fit-content;
        white-space: nowrap;
        max-width: calc(100vw - 20px);
      ">
        <i class="bi bi-wifi-off"></i>
        <span>Stream disconnected. Attempting to reconnect...</span>
        <div style="display: flex; gap: 6px; margin-left: 8px; flex-wrap: wrap;">
          <button onclick="if(window.viewer) window.viewer.retryConnection()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
          color: white;
            font-size: 12px;
            font-weight: 600;
          cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            min-width: 60px;
          " title="Try to reconnect now" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Try Again
          </button>
          <button onclick="if(window.viewer) window.viewer.closeStream()" style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 4px;
            white-space: nowrap;
            min-width: 60px;
          " title="Close this stream" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.3)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.2)'">
            Close this stream
        </button>
        </div>
      </div>

      <!-- Fullscreen exit button (hidden by default) -->
      <div id="fullscreenExitBtn" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        padding: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition: all 0.3s ease;
        width: 48px;
        height: 48px;
        align-items: center;
        justify-content: center;
        text-align: center;
      " onclick="toggleFullscreen()" title="Exit Fullscreen" onmouseover="this.style.backgroundColor='rgba(0,0,0,0.8)'" onmouseout="this.style.backgroundColor='rgba(0,0,0,0.7)'">
        <i class="bi bi-fullscreen-exit"></i>
      </div>

      <!-- Connection failed overlay -->
      <div id="connectionFailedOverlay" style="
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(220, 53, 69, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1050;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        display: none;
        flex-direction: column;
        gap: 8px;
        max-width: 90%;
        width: auto;
      ">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i class="bi bi-exclamation-triangle-fill" style="font-size: 16px;"></i>
          <span style="font-weight: 600;">Connection Failed</span>
          <button onclick="hideConnectionFailedMessage()" style="
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin: 0 0 0 auto;
            line-height: 1;
            opacity: 0.9;
            display: flex;
            align-items: center;
          " title="Dismiss">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div style="font-size: 12px; font-weight: 400; line-height: 1.4; opacity: 0.95;">
          Streaming may not work on mobile data unless you're connected to the same hotspot. VPNs can also cause connection issues.
        </div>
      </div>

      <div id="video-panel" class="col-lg-8">
        <div id="coordinateStripContainer" class="bg-dark text-white px-2 py-1 border-top border-secondary" style="flex: 0 0 auto; display: none;" onclick="showCoordinateDialog()">
          <div
            id="coordinateStrip"
            class="font-monospace small"
            style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
          >
            Waiting for location data...
          </div>
        </div>
        <div id="videoContainer">
          <div class="placeholder">
            <i class="bi bi-camera-video-off" style="font-size: 5rem"></i>
            <p id="placeholderTitle">No video stream</p>
            <button
              id="placeholderConnectBtn"
              class="btn btn-lg"
              data-bs-toggle="modal"
              data-bs-target="#joinModal"
              style="background-color: #314268; border-color: #314268; color: white; padding: 12px 24px; font-weight: 500; margin-top: 1rem;"
              onmouseover="this.style.backgroundColor='#3d5282'"
              onmouseout="this.style.backgroundColor='#314268'"
            >
              <i class="bi bi-box-arrow-in-right"></i> Connect to a Stream
            </button>
            <div id="connectingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="connectingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Connecting...</span>
                </div>
                Attempting to connect to <span id="connectingRoomIdInline" style="font-family: monospace; color: #ffc107;"></span>...
              </div>
              <div id="connectingTimeoutWarning" style="display: none; margin-top: 0.5rem; font-size: 0.9em; line-height: 1.4; color: #ffc107;">
                This is taking longer than expected. Check your internet connection.
              </div>
            </div>
            <div id="videoLoadingDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="videoLoadingRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                <div class="spinner-border spinner-border-sm text-primary" role="status" style="margin-right: 0.5rem;">
                  <span class="visually-hidden">Loading video...</span>
                </div>
                Found stream, attempting to load video...
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="connectedNoStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="noDataRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                You've connected to the stream but video is not loading. This is likely due to your internet connection type (some mobile data plans do not allow P2P streaming). Try switching to WiFi or share this stream with a device on a different connection.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  id="connectedNoStreamRetryBtn"
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn btn-primary w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#shareModal"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-share"></i> Share Livestream
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="noStreamDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="attemptedRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load this stream. The publisher may have stopped streaming, or the Stream ID may have been mistyped.
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <div id="roomFullDetails" style="display: none; margin-top: 1rem; max-width: 550px; width: 90%; padding: 0 15px;">
              <div style="margin-bottom: 1rem; word-break: break-all; color: #d1d5db;">
                <strong>Stream ID:</strong> <span id="roomFullRoomId" style="font-family: monospace; font-size: 1.1em; color: #ffc107;"></span>
              </div>
              <div style="margin-bottom: 1rem; font-size: 0.95em; line-height: 1.5; color: #d1d5db;">
                Unable to load stream: Streams are limited to 3 viewers to avoid network congestion. Ask other viewers to disconnect
              </div>
              <div style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <button
                  class="btn btn-warning w-100"
                  onclick="window.viewer.retryConnection()"
                  style="padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-arrow-clockwise"></i> Retry Connection
                </button>
                <button
                  class="btn w-100"
                  data-bs-toggle="modal"
                  data-bs-target="#joinModal"
                  style="background-color: #314268; border-color: #314268; color: white; padding: 10px 20px; font-weight: 500; max-width: 300px;"
                >
                  <i class="bi bi-box-arrow-in-right"></i> Connect to Another Stream
                </button>
              </div>
            </div>

            <a id="getHelpLink" href="https://www.eagleeyessearch.com/faq?query=livestreaming" target="_blank" style="
              margin-top: 1rem;
              display: inline-block;
              background-color: #465373;
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              font-size: 14px;
              font-weight: 500;
              transition: background-color 0.2s;
            " onmouseover="this.style.backgroundColor='#556382'" onmouseout="this.style.backgroundColor='#465373'">
              <i class="bi bi-question-circle"></i> Get Help
            </a>
          </div>
          <video id="remoteVideo" autoplay playsinline muted controls></video>
        </div>
      </div>
      <div id="map-panel" class="col-lg-4">
        <div id="map"></div>
      </div>
    </main>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{{ '/js/livestream/map.js' | relative_url }}"></script>
    <script src="{{ '/js/livestream/client.js' | relative_url }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const videoPanel = document.getElementById("video-panel");
        const mapPanel = document.getElementById("map-panel");

        function setViewMode(mode) {
          const coordStrip = document.getElementById("coordinateStripContainer");
          const remoteVideo = document.getElementById("remoteVideo");

          if (mode === "video") {
            // Video fullscreen mode - always use cover to fill space
            videoPanel.className = "col-12 full-view";
            mapPanel.className = "d-none";
            if (remoteVideo) remoteVideo.style.objectFit = "cover";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
          } else if (mode === "map") {
            // Map fullscreen mode
            videoPanel.className = "d-none";
            mapPanel.className = "col-12 full-view";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-none";
          } else {
            // Split view mode - restore optimized proportions
            videoPanel.className = "col-lg-8"; // Will be overridden by CSS classes if photo mode
            mapPanel.className = "col-lg-4";
            if (coordStrip) coordStrip.className = "bg-dark text-white px-2 py-1 border-top border-secondary d-flex";
            
            // Re-run optimization to apply correct fitting and proportions
            setTimeout(() => optimizeVideoFitting(), 100);
          }
          if (window.droneMap) {
            setTimeout(() => window.droneMap.resize(), 150);
          } else {
            // Initialize map if not already done
            setTimeout(() => {
              if (window.initMap) {
                window.initMap();
              }
              if (window.droneMap && window.droneMap.resize) {
                window.droneMap.resize();
              }
            }, 200);
          }
        }

        // Function to optimize video fitting based on actual drone modes
        function optimizeVideoFitting() {
          const remoteVideo = document.getElementById("remoteVideo");
          const videoPanel = document.getElementById("video-panel");
          const mapPanel = document.getElementById("map-panel");
          
          if (!remoteVideo || !remoteVideo.videoWidth || !remoteVideo.videoHeight) return;
          
          const videoWidth = remoteVideo.videoWidth;
          const videoHeight = remoteVideo.videoHeight;
          const videoAspectRatio = videoWidth / videoHeight;
          const containerWidth = videoPanel.clientWidth;
          const containerHeight = videoPanel.clientHeight;
          const containerAspectRatio = containerWidth / containerHeight;
          
          console.log(`Video resolution: ${videoWidth}x${videoHeight} (${videoAspectRatio.toFixed(2)}:1)`);
          console.log(`Container: ${containerWidth}x${containerHeight} (${containerAspectRatio.toFixed(2)}:1)`);
          console.log(`Window: ${window.innerWidth}x${window.innerHeight}`);
          
          // Detect video mode vs photo mode based on resolution
          const isVideoMode = (videoWidth === 1920 && videoHeight === 1080);
          const isPhotoMode = (videoWidth > 1920 || videoHeight > 1080);
          const isSplitView = !videoPanel.classList.contains('full-view') && !mapPanel.classList.contains('full-view');
          
          // Remove existing mode classes and custom sizing
          videoPanel.classList.remove('photo-mode', 'dynamic-sized');
          mapPanel.classList.remove('photo-mode', 'dynamic-sized');
          videoPanel.style.flexBasis = '';
          mapPanel.style.flexBasis = '';
          
          if (isVideoMode) {
            console.log("Detected: Video Mode (1920x1080)");
            // Video mode: 16:9 aspect ratio, use contain to show full video
            remoteVideo.style.objectFit = "contain";
            
            // Check if video mode has black bars due to container aspect ratio mismatch
            if (isSplitView && containerAspectRatio < 1.5) { // Container is too tall for 16:9 video
              console.log("Video mode with black bars detected - optimizing layout");
              
              // Calculate effective video dimensions for 16:9 video in this container
              const effectiveWidth = containerHeight * (16/9); // 16:9 aspect ratio
              const totalScreenWidth = window.innerWidth;
              const videoPanelWidthPercent = (effectiveWidth / totalScreenWidth) * 100;
              
              console.log(`Effective 16:9 video width: ${effectiveWidth.toFixed(0)}px`);
              console.log(`Optimized video panel: ${videoPanelWidthPercent.toFixed(1)}%`);
              
              // Apply dynamic sizing to eliminate black bars
              videoPanel.style.flexBasis = `${videoPanelWidthPercent}%`;
              mapPanel.style.flexBasis = `${100 - videoPanelWidthPercent}%`;
              videoPanel.classList.add('dynamic-sized');
              mapPanel.classList.add('dynamic-sized');
            }
          } else if (isPhotoMode && isSplitView) {
            console.log("Detected: Photo/Camera Mode (High Resolution) - Split View");
            // Photo mode in split view: calculate effective dimensions to eliminate black bars
            remoteVideo.style.objectFit = "contain";
            
            // Calculate effective video dimensions within container
            let effectiveWidth, effectiveHeight;
            
            if (videoAspectRatio > containerAspectRatio) {
              // Video is wider than container - limited by width
              effectiveWidth = containerWidth;
              effectiveHeight = containerWidth / videoAspectRatio;
            } else {
              // Video is taller than container - limited by height  
              effectiveHeight = containerHeight;
              effectiveWidth = containerHeight * videoAspectRatio;
            }
            
            // Calculate optimal panel sizing based on screen orientation
            const isMobile = window.innerWidth <= 991;
            const isLandscape = window.innerWidth > window.innerHeight;
            
            if (isMobile && !isLandscape) {
              // Mobile portrait: optimize vertical stacking
              const totalScreenHeight = window.innerHeight - 120; // Account for navbar
              const videoPanelHeightPercent = (effectiveHeight / totalScreenHeight) * 100;
              
              console.log(`Mobile portrait - Effective video: ${effectiveWidth.toFixed(0)}x${effectiveHeight.toFixed(0)}`);
              console.log(`Video panel height: ${videoPanelHeightPercent.toFixed(1)}%`);
              
              // Apply vertical sizing for mobile
              videoPanel.style.flexBasis = `${videoPanelHeightPercent}%`;
              mapPanel.style.flexBasis = `${100 - videoPanelHeightPercent}%`;
            } else {
              // Desktop or mobile landscape: optimize horizontal layout
              const totalScreenWidth = window.innerWidth;
              const videoPanelWidthPercent = (effectiveWidth / totalScreenWidth) * 100;
              
              console.log(`Desktop/landscape - Effective video: ${effectiveWidth.toFixed(0)}x${effectiveHeight.toFixed(0)}`);
              console.log(`Video panel: ${videoPanelWidthPercent.toFixed(1)}%, Map panel: ${(100 - videoPanelWidthPercent).toFixed(1)}%`);
              
              // Apply horizontal sizing
              videoPanel.style.flexBasis = `${videoPanelWidthPercent}%`;
              mapPanel.style.flexBasis = `${100 - videoPanelWidthPercent}%`;
            }
            
            videoPanel.classList.add('dynamic-sized');
            mapPanel.classList.add('dynamic-sized');
            
          } else if (isPhotoMode) {
            console.log("Detected: Photo/Camera Mode (High Resolution) - Fullscreen");
            // Photo mode in fullscreen: use cover to fill space
            remoteVideo.style.objectFit = "cover";
          } else {
            console.log("Unknown mode - using fallback");
            // Fallback: use container aspect ratio comparison
            if (videoAspectRatio > containerAspectRatio * 1.2) {
              remoteVideo.style.objectFit = "cover";
            } else {
              remoteVideo.style.objectFit = "contain";
            }
          }
          
          // Trigger map resize after layout changes
          if (window.droneMap) {
            setTimeout(() => window.droneMap.resize(), 100);
          }
        }

        // Make optimization function globally accessible for debugging
        window.optimizeVideoFitting = optimizeVideoFitting;
        window.manualOptimize = () => {
          console.log("Manual optimization triggered...");
          optimizeVideoFitting();
        };

        // Monitor video load and resize events
        const remoteVideo = document.getElementById("remoteVideo");
        if (remoteVideo) {
          remoteVideo.addEventListener("loadedmetadata", () => {
            console.log("Video metadata loaded, running optimization...");
            setTimeout(optimizeVideoFitting, 500); // Delay to ensure container is sized
          });
          remoteVideo.addEventListener("resize", () => {
            console.log("Video resized, running optimization...");
            setTimeout(optimizeVideoFitting, 100);
          });
          window.addEventListener("resize", optimizeVideoFitting);
          
          // Also run optimization when view mode changes
          document.querySelectorAll('input[name="view-mode"], input[name="view-mode-mobile"]').forEach(radio => {
            radio.addEventListener("change", () => {
              console.log("View mode changed, running optimization...");
              setTimeout(optimizeVideoFitting, 200);
            });
          });
        }

        document
          .querySelectorAll('input[name="view-mode"]')
          .forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only", "")
                .replace("-view", "");
              setViewMode(mode);
              
              // Save to localStorage
              localStorage.setItem('livestream_view_mode', mode);
              console.log('View mode saved to localStorage:', mode);
              
              // Sync mobile radios
              const mobileRadio = document.getElementById(mode + "-view-mobile");
              if (mobileRadio) mobileRadio.checked = true;
            });
          });
        document
          .querySelectorAll('input[name="view-mode-mobile"]')
          .forEach((radio) => {
            radio.addEventListener("change", (e) => {
              const mode = e.target.id
                .replace("-only-mobile", "")
                .replace("-view-mobile", "");
              setViewMode(mode);
              
              // Save to localStorage
              localStorage.setItem('livestream_view_mode', mode);
              console.log('View mode saved to localStorage:', mode);
              
              // Sync desktop radios
              const desktopRadio = document.getElementById(mode + "-view");
              if (desktopRadio) desktopRadio.checked = true;
            });
          });

        // Initialize with the currently selected view mode on page load
        setTimeout(() => {
          // Check which radio button is selected and apply that view mode
          const splitViewRadio = document.getElementById('split-view');
          const videoViewRadio = document.getElementById('video-only');
          const mapViewRadio = document.getElementById('map-only');
          
          // Also check mobile radio buttons
          const splitViewMobileRadio = document.getElementById('split-view-mobile');
          const videoViewMobileRadio = document.getElementById('video-only-mobile');
          const mapViewMobileRadio = document.getElementById('map-only-mobile');
          
          // Check if we have an active stream connected
          const hasActiveStream = window.viewer && window.viewer.isConnected && window.viewer.hasVideoStream;
          
          // Default to video mode when no stream, otherwise use stored preference
          let selectedMode = hasActiveStream ? 
            (localStorage.getItem('livestream_view_mode') || "split") : 
            "video";
          
          if (videoViewRadio && videoViewRadio.checked) {
            selectedMode = "video";
          } else if (mapViewRadio && mapViewRadio.checked) {
            selectedMode = "map";
          } else if (videoViewMobileRadio && videoViewMobileRadio.checked) {
            selectedMode = "video";
          } else if (mapViewMobileRadio && mapViewMobileRadio.checked) {
            selectedMode = "map";
          }
          
          // Ensure both desktop and mobile radio buttons are synced
          if (selectedMode === "split") {
            if (splitViewRadio) splitViewRadio.checked = true;
            if (splitViewMobileRadio) splitViewMobileRadio.checked = true;
          } else if (selectedMode === "video") {
            if (videoViewRadio) videoViewRadio.checked = true;
            if (videoViewMobileRadio) videoViewMobileRadio.checked = true;
          } else if (selectedMode === "map") {
            if (mapViewRadio) mapViewRadio.checked = true;
            if (mapViewMobileRadio) mapViewMobileRadio.checked = true;
          }
          
          console.log('Initializing with view mode:', selectedMode);
          setViewMode(selectedMode);
          
          // Ensure proper layout initialization
          const videoPanel = document.getElementById('video-panel');
          const mapPanel = document.getElementById('map-panel');
          const mainContent = document.getElementById('main-content');
          
          if (window.innerWidth <= 991) {
            // Mobile layout
            if (videoPanel && mapPanel) {
              // Apply proper classes based on selected mode
              if (selectedMode === "split") {
                videoPanel.classList.remove('d-none');
                mapPanel.classList.remove('d-none');
                videoPanel.classList.add('col-lg-8');
                mapPanel.classList.add('col-lg-4');
              } else if (selectedMode === "video") {
                videoPanel.classList.remove('d-none');
                mapPanel.classList.add('d-none');
              } else if (selectedMode === "map") {
                videoPanel.classList.add('d-none');
                mapPanel.classList.remove('d-none');
              }
            }
          } else {
            // Desktop layout - clear inline styles to let CSS handle it
            if (videoPanel && mapPanel && mainContent) {
              videoPanel.style.flex = '';
              videoPanel.style.width = '';
              mapPanel.style.flex = '';
              mapPanel.style.width = '';
              mainContent.style.flexDirection = '';
              console.log('Desktop mode - cleared inline styles for CSS control');
            }
          }
          
          // Always ensure map is visible and initialized
          if (window.droneMap && window.droneMap.map) {
            console.log('Map already initialized');
            // Ensure CalTopo objects are loaded even without GPS
            loadCalTopoObjects();
          } else {
            // Initialize map if not already done
            setTimeout(() => {
              if (window.initMap) {
                window.initMap();
              }
              if (window.droneMap && window.droneMap.resize) {
                window.droneMap.resize();
              }
              // Load CalTopo objects after map initialization
              setTimeout(() => {
                loadCalTopoObjects();
              }, 1000);
            }, 500);
          }
        }, 100);

        // Ensure split view is maintained when stream connects
        const originalJoinRoom = window.joinRoom;
        if (originalJoinRoom) {
          window.joinRoom = function() {
            const result = originalJoinRoom.apply(this, arguments);
            // Auto-switch to split view after stream connects (1 second delay)
            setTimeout(() => {
              // Check BOTH desktop and mobile radio buttons
              const splitViewRadio = document.getElementById('split-view');
              const videoViewRadio = document.getElementById('video-only');
              const mapViewRadio = document.getElementById('map-only');
              const splitViewMobileRadio = document.getElementById('split-view-mobile');
              const videoViewMobileRadio = document.getElementById('video-only-mobile');
              const mapViewMobileRadio = document.getElementById('map-only-mobile');
              
              let selectedMode = "split"; // default
              
              // Check which mode is selected (check both desktop and mobile)
              if ((videoViewRadio && videoViewRadio.checked) || (videoViewMobileRadio && videoViewMobileRadio.checked)) {
                selectedMode = "video";
              } else if ((mapViewRadio && mapViewRadio.checked) || (mapViewMobileRadio && mapViewMobileRadio.checked)) {
                selectedMode = "map";
              }
              
              // Ensure both desktop and mobile radio buttons are synced
              if (selectedMode === "split") {
                if (splitViewRadio) splitViewRadio.checked = true;
                if (splitViewMobileRadio) splitViewMobileRadio.checked = true;
              } else if (selectedMode === "video") {
                if (videoViewRadio) videoViewRadio.checked = true;
                if (videoViewMobileRadio) videoViewMobileRadio.checked = true;
              } else if (selectedMode === "map") {
                if (mapViewRadio) mapViewRadio.checked = true;
                if (mapViewMobileRadio) mapViewMobileRadio.checked = true;
              }
              
              // Always switch to split view after stream connects
              console.log('Stream connected - switching to split view');
              
              // Update radio buttons
              if (splitViewRadio) splitViewRadio.checked = true;
              if (splitViewMobileRadio) splitViewMobileRadio.checked = true;
              
              // Apply split view
              setViewMode("split");
              
              // Save preference
              localStorage.setItem('livestream_view_mode', 'split');
              
              // Force layout recalculation for mobile
              if (window.innerWidth <= 991) {
                const mainContent = document.getElementById('main-content');
                const videoPanel = document.getElementById('video-panel');
                const mapPanel = document.getElementById('map-panel');
                
                if (mainContent && videoPanel && mapPanel) {
                  // Force reapplication of mobile layout
                  mainContent.style.display = 'none';
                  setTimeout(() => {
                    mainContent.style.display = 'flex';
                    // Ensure both panels are visible in split view
                    if (splitViewRadio && splitViewRadio.checked) {
                      videoPanel.classList.remove('d-none');
                      mapPanel.classList.remove('d-none');
                    }
                  }, 100);
                }
              }
              
              // Load CalTopo objects after stream connects (regardless of GPS status)
              setTimeout(() => {
                loadCalTopoObjects();
              }, 1000);
            }, 1000);
            return result;
          };
        }
      });

      function centerOnDrone() {
        if (window.droneMap) window.droneMap.centerOnDrone();
      }

      function toggleFullscreen() {
        const navbar = document.querySelector('.navbar');
        const exitBtn = document.getElementById('fullscreenExitBtn');
        
        if (!document.fullscreenElement) {
          // Enter fullscreen
          document.documentElement.requestFullscreen().then(() => {
            // Hide the navbar when in fullscreen
            if (navbar) navbar.style.display = 'none';
            // Show the exit button
            if (exitBtn) exitBtn.classList.add('show');
            document.getElementById('fullscreenBtn').innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
            document.getElementById('fullscreenBtn').title = 'Exit Fullscreen';
          }).catch(err => {
            console.log('Error attempting to enable fullscreen:', err);
          });
        } else {
          // Exit fullscreen
          document.exitFullscreen().then(() => {
            // Show the navbar when exiting fullscreen
            if (navbar) navbar.style.display = 'flex';
            // Hide the exit button
            if (exitBtn) exitBtn.classList.remove('show');
            document.getElementById('fullscreenBtn').innerHTML = '<i class="bi bi-fullscreen"></i>';
            document.getElementById('fullscreenBtn').title = 'Toggle Fullscreen';
          }).catch(err => {
            console.log('Error attempting to exit fullscreen:', err);
          });
        }
      }


      function openCaltopoMap() {
        if (window.droneMap && window.droneMap.caltopoInfo) {
          const mapId = window.droneMap.caltopoInfo.map_id;
          if (mapId) {
            window.open(`https://caltopo.com/m/${mapId}`, '_blank');
          }
        }
      }

      function loadCalTopoObjects() {
        // Load CalTopo map objects regardless of GPS status
        if (window.droneMap && window.droneMap.map && window.droneMap.caltopoInfo) {
          const caltopoInfo = window.droneMap.caltopoInfo;
          console.log('Loading CalTopo objects:', caltopoInfo);
          
          // Show CalTopo button if map is available
          const caltopoBtn = document.getElementById('caltopoBtn');
          const caltopoBtnMobile = document.getElementById('caltopoBtnMobile');
          const caltopoMapName = document.getElementById('caltopoMapName');
          const caltopoMapNameMobile = document.getElementById('caltopoMapNameMobile');
          
          if (caltopoInfo.map_id) {
            if (caltopoBtn) {
              caltopoBtn.style.display = 'flex';
            }
            if (caltopoBtnMobile) {
              caltopoBtnMobile.style.display = 'flex';
            }
            if (caltopoMapName) {
              caltopoMapName.textContent = caltopoInfo.map_name || 'CalTopo Map';
            }
            if (caltopoMapNameMobile) {
              caltopoMapNameMobile.textContent = caltopoInfo.map_name || 'CalTopo Map';
            }
          }
          
          // Load CalTopo map layers if available
          if (caltopoInfo.layers && Array.isArray(caltopoInfo.layers)) {
            caltopoInfo.layers.forEach(layer => {
              if (layer.url && layer.name) {
                try {
                  const caltopoLayer = L.tileLayer(layer.url, {
                    attribution: 'CalTopo',
                    opacity: 0.7
                  });
                  caltopoLayer.addTo(window.droneMap.map);
                  console.log('Added CalTopo layer:', layer.name);
                } catch (error) {
                  console.error('Error adding CalTopo layer:', error);
                }
              }
            });
          }
          
          // Load CalTopo markers/objects if available
          if (caltopoInfo.markers && Array.isArray(caltopoInfo.markers)) {
            caltopoInfo.markers.forEach(marker => {
              if (marker.lat && marker.lon) {
                try {
                  const caltopoMarker = L.marker([marker.lat, marker.lon], {
                    icon: L.divIcon({
                      className: 'caltopo-marker',
                      html: `<div style="
                        width: 16px;
                        height: 16px;
                        background-color: #ff6b35;
                        border: 2px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                      "></div>`,
                      iconSize: [16, 16],
                      iconAnchor: [8, 8]
                    })
                  }).addTo(window.droneMap.map);
                  
                  if (marker.name) {
                    caltopoMarker.bindPopup(marker.name);
                  }
                  
                  console.log('Added CalTopo marker:', marker.name || 'Unnamed marker');
                } catch (error) {
                  console.error('Error adding CalTopo marker:', error);
                }
              }
            });
          }
        }
      }

      function hideDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function showDisconnectedMessage() {
        const overlay = document.getElementById('sharedDisconnectedOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function hideConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      function hideNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');

        if (placeholderTitle) placeholderTitle.style.display = 'block';
        if (placeholderConnectBtn) placeholderConnectBtn.style.display = 'inline-block';
        if (noStreamDetails) noStreamDetails.style.display = 'none';

        // Show map panel, coordinate strip, and restore normal layout when hiding notification
        const mapPanel = document.getElementById('map-panel');
        const videoPanel = document.getElementById('video-panel');
        const coordStripContainer = document.getElementById('coordinateStripContainer');
        if (mapPanel) mapPanel.style.display = 'block';
        if (videoPanel) videoPanel.classList.remove('col-12');
        if (coordStripContainer) coordStripContainer.style.display = 'flex';
      }

      function showNoStreamNotification() {
        const placeholderTitle = document.getElementById('placeholderTitle');
        const placeholderConnectBtn = document.getElementById('placeholderConnectBtn');
        const noStreamDetails = document.getElementById('noStreamDetails');
        const attemptedRoomId = document.getElementById('attemptedRoomId');

        // Get the current room ID from the viewer
        const roomId = window.viewer ? window.viewer.currentRoomId : null;

        if (roomId && noStreamDetails && placeholderConnectBtn && attemptedRoomId) {
          // Hide the title and connect button, show the no stream details
          if (placeholderTitle) placeholderTitle.style.display = 'none';
          placeholderConnectBtn.style.display = 'none';
          attemptedRoomId.textContent = roomId;
          noStreamDetails.style.display = 'block';

          // Hide map panel, coordinate strip, and expand video panel when unable to load stream
          const mapPanel = document.getElementById('map-panel');
          const videoPanel = document.getElementById('video-panel');
          const coordStripContainer = document.getElementById('coordinateStripContainer');
          if (mapPanel) mapPanel.style.display = 'none';
          if (videoPanel) videoPanel.classList.add('col-12');
          if (coordStripContainer) coordStripContainer.style.display = 'none';
        }
      }

      function showConnectionFailedMessage() {
        const overlay = document.getElementById('connectionFailedOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
        }
      }

      function showCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');

        // Get current location data from the viewer
        if (window.viewer && window.viewer.currentLocation) {
          const loc = window.viewer.currentLocation;

          // Format with N/S/E/W for display
          const latDir = loc.latitude >= 0 ? 'N' : 'S';
          const lonDir = loc.longitude >= 0 ? 'E' : 'W';
          const latFormatted = `${Math.abs(loc.latitude).toFixed(5)}¬∞${latDir}`;
          const lonFormatted = `${Math.abs(loc.longitude).toFixed(5)}¬∞${lonDir}`;

          document.getElementById('dialogLocation').textContent = `${latFormatted}, ${lonFormatted}`;
          // Store plain coordinates for copying
          document.getElementById('dialogLocation').setAttribute('data-plain', `${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`);

          document.getElementById('dialogAltHome').textContent =
            loc.altitude_ahl != null ? `${loc.altitude_ahl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltSea').textContent =
            loc.altitude_asl != null ? `${loc.altitude_asl.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogAltEllipsoid').textContent =
            loc.altitude_ellipsoid != null ? `${loc.altitude_ellipsoid.toFixed(1)}m` : 'N/A';

          document.getElementById('dialogBearing').textContent =
            `${loc.bearing.toFixed(1)}¬∞ from True North`;

          document.getElementById('dialogBattery').textContent =
            loc.battery_percent != null ? `${loc.battery_percent}%` : 'N/A';
        }

        if (dialog) {
          dialog.style.display = 'flex';
        }
      }

      function hideCoordinateDialog() {
        const dialog = document.getElementById('coordinateDialog');
        if (dialog) {
          dialog.style.display = 'none';
        }
      }

      function copyLocationCoordinates() {
        const locationElement = document.getElementById('dialogLocation');
        const plainText = locationElement.getAttribute('data-plain');
        navigator.clipboard.writeText(plainText).then(() => {
          const toast = document.getElementById('coordsCopiedToast');
          if (toast) {
            toast.textContent = `Copied '${plainText}' to clipboard`;
            toast.style.display = 'block';
            setTimeout(() => {
              toast.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy coordinates:', err);
        });
      }

      // Share functionality
      // Generate QR code when modal is shown
      const shareModal = document.getElementById('shareModal');
      shareModal.addEventListener('show.bs.modal', function () {
        // Always regenerate QR code to ensure it reflects current URL
        const qrcodeContainer = document.getElementById('qrcode');
        qrcodeContainer.innerHTML = ''; // Clear any existing QR code
        const currentUrl = window.location.href;

        // Only generate if there's a stream in the URL
        if (currentUrl.includes('?stream=') || currentUrl.includes('&stream=') ||
            currentUrl.includes('?room=') || currentUrl.includes('&room=')) {
          console.log('Generating QR code for URL:', currentUrl);
          new QRCode(qrcodeContainer, {
            text: currentUrl,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
          console.log('QR code generated successfully');
        } else {
          // Show message if no stream is active
          console.log('No stream in URL, cannot generate QR code');
          qrcodeContainer.innerHTML = '<div style="padding: 20px; color: #6c757d;">Connect to a stream first to generate QR code</div>';
        }
        
        // Update Stream ID display in share modal
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomId = document.getElementById('modalRoomId');
        if (roomIdInput && modalRoomId) {
          let currentRoomId = roomIdInput.value.trim();

          // If roomIdInput is empty, try to get it from URL
          if (!currentRoomId) {
            const urlParams = new URLSearchParams(window.location.search);
            // Try 'stream' first, then 'room' for backwards compatibility
            currentRoomId = urlParams.get('stream') || urlParams.get('room') || '';
          }

          // If it's a URL, extract just the stream ID
          if (currentRoomId.includes('http://') || currentRoomId.includes('https://') || currentRoomId.includes('?')) {
            try {
              const url = new URL(currentRoomId);
              // Try 'stream' first, then 'room' for backwards compatibility
              currentRoomId = url.searchParams.get('stream') || url.searchParams.get('room') || '';
            } catch (e) {
              // Try to extract from query string manually
              const match = currentRoomId.match(/[?&](stream|room)=([^&]+)/);
              if (match) {
                currentRoomId = match[2];
              }
            }
          }

          modalRoomId.textContent = currentRoomId || '-';
        }
      });

      function joinRoomFromModal() {
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomIdInputMobile = document.getElementById('roomIdInputMobile');
        const roomId = modalRoomIdInput.value.trim();

        if (!roomId) {
          alert("Please enter a stream ID");
          return;
        }
        
        // Update both hidden room ID inputs with the modal value
        if (roomIdInput) {
          roomIdInput.value = roomId;
          console.log('Updated hidden roomIdInput with:', roomId);
        } else {
          console.error('roomIdInput element not found!');
        }
        
        if (roomIdInputMobile) {
          roomIdInputMobile.value = roomId;
          console.log('Updated hidden roomIdInputMobile with:', roomId);
        }
        
        // Close the modal
        const joinModalElement = document.getElementById('joinModal');
        const joinModalInstance = bootstrap.Modal.getInstance(joinModalElement);
        if (joinModalInstance) {
          joinModalInstance.hide();
        } else {
          // If no instance exists yet, create one and hide it
          const modal = new bootstrap.Modal(joinModalElement);
          modal.hide();
        }
        
        // Call the main joinRoom function
        console.log('Calling joinRoom()...');
        if (window.joinRoom) {
          joinRoom();
        } else {
          console.error('joinRoom function not found!');
        }
      }

      function copyRoomId() {
        const roomIdElement = document.getElementById('modalRoomId');
        const roomId = roomIdElement.textContent.trim();
        
        // Don't copy if it's just a dash (no room ID)
        if (roomId === '-') {
          return;
        }
        
        navigator.clipboard.writeText(roomId).then(() => {
          // Show the "Copied to clipboard" message
          const copiedMessage = document.getElementById('roomIdCopiedMessage');
          if (copiedMessage) {
            copiedMessage.style.display = 'block';
            
            // Hide the message after 2 seconds
            setTimeout(() => {
              copiedMessage.style.display = 'none';
            }, 2000);
          }
        }).catch(err => {
          console.error('Failed to copy room ID:', err);
        });
      }

      async function shareLivestream() {
        const currentUrl = window.location.href;
        
        // Check if device is mobile and Web Share API is available
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile && navigator.share) {
          try {
            await navigator.share({
              title: 'Eagle Eyes Livestream',
              text: 'Join this Eagle Eyes livestream',
              url: currentUrl
            });
          } catch (err) {
            // User cancelled share or error occurred
            if (err.name !== 'AbortError') {
              console.error('Error sharing:', err);
              copyToClipboard(currentUrl);
            }
          }
        } else {
          // Desktop or fallback: always copy to clipboard
          copyToClipboard(currentUrl);
        }
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
          // Position toast below the share button
          const shareButton = document.querySelector('#shareModal .btn-primary');
          const toastContainer = document.getElementById('toastContainer');
          const modalDialog = document.querySelector('#shareModal .modal-dialog');
          
          if (shareButton && toastContainer && modalDialog) {
            const buttonRect = shareButton.getBoundingClientRect();
            const modalRect = modalDialog.getBoundingClientRect();
            
            // Position toast below the button, aligned horizontally with modal
            toastContainer.style.left = `${modalRect.left}px`;
            toastContainer.style.top = `${buttonRect.bottom + 10}px`;
            toastContainer.style.display = 'block';
          }
          
          // Show toast notification
          const toastEl = document.getElementById('copyToast');
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        }).catch(err => {
          console.error('Failed to copy:', err);
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand('copy');
            
            // Position toast below the share button (fallback)
            const shareButton = document.querySelector('#shareModal .btn-primary');
            const toastContainer = document.getElementById('toastContainer');
            const modalDialog = document.querySelector('#shareModal .modal-dialog');
            
            if (shareButton && toastContainer && modalDialog) {
              const buttonRect = shareButton.getBoundingClientRect();
              const modalRect = modalDialog.getBoundingClientRect();
              toastContainer.style.left = `${modalRect.left}px`;
              toastContainer.style.top = `${buttonRect.bottom + 10}px`;
              toastContainer.style.display = 'block';
            }
            
            const toastEl = document.getElementById('copyToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
          } catch (err) {
            console.error('Fallback copy failed:', err);
          }
          document.body.removeChild(textArea);
        });
      }

      // Handle Enter key in join modal input
      document.getElementById('modalRoomIdInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          joinRoomFromModal();
        }
      });

      // Add room ID validation to modal input (same as navbar inputs)
      document.getElementById('modalRoomIdInput').addEventListener('input', function(e) {
        // Use the same validation function as the navbar inputs
        if (window.viewer && window.viewer.validateAndFormatRoomId) {
          const validated = window.viewer.validateAndFormatRoomId(e.target.value);
          e.target.value = validated;
          
          // Also sync with hidden navbar inputs
          const roomIdInput = document.getElementById('roomIdInput');
          const roomIdInputMobile = document.getElementById('roomIdInputMobile');
          if (roomIdInput) roomIdInput.value = validated;
          if (roomIdInputMobile) roomIdInputMobile.value = validated;
        }
      });

      // Pre-populate modal with current stream ID when opened
      document.getElementById('joinModal').addEventListener('show.bs.modal', function () {
        const roomIdInput = document.getElementById('roomIdInput');
        const modalRoomIdInput = document.getElementById('modalRoomIdInput');
        if (roomIdInput && modalRoomIdInput) {
          const currentRoomId = roomIdInput.value.trim();
          if (currentRoomId) {
            modalRoomIdInput.value = currentRoomId;
            modalRoomIdInput.placeholder = 'Enter a different Stream ID or use current';
          } else {
            modalRoomIdInput.placeholder = 'Stream ID';
          }
        }
      });

      // QR Code Scanner functionality
      let html5QrCode = null;
      let qrScannerActive = false;

      async function activateQRScanner() {
        const qrScannerContainer = document.getElementById('qrScannerContainer');
        const activateBtn = document.getElementById('activateCameraBtn');
        const stopBtn = document.getElementById('stopCameraBtn');
        const qrScanResult = document.getElementById('qrScanResult');

        try {
          qrScannerContainer.style.display = 'block';
          activateBtn.style.display = 'none';
          stopBtn.style.display = 'block';
          qrScanResult.textContent = 'Point your camera at a QR code...';

          html5QrCode = new Html5Qrcode("qrReader");
          
          const config = { 
            fps: 30, 
            qrbox: { width: 200, height: 200 },
            aspectRatio: 1.0,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
          };
          
          await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
              // QR code successfully scanned
              console.log('QR Code scanned! Raw text:', decodedText);
              qrScanResult.textContent = 'QR Code detected! Joining livestream...';
              
              // Extract stream ID from URL if it's a full URL, or use as-is if it's just an ID
              let roomId = decodedText;
              try {
                const url = new URL(decodedText);
                // Try 'stream' first, then 'room' for backwards compatibility
                const urlRoomId = url.searchParams.get('stream') || url.searchParams.get('room');
                if (urlRoomId) {
                  roomId = urlRoomId;
                  console.log('Extracted stream ID from URL:', roomId);
                } else {
                  console.log('No stream parameter in URL, using full URL as stream ID');
                }
              } catch (e) {
                // Not a URL, use as-is
                console.log('Not a valid URL, using raw text as stream ID:', roomId);
              }
              
              // Keep room ID in uppercase (don't normalize to lowercase)
              roomId = roomId.toUpperCase();
              console.log('Final room ID (uppercase):', roomId);
              
              // Stop scanner and join
              stopQRScanner();
              
              // Close modal
              const joinModal = bootstrap.Modal.getInstance(document.getElementById('joinModal'));
              if (joinModal) {
                joinModal.hide();
              }
              
              // Update the hidden roomIdInput field
              const hiddenRoomIdInput = document.getElementById('roomIdInput');
              const hiddenRoomIdInputMobile = document.getElementById('roomIdInputMobile');
              if (hiddenRoomIdInput) {
                hiddenRoomIdInput.value = roomId;
              }
              if (hiddenRoomIdInputMobile) {
                hiddenRoomIdInputMobile.value = roomId;
              }
              
              // Call the joinRoom function
              if (window.joinRoom) {
                joinRoom();
              }
            },
            (errorMessage) => {
              // QR code parsing error (usually means no QR code in view)
              // This is called frequently, so we don't show errors here
              // Only log if it's not a common "No QR code found" message
              if (!errorMessage.includes('No QR code found') && !errorMessage.includes('NotFoundException')) {
                console.log('QR scan error:', errorMessage);
              }
            }
          );
          
          qrScannerActive = true;
        } catch (err) {
          console.error('Error starting QR scanner:', err);
          qrScanResult.textContent = 'Error: Could not access camera. Please check permissions.';
          qrScanResult.classList.remove('text-success');
          qrScanResult.classList.add('text-danger');
          activateBtn.style.display = 'block';
          stopBtn.style.display = 'none';
          qrScannerContainer.style.display = 'none';
        }
      }

      function stopQRScanner() {
        if (html5QrCode && qrScannerActive) {
          html5QrCode.stop().then(() => {
            const qrScannerContainer = document.getElementById('qrScannerContainer');
            const activateBtn = document.getElementById('activateCameraBtn');
            const stopBtn = document.getElementById('stopCameraBtn');
            const qrScanResult = document.getElementById('qrScanResult');
            
            qrScannerContainer.style.display = 'none';
            activateBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            qrScanResult.textContent = '';
            qrScanResult.classList.remove('text-danger');
            qrScanResult.classList.add('text-success');
            
            qrScannerActive = false;
          }).catch(err => {
            console.error('Error stopping QR scanner:', err);
          });
        }
      }

      // Clean up QR scanner when modal is closed
      document.getElementById('joinModal').addEventListener('hidden.bs.modal', function () {
        if (qrScannerActive) {
          stopQRScanner();
        }
      });

      // Mobile viewers button visibility and count control
      function syncMobileViewersButton() {
        const mobileViewersBtn = document.getElementById('viewersBtnMobile');
        const mobileViewerCount = document.getElementById('viewerCountMobile');
        const desktopViewerCount = document.getElementById('viewerCount');
        
        if (mobileViewersBtn) {
          // Always show the viewers button
          mobileViewersBtn.style.display = 'block';
        }
        
        // Sync viewer count with desktop
        if (mobileViewerCount && desktopViewerCount) {
          mobileViewerCount.textContent = desktopViewerCount.textContent;
        }
      }

      // Monitor for changes to stream state and sync mobile viewers button
      setInterval(syncMobileViewersButton, 1000);
      setTimeout(syncMobileViewersButton, 500); // Initial check

      // Handle mobile orientation changes
      window.addEventListener('orientationchange', () => {
        console.log('Orientation changed, updating layout...');
        setTimeout(() => {
          // Ensure split view is maintained on orientation change
          const splitViewRadio = document.getElementById('split-view-mobile');
          if (splitViewRadio && splitViewRadio.checked) {
            console.log('Maintaining split view after orientation change');
            
            // Force proper mobile layout based on orientation
            const mainContent = document.getElementById('main-content');
            const videoPanel = document.getElementById('video-panel');
            const mapPanel = document.getElementById('map-panel');
            
            if (mainContent && videoPanel && mapPanel) {
              // Force layout refresh
              mainContent.style.display = 'none';
              setTimeout(() => {
                mainContent.style.display = 'flex';
                
                // Ensure both panels are visible in split view
                videoPanel.classList.remove('d-none');
                mapPanel.classList.remove('d-none');
                
                // Force correct mobile layout classes
                if (window.innerWidth <= 991) {
                  // Check if we're in split view mode (not full screen)
                  const isSplitView = !videoPanel.classList.contains('full-view') && 
                                    !mapPanel.classList.contains('full-view') &&
                                    !videoPanel.classList.contains('d-none') && 
                                    !mapPanel.classList.contains('d-none');
                  
                  if (isSplitView) {
                    // Mobile - force layout based on orientation
                    if (window.innerHeight < window.innerWidth) {
                      // Landscape mode - force side by side
                      videoPanel.style.flex = '0 0 50%';
                      videoPanel.style.width = '50%';
                      mapPanel.style.flex = '0 0 50%';
                      mapPanel.style.width = '50%';
                      mainContent.style.flexDirection = 'row';
                    } else {
                      // Portrait mode - force top/bottom layout
                      videoPanel.style.flex = '0 0 50%';
                      videoPanel.style.width = '100%';
                      mapPanel.style.flex = '0 0 50%';
                      mapPanel.style.width = '100%';
                      mainContent.style.flexDirection = 'column';
                      // Ensure map is visible
                      mapPanel.classList.remove('d-none');
                      mapPanel.style.display = 'flex';
                    }
                  }
                } else {
                  // Desktop - clear inline styles to let CSS handle it
                  videoPanel.style.flex = '';
                  videoPanel.style.width = '';
                  mapPanel.style.flex = '';
                  mapPanel.style.width = '';
                  mainContent.style.flexDirection = '';
                }
              }, 50);
            }
          }
          
          if (window.optimizeVideoFitting) {
            window.optimizeVideoFitting();
          }
          if (window.droneMap) {
            setTimeout(() => window.droneMap.resize(), 100);
          }
        }, 200); // Increased timeout for better orientation detection
      });

      // Handle window resize to maintain split view
      window.addEventListener('resize', () => {
        setTimeout(() => {
          // Check if we're in split view mode and maintain it
          const splitViewRadio = document.getElementById('split-view-mobile');
          if (splitViewRadio && splitViewRadio.checked) {
            console.log('Maintaining split view after resize');
            const videoPanel = document.getElementById('video-panel');
            const mapPanel = document.getElementById('map-panel');
            
            if (videoPanel && mapPanel) {
              // Force reapplication of split view classes
              videoPanel.className = '';
              mapPanel.className = '';
              setTimeout(() => {
                // Reapply the appropriate classes based on current orientation
                if (window.innerWidth <= 991) {
                  // Mobile - apply orientation-based layout
                  videoPanel.classList.add('col-lg-8');
                  mapPanel.classList.add('col-lg-4');
                } else {
                  // Desktop
                  videoPanel.classList.add('col-lg-8');
                  mapPanel.classList.add('col-lg-4');
                }
              }, 50);
            }
          }
        }, 100);
      });

      // Picture-in-Picture variables
      let pipEnabled = false;

      // Location tracking variables
      let myLocationEnabled = false;
      let myLocationMarker = null;
      let myLocationWatchId = null;

      // Laser range finder variables
      let laserEnabled = false;
      let laserMarker = null;
      let laserUpdateInterval = null;

      function togglePictureInPicture() {
        const button = document.getElementById('pipBtn');
        const video = document.getElementById('remoteVideo');
        
        if (!video) {
          alert('No video stream available for Picture-in-Picture');
          return;
        }

        // Check if Picture-in-Picture is supported
        if (!document.pictureInPictureEnabled) {
          alert('Picture-in-Picture is not supported by this browser');
          return;
        }

        if (!pipEnabled) {
          // Check if video is ready and has content
          if (video.readyState < 2) {
            alert('Video is not ready for Picture-in-Picture. Please wait for the stream to load.');
            return;
          }

          // Request Picture-in-Picture
          video.requestPictureInPicture().then(() => {
            pipEnabled = true;
            button.innerHTML = '<i class="bi bi-picture-in-picture-exit"></i> Exit PiP';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-secondary');
            console.log('Picture-in-Picture enabled');
          }).catch(err => {
            console.error('Error entering Picture-in-Picture:', err);
            let errorMsg = 'Failed to enter Picture-in-Picture mode. ';
            if (err.name === 'NotAllowedError') {
              errorMsg += 'User denied permission or browser blocked the request.';
            } else if (err.name === 'NotSupportedError') {
              errorMsg += 'Picture-in-Picture is not supported.';
            } else {
              errorMsg += 'Please try again.';
            }
            alert(errorMsg);
          });
        } else {
          // Exit Picture-in-Picture
          if (document.pictureInPictureElement) {
            document.exitPictureInPicture().then(() => {
              pipEnabled = false;
              button.innerHTML = '<i class="bi bi-picture-in-picture"></i> Picture-in-Picture';
              button.classList.remove('btn-secondary');
              button.classList.add('btn-outline-secondary');
              console.log('Picture-in-Picture disabled');
            }).catch(err => {
              console.error('Error exiting Picture-in-Picture:', err);
              alert('Failed to exit Picture-in-Picture mode');
            });
          }
        }
      }

      // Listen for Picture-in-Picture events
      document.addEventListener('enterpictureinpicture', () => {
        pipEnabled = true;
        const button = document.getElementById('pipBtn');
        if (button) {
          button.innerHTML = '<i class="bi bi-picture-in-picture-exit"></i> Exit PiP';
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-secondary');
        }
      });

      document.addEventListener('leavepictureinpicture', () => {
        pipEnabled = false;
        const button = document.getElementById('pipBtn');
        if (button) {
          button.innerHTML = '<i class="bi bi-picture-in-picture"></i> Picture-in-Picture';
          button.classList.remove('btn-secondary');
          button.classList.add('btn-outline-secondary');
        }
      });

      function toggleLaserRangeFinder() {
        const button = document.getElementById('showLaserBtn');
        
        if (!laserEnabled) {
          // Enable laser range finder display
          if (!window.droneMap || !window.droneMap.map) {
            alert('Map is not available. Please wait for the map to load.');
            return;
          }

          // Ensure we're in the correct view mode for laser display
          const splitViewRadio = document.getElementById('split-view-mobile');
          const mapViewRadio = document.getElementById('map-only-mobile');
          
          if (splitViewRadio && splitViewRadio.checked) {
            // Stay in split view - ensure both panels are visible
            const mapPanel = document.getElementById('map-panel');
            const videoPanel = document.getElementById('video-panel');
            if (mapPanel) mapPanel.classList.remove('d-none');
            if (videoPanel) videoPanel.classList.remove('d-none');
          } else if (mapViewRadio && mapViewRadio.checked) {
            // Map full screen is fine for laser display
            console.log('Laser range finder in map full screen mode');
          } else {
            // Default to split view for laser display
            const splitViewRadio = document.getElementById('split-view-mobile');
            if (splitViewRadio) {
              splitViewRadio.checked = true;
              setViewMode("split");
            }
          }

          const originalText = button.innerHTML;
          button.innerHTML = '<i class="bi bi-hourglass-split"></i> Getting Laser Data...';
          button.disabled = true;

          // Start monitoring for laser range finder data
          laserUpdateInterval = setInterval(() => {
            updateLaserRangeFinder();
          }, 1000); // Check every second

          // Initial check
          setTimeout(() => {
            updateLaserRangeFinder();
            button.innerHTML = '<i class="bi bi-bullseye-fill"></i> Hide Laser Range Finder Location';
            button.disabled = false;
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-secondary');
            laserEnabled = true;
          }, 1000);

        } else {
          // Disable laser range finder display
          if (laserUpdateInterval) {
            clearInterval(laserUpdateInterval);
            laserUpdateInterval = null;
          }
          
          if (laserMarker && window.droneMap && window.droneMap.map) {
            window.droneMap.map.removeLayer(laserMarker);
            laserMarker = null;
          }
          
          laserEnabled = false;
          button.innerHTML = '<i class="bi bi-bullseye"></i> Display Laser Range Finder Location';
          button.classList.remove('btn-secondary');
          button.classList.add('btn-outline-secondary');
          
          console.log('Laser range finder disabled');
        }
      }

      function updateLaserRangeFinder() {
        // Check if we have drone data with laser range finder info
        if (window.droneMap && window.droneMap.map && window.droneMap.droneData) {
          const droneData = window.droneMap.droneData;
          
          // Look for laser range finder data in the drone info
          if (droneData.laserRangeFinder && droneData.laserRangeFinder.lat && droneData.laserRangeFinder.lon) {
            const lat = parseFloat(droneData.laserRangeFinder.lat);
            const lon = parseFloat(droneData.laserRangeFinder.lon);
            
            if (!isNaN(lat) && !isNaN(lon)) {
              // Remove existing marker
              if (laserMarker) {
                window.droneMap.map.removeLayer(laserMarker);
              }
              
              // Create new laser range finder marker
              laserMarker = L.marker([lat, lon], {
                icon: L.divIcon({
                  className: 'laser-range-marker',
                  html: `<div style="
                    width: 12px;
                    height: 12px;
                    background-color: #dc3545;
                    border: 2px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
                    animation: pulse 2s infinite;
                  "></div>`,
                  iconSize: [12, 12],
                  iconAnchor: [6, 6]
                })
              }).addTo(window.droneMap.map)
              .bindPopup('Laser Range Finder Location');
              
              console.log('Laser range finder location updated:', lat, lon);
            }
          }
        }
      }

      function toggleMyLocation() {
        const button = document.getElementById('showMyLocationBtn');
        
        if (!myLocationEnabled) {
          if (!navigator.geolocation) {
            alert('Geolocation is not supported by this browser.');
            return;
          }

          const originalText = button.innerHTML;
          button.innerHTML = '<i class="bi bi-hourglass-split"></i> Getting Location...';
          button.disabled = true;

          const mapPanel = document.getElementById('map-panel');
          const videoPanel = document.getElementById('video-panel');
          
          if (mapPanel) {
            // Check current view mode and respect it
            const splitViewRadio = document.getElementById('split-view-mobile');
            const videoViewRadio = document.getElementById('video-only-mobile');
            const mapViewRadio = document.getElementById('map-only-mobile');
            
            if (splitViewRadio && splitViewRadio.checked) {
              // Stay in split view - don't force full screen map
              mapPanel.classList.remove('d-none');
              videoPanel.classList.remove('d-none');
              // Let the existing split view layout handle the sizing
            } else if (mapViewRadio && mapViewRadio.checked) {
              // Map full screen mode
              mapPanel.classList.remove('d-none');
              mapPanel.classList.add('col-12');
              if (videoPanel) {
                videoPanel.classList.add('d-none');
              }
            } else {
              // Default to split view if no specific mode selected
              mapPanel.classList.remove('d-none');
              videoPanel.classList.remove('d-none');
            }
            
            if (!window.droneMap || !window.droneMap.map) {
              console.log('Map not initialized, attempting to create...');
              setTimeout(() => {
                if (window.initMap) {
                  window.initMap();
                }
                if (window.droneMap && window.droneMap.resize) {
                  window.droneMap.resize();
                }
              }, 200);
            } else {
              setTimeout(() => {
                if (window.droneMap && window.droneMap.resize) {
                  window.droneMap.resize();
                }
              }, 100);
            }
          }

          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const heading = position.coords.heading;

              if (!window.droneMap || !window.droneMap.map) {
                console.log('Map not initialized, attempting to create...');
                setTimeout(() => {
                  if (window.droneMap && window.droneMap.map) {
                    createLocationMarker(lat, lon, heading);
                  } else {
                    console.log('Map still not available');
                    button.innerHTML = originalText;
                    button.disabled = false;
                    alert('Map is not available. Please try again.');
                  }
                }, 500);
                return;
              }
              
              createLocationMarker(lat, lon, heading);
            },
            function(error) {
              button.innerHTML = originalText;
              button.disabled = false;
              
              let errorMessage = 'Unable to get your location. ';
              switch(error.code) {
                case error.PERMISSION_DENIED: errorMessage += 'Location access denied by user.'; break;
                case error.POSITION_UNAVAILABLE: errorMessage += 'Location information unavailable.'; break;
                case error.TIMEOUT: errorMessage += 'Location request timed out.'; break;
                default: errorMessage += 'An unknown error occurred.'; break;
              }
              alert(errorMessage);
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        } else {
          // Disable location tracking
          if (myLocationWatchId !== null) {
            navigator.geolocation.clearWatch(myLocationWatchId);
            myLocationWatchId = null;
          }
          
          if (myLocationMarker && window.droneMap && window.droneMap.map) {
            window.droneMap.map.removeLayer(myLocationMarker);
            myLocationMarker = null;
          }
          
          myLocationEnabled = false;
          button.innerHTML = '<i class="bi bi-geo-alt"></i> Show My Location';
          button.classList.remove('btn-secondary');
          button.classList.add('btn-outline-secondary');
          
          console.log('User location disabled');
        }
      }

      function createLocationMarker(lat, lon, heading) {
        if (window.droneMap && window.droneMap.map) {
          if (myLocationMarker) {
            window.droneMap.map.removeLayer(myLocationMarker);
          }
          
          let markerOptions = {
            icon: L.divIcon({
              className: 'my-location-marker',
              html: `<div style="
                width: 24px;
                height: 24px;
                background-color: #007bff;
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                position: relative;
              ">
                ${heading !== null && heading !== undefined ? `
                  <div style="
                    position: absolute;
                    top: -16px;
                    left: 50%;
                    transform: translateX(-50%) rotate(${heading}deg);
                    width: 0;
                    height: 0;
                    border-left: 9px solid transparent;
                    border-right: 9px solid transparent;
                    border-bottom: 20px solid #007bff;
                    filter: drop-shadow(0 3px 6px rgba(0,0,0,0.6));
                    z-index: 1000;
                  "></div>
                ` : `
                  <div style="
                    position: absolute;
                    top: -12px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 7px solid transparent;
                    border-right: 7px solid transparent;
                    border-bottom: 14px solid #007bff;
                    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                  "></div>
                `}
              </div>`,
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            })
          };
          
          myLocationMarker = L.marker([lat, lon], markerOptions)
            .addTo(window.droneMap.map)
            .bindPopup('Your Location');
          
          window.droneMap.map.setView([lat, lon], 15);
          
          myLocationWatchId = navigator.geolocation.watchPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const heading = position.coords.heading;
              
              if (myLocationMarker) {
                myLocationMarker.setLatLng([lat, lon]);
                
                if (heading !== null && heading !== undefined) {
                  const markerElement = myLocationMarker.getElement();
                  if (markerElement) {
                    const arrow = markerElement.querySelector('div div');
                    if (arrow) {
                      arrow.style.transform = `translateX(-50%) rotate(${heading}deg)`;
                    }
                  }
                }
              }
            },
            function(error) {
              console.log('Location watch error:', error);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 1000 }
          );
          
          const button = document.getElementById('showMyLocationBtn');
          myLocationEnabled = true;
          button.innerHTML = '<i class="bi bi-geo-alt-fill"></i> Hide My Location';
          button.disabled = false;
          button.classList.remove('btn-outline-secondary');
          button.classList.add('btn-secondary');
          
          console.log('User location enabled:', lat, lon, 'heading:', heading);
        }
      }


    </script>
  </body>
</html>
