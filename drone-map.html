<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDS-B Drone Tracker Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            background-color: #0a0a0a;
            color: #a0a0a0;
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .tactical-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px !important;
            min-height: 50px !important;
            max-height: 50px !important;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-bottom: 2px solid #4a7c59;
            z-index: 100000 !important;
            display: flex !important;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            flex-wrap: nowrap !important;
            overflow: visible !important;
        }

        .tactical-header h1 {
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #d4a574;
            text-shadow: 0 0 5px rgba(212, 165, 116, 0.3);
            margin: 0;
        }
        
        .tactical-header h1 span {
            font-size: 0.55em !important;
            text-shadow: 0 0 8px rgba(136, 136, 136, 0.4), 0 0 15px rgba(136, 136, 136, 0.2), 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .tactical-header .logo-link {
            display: flex;
            align-items: center;
            margin-right: 15px;
            text-decoration: none;
            position: relative;
            left: 5px; /* Shift slightly right to align with North Arrow center */
        }

        .tactical-header .logo-link img {
            height: 40px;
            width: 40px;
            border-radius: 6px;
            transition: opacity 0.2s;
        }

        .tactical-header .logo-link:hover img {
            opacity: 0.8;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 1;
            flex-grow: 0;
            min-width: 0;
            max-width: 60%;
            z-index: 2;
            position: relative;
        }
        
        .header-center {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: none; /* Hidden by default to prevent overlap */
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 1;
            width: auto;
            max-width: 50%;
        }
        
        /* Only show tagline on very wide screens where there's plenty of space */
        @media (min-width: 1600px) {
            .header-center {
                display: flex;
            }
        }

        .tactical-header .subtitle {
            font-size: 10px;
            color: #666;
            letter-spacing: 2px;
            margin-left: 10px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 150px;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        
        .download-text {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #b0b0b0;
            white-space: nowrap;
            margin-right: 0;
            line-height: 1.2;
        }
        .download-text-lines {
            display: inline-block;
        }
        .download-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.75em;
            line-height: 1;
            color: #d4a574;
            text-shadow: 0 0 8px rgba(212, 165, 116, 0.4), 0 0 12px rgba(74, 124, 89, 0.3);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.4));
        }
        .download-arrow:hover {
            color: #5a8a6a;
            text-shadow: 0 0 10px rgba(90, 138, 106, 0.5);
        }
        
        .map-control-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            margin-left: auto;
            position: absolute !important;
            right: 20px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 100001 !important;
            flex-wrap: nowrap !important;
        }
        
        .map-control-container button {
            height: 32px !important;
            min-height: 32px !important;
            max-height: 32px !important;
            box-sizing: border-box;
            padding: 8px 12px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            width: auto !important;
        }
        
        #baseMapControl {
            position: relative;
            z-index: 100002 !important;
        }
        
        #baseMapBtn {
            background: rgba(10, 10, 10, 0.9) !important;
            border: 1px solid #4a7c59 !important;
            color: #b0b0b0 !important;
            padding: 8px 12px !important;
            font-family: 'Courier New', monospace !important;
            font-size: 16px !important;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 32px !important;
            max-height: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            position: relative;
            box-sizing: border-box !important;
            width: auto !important;
        }
        
        #baseMapBtn:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        #baseMapBtn:focus {
            border-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
        }
        
        .base-map-menu {
            position: absolute;
            top: calc(100% + 5px);
            right: 0;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #4a7c59;
            border-radius: 4px;
            padding: 10px;
            z-index: 999999 !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        
        .base-map-option {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 6px 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 150px;
        }
        
        .base-map-option:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        .base-map-option:active {
            background: rgba(30, 30, 30, 0.9);
        }

        .base-map-option.base-map-toggle {
            border-top: 1px solid rgba(74, 124, 89, 0.6);
            margin-top: 6px;
            padding-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: default;
        }
        .base-map-option.base-map-toggle:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        .base-map-option.base-map-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
            accent-color: #4a7c59;
            flex-shrink: 0;
        }
        .base-map-option.base-map-toggle label {
            cursor: pointer;
            flex-grow: 1;
            margin: 0;
        }

        /* EDS-B tooltip: shown on hover and click */
        .edsb-tooltip-popover {
            position: fixed;
            z-index: 100003;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #4a7c59;
            color: #d4a574;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            display: none;
            white-space: nowrap;
        }
        .edsb-tooltip-popover.visible {
            display: block;
        }
        
        .tagline-text {
            font-size: 14px;
            color: #5a8a6a;
            font-style: italic;
            letter-spacing: 0.5px;
            text-align: center;
            opacity: 1;
            transition: opacity 2.5s ease-in-out !important;
            font-weight: 400;
            text-shadow: 0 0 8px rgba(90, 138, 106, 0.4), 0 0 15px rgba(90, 138, 106, 0.2), 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            will-change: opacity;
        }
        
        .tagline-text.fade-out {
            opacity: 0 !important;
        }
        
        /* Tagline is hidden by default - only shows on very wide screens (1600px+) */
        /* This prevents overlap with "Share your drone's live location" text */
        
        /* Step 1: Hide subtitle when left and right sides get too close */
        @media (max-width: 1300px) {
            .tactical-header h1 span {
                display: none; /* Hide "Eagle Dependent Surveillance-Broadcast" */
            }
        }
        
        /* Step 2: Hide "To share your drone's live location for free" text when it overlaps */
        @media (max-width: 1000px) {
            .download-text {
                display: none !important;
            }
        }
        
        /* Step 3: Hide status indicator to make room for buttons, keep everything in one row */
        @media (max-width: 1000px) {
            /* Hide status indicator to make room for buttons */
            .status-indicator {
                display: none !important;
            }
            
        }
        
        @media (max-width: 768px) {
            .tactical-header {
                padding: 6px 10px;
                height: 48px !important;
                min-height: 48px !important;
                max-height: 48px !important;
                flex-wrap: nowrap !important;
                overflow: hidden;
            }
            
            .tactical-header h1 {
                font-size: 16px;
                letter-spacing: 1.5px;
            }
            
            .tactical-header .logo-link img {
                height: 30px;
                width: 30px;
            }
            
            /* Keep buttons in top nav bar on right side - never drop */
            .header-left {
                flex: 0 0 auto;
                min-width: 0;
                max-width: 50%;
            }
            
            .map-control-container {
                position: absolute !important;
                right: 10px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: auto !important;
                margin-top: 0 !important;
                margin-left: 0 !important;
                flex-wrap: nowrap !important;
                max-width: 50% !important;
            }
            
            /* Status already hidden at 1000px, but ensure it stays hidden */
            .status-indicator {
                display: none !important;
            }
            
            /* Keep download text hidden */
            .download-text {
                display: none !important;
            }
            
            #downloadBtn {
                font-size: 9px !important;
                padding: 6px 8px !important;
                min-width: 60px;
            }
            
            #legendBtn {
                font-size: 10px !important;
                padding: 6px 10px !important;
            }
            
            #baseMapBtn {
                font-size: 12px !important;
                padding: 6px 10px !important;
            }
            
            .status-text {
                font-size: 9px;
            }
            
            .status-text:first-of-type {
                display: none;
            }
            
            .north-arrow-img {
                width: 44px;
                height: 44px;
            }
            .north-arrow-content {
                min-width: 44px;
                min-height: 44px;
            }
            
            #map {
                top: 48px;
            }
        }
        
        @media (max-width: 480px) {
            .tactical-header {
                padding: 5px 8px;
                height: 44px !important;
                min-height: 44px !important;
                max-height: 44px !important;
                flex-wrap: nowrap !important;
                overflow: hidden;
            }
            
            .tactical-header h1 {
                font-size: 14px;
            }
            
            .tactical-header .logo-link img {
                height: 26px;
                width: 26px;
            }
            
            /* Keep buttons in top nav bar on right side - never drop */
            .header-left {
                flex: 0 0 auto;
                min-width: 0;
                max-width: 45%;
            }
            
            .map-control-container {
                position: absolute !important;
                right: 8px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: auto !important;
                margin-top: 0 !important;
                margin-left: 0 !important;
                flex-wrap: nowrap !important;
                max-width: 55% !important;
                gap: 4px;
            }
            
            /* Hide status indicator (pulsing green dot) on narrow mobile */
            .status-indicator {
                display: none !important;
            }
            
            /* Keep download text hidden */
            .download-text {
                display: none !important;
            }
            
            #downloadBtn {
                font-size: 8px !important;
                padding: 5px 6px !important;
                min-width: 50px;
            }
            
            #legendBtn {
                font-size: 9px !important;
                padding: 5px 8px !important;
            }
            
            #baseMapBtn {
                font-size: 11px !important;
                padding: 5px 8px !important;
            }
            
            .status-text {
                font-size: 8px;
            }
            
            .north-arrow-img {
                width: 40px;
                height: 40px;
            }
            .north-arrow-content {
                min-width: 44px;
                min-height: 44px;
            }
            
            #map {
                top: 44px;
            }
        }
        
        @media (max-width: 360px) {
            .tactical-header {
                padding: 4px 6px;
                min-height: 42px;
                flex-wrap: nowrap !important;
                overflow: hidden;
            }
            
            .tactical-header h1 {
                font-size: 12px;
            }
            
            .tactical-header .logo-link img {
                height: 24px;
                width: 24px;
            }
            
            /* Keep buttons in top nav bar - make them smaller if needed */
            .header-left {
                max-width: 40%;
            }
            
            .map-control-container {
                position: absolute !important;
                right: 6px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                max-width: 60% !important;
                gap: 3px;
            }
            
            /* Keep status hidden on very narrow screens */
            .status-indicator {
                display: none !important;
            }
            
            .status-text {
                font-size: 7px;
            }
            
            #downloadBtn {
                font-size: 7px !important;
                padding: 4px 5px !important;
                min-width: 45px;
            }
            
            #legendBtn {
                font-size: 8px !important;
                padding: 4px 6px !important;
            }
            
            #baseMapBtn {
                font-size: 10px !important;
                padding: 4px 6px !important;
            }
            
            .north-arrow-img {
                width: 36px;
                height: 36px;
            }
            .north-arrow-content {
                min-width: 44px;
                min-height: 44px;
            }
            
            #map {
                top: 42px;
            }
        }
        @media (max-width: 768px) {
            .location-popover {
                font-size: 11px;
                padding: 10px 12px;
                max-width: 200px;
            }
        }
        @media (max-width: 480px) {
            .location-popover {
                font-size: 11px;
                padding: 12px 14px;
                max-width: min(200px, calc(100vw - 24px));
            }
        }
        
        #downloadTestDataBtn {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 6px 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        #downloadTestDataBtn:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        #downloadTestDataBtn:focus {
            border-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
        }
        
        #downloadTestDataBtn.pulse {
            animation: greenPulse 3s ease-in-out infinite;
        }
        
        @keyframes greenPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(74, 124, 89, 0);
                border-color: #4a7c59;
            }
            50% {
                box-shadow: 0 0 10px 3px rgba(74, 124, 89, 0.6);
                border-color: #5a8a6a;
            }
        }
        
        #downloadBtn {
            background: rgba(10, 10, 10, 0.9) !important;
            border: 1px solid #4a7c59 !important;
            color: #b0b0b0 !important;
            padding: 8px 12px !important;
            font-family: 'Courier New', monospace !important;
            font-size: 12px !important;
            line-height: 1.2 !important;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            white-space: normal;
            min-height: 32px !important;
            max-height: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-sizing: border-box !important;
        }
        
        #downloadBtn:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        #downloadBtn:focus {
            border-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
        }

        #legendBtn {
            background: rgba(10, 10, 10, 0.9) !important;
            border: 1px solid #4a7c59 !important;
            color: #b0b0b0 !important;
            padding: 8px 12px !important;
            font-family: 'Courier New', monospace !important;
            font-size: 12px !important;
            cursor: pointer;
            border-radius: 4px;
            outline: none;
            font-weight: 500;
            min-height: 32px !important;
            max-height: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-sizing: border-box !important;
        }
        
        #legendBtn:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        #legendBtn:focus {
            border-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
        }
        
        .legend-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #4a7c59;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #b0b0b0;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }
        
        .legend-panel.visible {
            display: block;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-subset {
            margin-left: 28px;
            margin-top: 4px;
            margin-bottom: 6px;
            font-size: 10px;
            color: #888;
        }
        .legend-subset .legend-subset-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 3px;
        }
        .legend-subset .legend-subset-row:last-child {
            margin-bottom: 0;
        }
        .legend-subset .legend-subset-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-symbol.legend-drone-pulse-wrap {
            position: relative;
        }
        
        .legend-symbol {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legend-line {
            width: 30px;
            height: 2px;
            border-top: 2px dashed;
        }
        
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .legend-dot-pulse {
            animation: pulse 2s infinite;
        }
        
        .legend-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(90, 138, 106, 0.5);
            animation: pulse 2s infinite;
            margin: 0 5px;
        }

        .status-dot.connected {
            background-color: #5a8a6a;
            box-shadow: 0 0 5px rgba(90, 138, 106, 0.5);
        }

        .status-dot.disconnected {
            background-color: #d4a574;
            box-shadow: 0 0 5px rgba(212, 165, 116, 0.5);
        }

        .status-dot.failed {
            background-color: #dc143c;
            box-shadow: 0 0 5px rgba(220, 20, 60, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }


        .status-text {
            font-size: 11px;
            color: #a0a0a0;
            letter-spacing: 1px;
        }
        
        .status-indicator .status-text:first-of-type {
            margin-right: 0;
        }
        
        .status-text-right {
            margin-left: auto;
        }

        /* Map Container */
        #map {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #0a0a0a;
            z-index: 1;
        }

        /* Controls */
        .tactical-controls {
            position: absolute;
            top: 60px;
            right: 20px;
            z-index: 1000;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #4a7c59;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            max-width: 300px;
        }

        .control-panel {
            font-size: 13px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .control-panel h3 {
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #4a7c59;
            padding-bottom: 5px;
            color: #d4a574;
            font-weight: bold;
        }

        .control-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-item label {
            min-width: 80px;
            font-size: 12px;
            font-weight: 500;
        }

        .control-item input[type="text"],
        .control-item input[type="number"] {
            background: #1a1a1a;
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 4px 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            width: 150px;
            font-weight: 500;
        }

        .control-item input:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(74, 124, 89, 0.5);
            border-color: #5a8a6a;
        }

        .tactical-button {
            background: #1a1a1a;
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 6px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tactical-button:hover {
            background: #4a7c59;
            color: #ffffff;
            box-shadow: 0 0 10px rgba(74, 124, 89, 0.3);
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #4a7c59;
            border-radius: 4px;
            padding: 15px;
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .info-panel h3 {
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 1px solid #4a7c59;
            padding-bottom: 5px;
            color: #d4a574;
            font-weight: bold;
        }

        .info-item {
            font-size: 14px;
            margin: 6px 0;
            color: #b0b0b0;
            display: flex;
            justify-content: space-between;
            font-weight: 400;
        }

        .info-item .label {
            color: #b0b0b0;
            font-weight: 400;
        }

        .info-item .value {
            color: #d4a574;
            font-weight: 500;
        }

        /* Custom Leaflet Controls */
        .leaflet-control {
            background: rgba(10, 10, 10, 0.9) !important;
            border: 1px solid #4a7c59 !important;
        }

        .leaflet-control a {
            background-color: #1a1a1a !important;
            color: #a0a0a0 !important;
            border: 1px solid #4a7c59 !important;
        }

        .leaflet-control a:hover {
            background-color: #4a7c59 !important;
            color: #ffffff !important;
        }

        /* Leaflet bottom controls positioning - ensure they stay at bottom */
        .leaflet-bottom {
            bottom: 0 !important;
            z-index: 400 !important;
        }

        .leaflet-control-attribution {
            background: rgba(10, 10, 10, 0.9) !important;
            color: #666 !important;
            font-size: 9px !important;
            padding: 2px 5px !important;
            margin: 0 !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        .leaflet-control-attribution a {
            color: #5a8a6a !important;
        }

        /* Ensure Leaflet controls don't conflict with control panel */
        .leaflet-bottom.leaflet-right {
            right: 0 !important;
            bottom: 0 !important;
        }

        .leaflet-bottom.leaflet-left {
            left: 0 !important;
            bottom: 0 !important;
        }
        
        /* Scale Bar Control - Military/Operational Theme */
        .scale-bar-control {
            background: rgba(10, 10, 10, 0.95) !important;
            border: 2px solid #4a7c59 !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(74, 124, 89, 0.3) !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            position: relative !important;
        }
        
        /* Ensure scale bar container is visible */
        .leaflet-bottom.leaflet-left {
            z-index: 2000 !important;
        }
        
        .leaflet-bottom.leaflet-left .scale-bar-control {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin: 10px !important;
        }
        
        /* Ensure Leaflet control container doesn't hide our custom scale bar */
        .leaflet-control-container .leaflet-bottom.leaflet-left {
            pointer-events: none !important;
        }
        
        .leaflet-control-container .leaflet-bottom.leaflet-left .scale-bar-control {
            pointer-events: auto !important;
        }
        
        .scale-bar-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }
        
        .scale-bar-line {
            width: 120px;
            height: 3px;
            background: linear-gradient(to right, #4a7c59 0%, #4a7c59 50%, transparent 50%, transparent 100%);
            border-top: 1px solid #1a1a1a;
            border-bottom: 1px solid #1a1a1a;
            position: relative;
        }
        
        .scale-bar-line::before {
            content: '';
            position: absolute;
            left: 0;
            top: -2px;
            width: 2px;
            height: 7px;
            background: #4a7c59;
            border: 1px solid #1a1a1a;
        }
        
        .scale-bar-line::after {
            content: '';
            position: absolute;
            right: 0;
            top: -2px;
            width: 2px;
            height: 7px;
            background: #4a7c59;
            border: 1px solid #1a1a1a;
        }
        
        .scale-bar-text {
            color: #d4a574;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* North Arrow Control - No background box, just the image */
        .north-arrow-control {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            box-shadow: none !important;
        }
        
        /* North arrow should always be at top-left of map, regardless of screen size */
        /* Leaflet positions it relative to the map container, so it's always at top-left of map */
        .leaflet-top.leaflet-left {
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
        }
        
        /* Remove default Leaflet control margins for north arrow */
        .leaflet-top.leaflet-left .leaflet-control {
            margin: 0 !important;
            margin-top: 0 !important;
            margin-left: 0 !important;
        }
        
        /* Ensure north arrow control has no padding */
        .leaflet-top.leaflet-left .north-arrow-control {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure north arrow stays at top-left on all screen sizes - don't move it */
        @media (max-width: 768px) {
            .leaflet-top.leaflet-left {
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
            }
        }
        
        @media (max-width: 480px) {
            .leaflet-top.leaflet-left {
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
            }
        }
        
        @media (max-width: 360px) {
            .leaflet-top.leaflet-left {
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
            }
        }
        
        .north-arrow-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            -webkit-tap-highlight-color: transparent;
        }
        .north-arrow-img {
            width: 50px;
            height: 50px;
            display: block;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
        }
        /* Location popover - themed like EDS-B, toggle for current location */
        .location-popover {
            position: fixed;
            z-index: 100003;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #4a7c59;
            color: #d4a574;
            padding: 10px 14px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            max-width: 260px;
            line-height: 1.35;
            white-space: normal;
        }
        .location-popover-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .location-popover-toggle input[type="checkbox"] {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            margin: 0;
            accent-color: #4a7c59;
            cursor: pointer;
        }
        .location-popover-toggle label {
            cursor: pointer;
            user-select: none;
        }
        .location-popover.visible {
            display: block !important;
        }

        /* Ensure Leaflet controls container stays at bottom edge */
        .leaflet-bottom {
            position: absolute !important;
            bottom: 0 !important;
            z-index: 400 !important;
            pointer-events: none !important;
        }

        .leaflet-control {
            pointer-events: auto !important;
        }

        /* Compact attribution on all screen sizes */
        .leaflet-control-attribution {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Layer Control Styling */
        .leaflet-control-layers {
            background: rgba(10, 10, 10, 0.9) !important;
            border: 1px solid #4a7c59 !important;
            color: #a0a0a0 !important;
        }
        

        .leaflet-control-layers-expanded {
            padding: 10px !important;
            color: #a0a0a0 !important;
        }

        .leaflet-control-layers label {
            color: #a0a0a0 !important;
            font-family: 'Courier New', monospace !important;
            font-size: 11px !important;
        }

        .leaflet-control-layers input[type="radio"] {
            accent-color: #4a7c59 !important;
        }

        .leaflet-control-layers-selector {
            accent-color: #4a7c59 !important;
        }

        /* Custom Marker Styles */
        .tactical-marker {
            filter: drop-shadow(0 0 3px rgba(90, 138, 106, 0.6));
        }

        /* Acoustic node pulsing ring animation - toned down */
        @keyframes acousticPulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
                box-shadow: 0 0 0 0 rgba(74, 155, 157, 0.4);
            }
            50% {
                transform: scale(1.08);
                opacity: 0.6;
                box-shadow: 0 0 0 5px rgba(74, 155, 157, 0.2);
            }
            100% {
                transform: scale(1);
                opacity: 0.7;
                box-shadow: 0 0 0 0 rgba(74, 155, 157, 0);
            }
        }

        .acoustic-node-marker {
            width: 12px !important;
            height: 12px !important;
            background-color: #4A9B9D;
            border: 2px solid #3A7B7D;
            border-radius: 50%;
            position: relative;
            animation: acousticPulse 2s ease-in-out infinite;
        }

        /* Toggle controls */
        .toggle-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 2px 0;
        }
        
        .toggle-control span {
            flex: 1;
            text-align: left;
            font-size: 14px !important;
            color: #b0b0b0 !important;
            font-weight: 400 !important;
        }
        
        .toggle-control .toggle-switch {
            flex-shrink: 0;
            margin-left: auto;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #b0b0b0;
            font-weight: 400;
            cursor: pointer;
        }

        .radio-label input[type="radio"],
        .radio-label input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #4a7c59;
            cursor: pointer;
        }

        .radio-label span {
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #333;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background-color: #4a7c59;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        /* TDOA direction indicator - no border, fill only */
        .tdoa-direction-wedge {
            fill: rgba(74, 155, 157, 0.4);
            stroke: none;
            stroke-width: 0;
            cursor: pointer;
            transition: fill-opacity 0.3s ease;
        }
        
        /* Pulsing animation for directional wedges - radar ping effect (fill only) */
        @keyframes wedgePulse {
            0% {
                fill-opacity: var(--pulse-max-opacity, 0.7);
            }
            50% {
                fill-opacity: var(--pulse-min-opacity, 0.4);
            }
            100% {
                fill-opacity: var(--pulse-max-opacity, 0.7);
            }
        }
        
        .tdoa-direction-wedge.pulsing {
            animation: wedgePulse var(--pulse-duration, 1.5s) ease-in-out infinite;
        }

        /* Pulsing red animation for detection bubbles when drone is within range */
        /* Note: Leaflet circles use SVG, so we'll handle animation via JavaScript */

        /* Collapsible panel styling */
        .panel-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0;
            padding: 0;
        }

        .panel-header::after {
            content: '▼';
            font-size: 12px;
            color: #4a7c59;
            transition: transform 0.3s ease;
        }

        .panel-header.collapsed::after {
            transform: rotate(-90deg);
        }

        .panel-content {
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height 0.3s ease;
        }

        .panel-content.collapsed {
            max-height: 0 !important;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        /* Control Panel content grows to fit content, scrolls if exceeds viewport */

        /* Scrollbar Styling */
        .info-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: #4a7c59;
            border-radius: 3px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: #5a8a6a;
        }

        /* MQTT Control Panel (Bottom Left) */
        .mqtt-control-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 280px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #4a7c59;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .mqtt-control-panel .panel-header {
            padding: 10px 15px;
            background: rgba(26, 26, 26, 0.8);
            border-bottom: 1px solid #4a7c59;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            font-weight: bold;
            color: #d4a574;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .mqtt-control-panel .panel-header:hover {
            background: rgba(26, 26, 26, 0.95);
            color: #e4b584;
        }

        .mqtt-control-panel .panel-header.collapsed::after {
            content: ' ▼';
            float: right;
            font-size: 10px;
        }

        .mqtt-control-panel .panel-header:not(.collapsed)::after {
            content: ' ▲';
            float: right;
            font-size: 10px;
        }

        .mqtt-control-panel .panel-content {
            padding: 15px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .mqtt-control-panel .panel-content.collapsed {
            display: none;
        }

        .mqtt-control-panel .panel-content:not(.collapsed) {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .mqtt-control-panel .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .mqtt-control-panel .panel-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .mqtt-control-panel .panel-content::-webkit-scrollbar-thumb {
            background: #4a7c59;
            border-radius: 3px;
        }

        .mqtt-control-panel .panel-content::-webkit-scrollbar-thumb:hover {
            background: #5a8a6a;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .play-button {
            background: #1a1a1a;
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 8px 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            min-width: 80px;
            font-weight: 500;
        }

        .play-button:hover {
            background: #4a7c59;
            color: #ffffff;
        }

        .play-button.playing {
            background: #4a7c59;
            color: #ffffff;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .speed-control label {
            font-size: 14px;
            min-width: 60px;
            font-weight: 400;
        }

        .speed-control input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: #1a1a1a;
            border: 1px solid #4a7c59;
            outline: none;
        }

        .speed-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
        }

        .speed-control input[type="range"]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
        }

        .speed-value {
            font-size: 14px;
            color: #d4a574;
            min-width: 40px;
            text-align: right;
            font-weight: 400;
        }

        .timeline-container {
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            padding: 0 !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        .timeline-label {
            font-size: 13px;
            color: #b0b0b0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            gap: 10px;
            margin-bottom: 5px;
            width: 100%;
            box-sizing: border-box;
            padding: 0;
            font-weight: 400;
        }
        
        .timeline-label span:last-child {
            white-space: nowrap;
            flex-shrink: 0;
            font-weight: 400;
        }

        .timeline-slider {
            width: 100% !important;
            max-width: 100% !important;
            -webkit-appearance: none !important;
            appearance: none !important;
            height: 4px;
            background: #1a1a1a !important;
            border: 1px solid #4a7c59 !important;
            outline: none;
            box-sizing: border-box;
            margin: 0 !important;
            padding: 0 !important;
            display: block;
        }
        
        /* Override browser default blue fill for webkit sliders */
        .timeline-slider::-webkit-slider-runnable-track {
            height: 4px;
            -webkit-appearance: none !important;
            background: #1a1a1a !important;
            border: 1px solid #4a7c59 !important;
        }
        
        /* Ensure thumb is green */
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none !important;
            background: #5a8a6a !important;
        }

        .timeline-slider::-moz-range-track {
            height: 4px;
            background: #1a1a1a;
            border: 1px solid #4a7c59;
        }

        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
            border-radius: 50%;
            margin-top: -5px;
        }

        .timeline-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
            border-radius: 50%;
        }

        /* Style the filled portion of the timeline slider to match speed slider green color scheme */
        
        /* Acoustic timeline slider - same green color scheme */
        #acousticTimelineSlider {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: linear-gradient(to right, #4a7c59 0%, #4a7c59 var(--slider-progress, 0%), #1a1a1a var(--slider-progress, 0%));
            border: 1px solid #4a7c59;
            outline: none;
        }
        
        #acousticTimelineSlider::-webkit-slider-runnable-track {
            height: 4px;
            background: #1a1a1a;
            border: 1px solid #4a7c59;
        }
        
        #acousticTimelineSlider::-moz-range-track {
            height: 4px;
            background: #1a1a1a;
            border: 1px solid #4a7c59;
        }
        
        #acousticTimelineSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
            border-radius: 50%;
            margin-top: -5px;
        }
        
        #acousticTimelineSlider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #5a8a6a;
            cursor: pointer;
            border: 1px solid #4a7c59;
            border-radius: 50%;
        }
        

        .point-navigation .point-input-label {
            color: #888;
            font-size: 10px;
        }

        /* Messages List */
        .messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .message-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(26, 26, 26, 0.5);
            border-left: 3px solid #4a7c59;
            border-radius: 3px;
            font-size: 11px;
            color: #b0b0b0;
        }

        .message-item .message-time {
            color: #d4a574;
            font-weight: 500;
            margin-bottom: 3px;
        }

        .message-item .message-text {
            color: #b0b0b0;
        }

        /* Subtle flashing light effect */
        @keyframes pulseRing {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.8);
                opacity: 0.3;
            }
            100% {
                transform: translate(-50%, -50%) scale(2.2);
                opacity: 0;
            }
        }

        /* Flight marker container - matching MQTT branch implementation */
        .flight-marker-container {
            background: transparent !important;
            border: none !important;
            position: relative;
            width: 24px !important;
            height: 24px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .leaflet-div-icon.flight-marker-container {
            background: transparent !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Ensure Leaflet's automatic positioning works correctly */
        /* Leaflet automatically applies margin-left: -12px and margin-top: -12px based on iconAnchor [12, 12] */
        /* Don't override Leaflet's automatic margins - they're calculated from iconAnchor */

        /* Pulsing ring of light - centered at exact center of 24x24 container */
        .pulsing-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -5px;
            margin-left: -5px;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(220, 20, 60, 0.9);
            border-radius: 50%;
            animation: pulseRing 1s ease-out infinite;
            pointer-events: none;
            transform-origin: center center;
            margin: 0 !important;
        }

        /* Center dot - smaller, perfectly centered at exact center of 24x24 container */
        .marker-center {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -3px;
            margin-left: -3px;
            width: 6px;
            height: 6px;
            background-color: #DC143C;
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(220, 20, 60, 1), 0 0 12px rgba(220, 20, 60, 0.6);
            z-index: 10;
            margin: 0 !important;
        }
        
        /* Drone label container with pointer line */
        .drone-label-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drone-label-pointer {
            width: 0;
            height: 0;
            border-top: 2px solid transparent;
            border-bottom: 2px solid transparent;
            border-right: 8px solid rgba(220, 20, 60, 0.4);
        }
        
        /* Drone label styling - military operational style */
        .drone-label {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: bold;
            color: #DC143C;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(220, 20, 60, 0.4);
            padding: 4px 8px;
            white-space: nowrap;
            pointer-events: none;
            text-shadow: 0 0 3px rgba(220, 20, 60, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        
        /* Home Point Marker and Label Styles */
        .home-point-marker {
            background: transparent;
            border: none;
        }
        
        .home-point-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #5a8a6a;
            border: 2px solid #5a8a6a;
            box-shadow: 0 0 5px rgba(90, 138, 106, 0.6);
        }
        
        .drone-location-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -4px;
            margin-left: -4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff0000;
            border: 1px solid #ff0000;
            box-shadow: 0 0 3px rgba(255, 0, 0, 0.8);
            z-index: 10;
        }
        
        .drone-location-pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -6px;
            margin-left: -6px;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 0, 0, 0.9);
            border-radius: 50%;
            animation: dronePulse 1.5s ease-out infinite;
            pointer-events: none;
            transform-origin: center center;
        }
        
        @keyframes dronePulse {
            0% {
                transform: scale(1);
                opacity: 0.9;
            }
            50% {
                transform: scale(2);
                opacity: 0.3;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        /* Detected aircraft (ADS-B) marker: Unicode plane ✈ (native points right/90° in most fonts) */
        .aircraft-marker-plane {
            display: inline-block;
            font-size: 26px;
            line-height: 1;
            transform-origin: 50% 50%;
            pointer-events: none;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.6));
        }
        .aircraft-marker-wrapper {
            display: block;
            width: 34px;
            height: 34px;
            margin-left: -17px;
            margin-top: -17px;
            pointer-events: auto;
        }
        
        .home-point-label-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .home-point-label-pointer {
            width: 0;
            height: 0;
            border-top: 2px solid transparent;
            border-bottom: 2px solid transparent;
            border-right: 8px solid rgba(90, 138, 106, 0.4);
        }
        
        .home-point-label {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: bold;
            color: #5a8a6a;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(90, 138, 106, 0.4);
            padding: 4px 8px;
            white-space: nowrap;
            pointer-events: none;
            text-shadow: 0 0 3px rgba(90, 138, 106, 0.6);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        
        /* Node label container with pointer line - simple version matching drone label */
        .node-label-container-simple {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Node label container with proximity text - pixel-based positioning */
        .node-label-container-with-proximity {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .node-label-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .node-label-row-simple {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Node label container with pointer line - for proximity text version */
        .node-label-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .node-label-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .node-label-pointer {
            width: 0;
            height: 0;
            border-top: 2px solid transparent;
            border-bottom: 2px solid transparent;
            border-right: 8px solid rgba(74, 155, 157, 0.4);
        }
        
        .node-label-distance {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            font-weight: normal;
            color: #a0a0a0;
            text-transform: none;
            letter-spacing: 0.5px;
            padding: 2px 0 0 0;
            margin-left: 16px; /* Align with label text (8px pointer + 8px gap) */
            white-space: nowrap;
            pointer-events: none;
            flex-shrink: 0;
        }

        /* Proximity arrow styling */
        .proximity-arrow {
            display: inline-block;
            margin-left: 5px;
            font-size: 12px;
            color: #ffffff; /* White color for chevrons */
        }
        
        .node-proximity-container {
            display: flex;
            align-items: flex-start;
            padding-left: 16px; /* Align with label text (8px pointer + 8px gap) */
        }
        
        .node-label-pointer-left {
            width: 0;
            height: 0;
            border-top: 2px solid transparent;
            border-bottom: 2px solid transparent;
            border-left: 8px solid rgba(74, 155, 157, 0.4);
        }
        
        /* Node label styling - military operational style with cyan/teal colors */
        .node-label {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: bold;
            color: #4A9B9D;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(10, 10, 10, 0.85);
            border: 1px solid rgba(74, 155, 157, 0.4);
            padding: 4px 8px;
            white-space: nowrap;
        }
        
        .node-label-text {
            white-space: nowrap;
        }
        
        .node-label-distance {
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            font-weight: normal;
            color: #a0a0a0;
            text-transform: none;
            letter-spacing: 0.5px;
            padding: 2px 0 0 0;
            margin-left: 16px; /* Align with label text (8px pointer + 8px gap) */
            white-space: nowrap;
            pointer-events: none;
            flex-shrink: 0;
        }

        /* Remove default Leaflet icon styling */
        .leaflet-div-icon {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        /* Toast Notification */
        /* 3D Flight Profile Viewer Modal */
        .flight-profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .flight-profile-modal-content {
            background: rgba(10, 10, 10, 0.98);
            border: 2px solid #4a7c59;
            border-radius: 8px;
            padding: 20px;
            width: 95%;
            max-width: 95vw;
            max-height: 95vh;
            height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
        }
        
        .flight-profile-content-wrapper {
            display: flex;
            flex-direction: row;
            flex: 1;
            gap: 20px;
            overflow: hidden;
        }
        
        .flight-profile-canvas {
            flex: 1;
            min-width: 0;
            position: relative;
            background: #0a0a0a;
            border: 1px solid #4a7c59;
            border-radius: 4px;
        }
        
        
        .flight-profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #4a7c59;
        }
        
        .flight-profile-modal-header h3 {
            color: #d4a574;
            font-size: 18px;
            margin: 0;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .flight-profile-modal-header > div {
            flex: 1;
            text-align: center;
            margin-top: 5px;
        }
        
        .flight-profile-ranges {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
            color: #a0a0a0;
            font-family: 'Courier New', monospace;
            margin: 0 20px;
        }
        
        .flight-profile-ranges span {
            white-space: nowrap;
        }
        
        .flight-profile-instructions {
            font-size: 14px;
            color: #888;
            margin-left: auto;
            margin-right: 20px;
        }
        
        .flight-profile-close {
            background: transparent;
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            font-size: 24px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        /* Mobile optimization for 3D Flight Profile Viewer */
        @media (max-width: 768px) {
            .flight-profile-modal-content {
                width: 98%;
                max-width: 98vw;
                height: 98vh;
                max-height: 98vh;
                padding: 15px;
            }
            
            .flight-profile-content-wrapper {
                flex-direction: column;
                gap: 10px;
            }
            
            .flight-profile-canvas {
                min-height: 60vh;
                flex: 1;
            }
            
            .flight-profile-modal-header {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .flight-profile-modal-header h3 {
                font-size: 14px;
                letter-spacing: 1px;
            }
            
            .flight-profile-ranges {
                flex-wrap: wrap;
                gap: 10px;
                font-size: 10px;
                margin: 0;
            }
            
            .flight-profile-instructions {
                font-size: 11px;
                margin: 0;
                width: 100%;
                text-align: center;
            }
            
            .flight-profile-close {
                width: 28px;
                height: 28px;
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .flight-profile-modal-content {
                width: 100%;
                max-width: 100vw;
                height: 100vh;
                max-height: 100vh;
                padding: 10px;
                border-radius: 0;
            }
            
            .flight-profile-modal-header h3 {
                font-size: 12px;
            }
            
            .flight-profile-ranges {
                font-size: 9px;
                gap: 8px;
            }
            
            .flight-profile-instructions {
                font-size: 10px;
            }
            
            .flight-profile-canvas {
                min-height: 50vh;
            }
        }
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
        }
        
        .flight-profile-close:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        .flight-profile-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .flight-profile-arrow {
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #4a7c59;
            color: #b0b0b0;
            padding: 8px 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            min-width: 60px;
        }
        
        .flight-profile-arrow:hover {
            background: rgba(26, 26, 26, 0.95);
            border-color: #5a8a6a;
            color: #d4a574;
        }
        
        /* Duplicate .flight-profile-canvas rule removed - using the one in flight-profile-content-wrapper section */
        
        .toast-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .toast {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #4A9B9D;
            color: #a0a0a0;
            padding: 12px 18px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: auto;
            max-width: 300px;
            word-wrap: break-word;
        }

        /* User current location popup - match site theme */
        .leaflet-popup.user-location-popup .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid #4a7c59;
            color: #d4a574;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .leaflet-popup.user-location-popup .leaflet-popup-tip {
            background: rgba(10, 10, 10, 0.98);
        }

        /* Popup OpenSky link - touch-friendly on mobile */
        .leaflet-popup-content .popup-opensky-link {
            display: inline-block;
            margin-top: 8px;
            padding: 10px 14px;
            min-height: 44px;
            box-sizing: border-box;
            line-height: 1.3;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.hide {
            opacity: 0;
            transform: translateX(100%);
        }

        /* Toast and popups - mobile */
        @media (max-width: 768px) {
            .toast-container {
                top: 56px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            .toast {
                max-width: 100%;
                font-size: 13px;
                padding: 14px 16px;
            }
        }
        @media (max-width: 480px) {
            .toast-container {
                top: 52px;
                right: 8px;
                left: 8px;
            }
            .toast {
                font-size: 12px;
                padding: 12px 14px;
            }
            .leaflet-popup-content {
                max-width: min(280px, calc(100vw - 32px));
            }
        }
        
        /* Mobile Optimizations - Header rules removed to prevent buttons from dropping */
        @media screen and (max-width: 768px) {
            
            /* Touch-friendly buttons */
            .tactical-button,
            .play-button {
                min-height: 44px;
                font-size: 12px;
                padding: 10px 15px;
                touch-action: manipulation;
            }
            
            
            /* Toggle switches - larger touch targets */
            .toggle-switch {
                min-width: 50px;
                min-height: 28px;
            }
            
            .toggle-switch::after {
                width: 24px;
                height: 24px;
            }
            
            /* Toggle controls */
            .toggle-control {
                min-height: 44px;
                font-size: 12px;
            }
            
            /* Speed control */
            .speed-control {
                min-height: 44px;
            }
            
            .speed-control input[type="range"] {
                min-height: 44px;
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Timeline sliders */
            .timeline-container input[type="range"],
            #timelineSlider,
            #acousticTimelineSlider {
                min-height: 44px;
                -webkit-appearance: none;
                appearance: none;
            }
            
            /* Timeline labels */
            .timeline-label {
                font-size: 11px;
            }
            
            /* Info panel adjustments */
            .info-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: calc(100% - 20px);
                padding: 10px;
                font-size: 11px;
            }
            
            /* Legend panel */
            .legend-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                min-width: auto;
                max-width: calc(100% - 20px);
                padding: 10px;
                font-size: 10px;
            }
            
            .legend-item {
                margin-bottom: 6px;
                font-size: 12px;
            }
            
            /* Radio group */
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .radio-label {
                min-height: 44px;
                font-size: 12px;
            }
            
            /* Node labels - smaller on mobile */
            .node-label {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .node-label-distance {
                font-size: 9px;
            }
            
            /* Prevent text selection on touch */
            .tactical-button,
            .play-button,
            .toggle-switch,
            button {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                user-select: none;
            }
            
            /* Leaflet controls positioning on mobile */
            .leaflet-bottom {
                bottom: 0 !important;
            }

            .leaflet-control-attribution {
                font-size: 8px !important;
                padding: 2px 4px !important;
                line-height: 1.2 !important;
            }
        }

        /* Tablet sizes (iPad, iPad Pro) */
        @media screen and (min-width: 481px) and (max-width: 1366px) {
            /* Ensure Leaflet controls stay tight at bottom */
            .leaflet-bottom {
                bottom: 0 !important;
                z-index: 400 !important;
            }

            .leaflet-control-attribution {
                font-size: 9px !important;
                padding: 3px 6px !important;
                margin: 0 !important;
                max-width: 100% !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .leaflet-bottom {
                z-index: 400 !important;
            }

            /* Ensure attribution text wraps or truncates properly */
            .leaflet-control-attribution {
                word-break: break-word !important;
                hyphens: auto !important;
            }
        }

        /* Large tablets and small desktops (iPad Pro landscape, etc.) */
        @media screen and (min-width: 1024px) and (max-width: 1366px) {
            .leaflet-control-attribution {
                font-size: 10px !important;
                padding: 4px 8px !important;
            }

            /* Ensure controls stay at bottom edge */
            .leaflet-bottom {
                bottom: 0 !important;
            }

            /* Position attribution on left side to avoid control panel on right */
            .leaflet-bottom.leaflet-right {
                right: 0 !important;
            }

            .leaflet-bottom.leaflet-left {
                left: 0 !important;
            }
        }

        /* Ensure Leaflet controls are always visible and properly positioned */
        .leaflet-container .leaflet-control-container {
            position: relative !important;
        }

        /* When control panel is at bottom, ensure Leaflet controls are still accessible */
        .leaflet-control-attribution {
            position: relative !important;
            display: block !important;
            width: auto !important;
            max-width: 100% !important;
        }

        /* Global fix: Ensure Leaflet bottom controls always stay at bottom edge */
        .leaflet-container .leaflet-bottom {
            bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        /* Ensure attribution text doesn't overflow on any device */
        .leaflet-control-attribution {
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            hyphens: auto !important;
            line-height: 1.3 !important;
        }

        /* On all screen sizes, keep controls compact and at bottom */
        @media screen and (min-width: 481px) {
            .leaflet-control-attribution {
                font-size: 9px !important;
                padding: 3px 6px !important;
            }
        }
        
        @media screen and (max-width: 480px) {
            /* Extra small screens - Header rules removed to prevent buttons from dropping */
            
            .tactical-button,
            .play-button {
                font-size: 11px;
                padding: 8px 12px;
            }
            
            .toggle-control span {
                font-size: 11px;
            }
        }
        
        /* Prevent zoom on double tap for iOS */
        * {
            touch-action: manipulation;
        }
        
        /* Better touch targets for interactive elements */
        @media (hover: none) and (pointer: coarse) {
            button,
            .toggle-switch,
            input[type="range"],
            select {
                min-height: 44px;
            }
            
            a,
            .leaflet-control a {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
        
        /* Mobile responsive styles - progressive hiding and reorganization */
        @media (max-width: 1200px) {
            /* Hide tagline first as window gets smaller */
            .header-center {
                display: none !important;
            }
        }
        
        @media (max-width: 900px) {
            /* Hide subtitle text next */
            .tactical-header h1 span {
                display: none !important;
            }
        }
        
        /* REMOVED: This conflicting media query was causing buttons to drop and north arrow to move */
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- EDS-B tooltip popover (hover + click) -->
    <div id="edsbTooltipPopover" class="edsb-tooltip-popover" aria-hidden="true">Eagle Dependent Surveillance Broadcast</div>
    <!-- Location popover: shown when north arrow is clicked; toggle to show/hide current location -->
    <div id="locationPopover" class="location-popover" aria-hidden="true" style="display: none;">
        <div class="location-popover-toggle">
            <input type="checkbox" id="viewLocationToggle" autocomplete="off">
            <label for="viewLocationToggle">View your current location on the map</label>
        </div>
    </div>
    
    <!-- Header -->
    <div class="tactical-header">
        <div class="header-left">
            <a href="https://www.eagleeyessearch.com/" class="logo-link" title="Eagle Eyes Search Home">
                <img src="images/eagle-eyes-beta-logo-new.png" alt="Eagle Eyes Logo">
            </a>
            <h1>Public Drone Map <span id="edsbTitleTrigger" class="edsb-tooltip-trigger" style="font-size: 0.6em; font-weight: normal; color: #888; cursor: pointer;">EDS-B</span></h1>
        </div>
        <div class="header-center">
            <span id="taglineText" class="tagline-text"></span>
        </div>
        <div class="map-control-container">
            <span class="download-text"><span class="download-text-lines">To share your drone's<br>live location for free</span><span class="download-arrow" aria-hidden="true">➜</span></span>
            <button id="downloadBtn" onclick="window.location.href='/download/#step3&platform=mobile'">Download<br>Eagle Eyes</button>
            <button id="legendBtn" onclick="toggleLegend()">Legend</button>
            <div id="baseMapControl" style="position: relative; display: inline-block; z-index: 100002;">
                <button id="baseMapBtn" onclick="toggleBaseMapMenu()" title="Base Map Layers">☰</button>
                <div id="baseMapMenu" class="base-map-menu" style="display: none; position: absolute; top: calc(100% + 5px); right: 0; z-index: 999999;">
                    <div class="base-map-option" onclick="handleBaseMapChange('Google Hybrid'); toggleBaseMapMenu();">Google Hybrid</div>
                    <div class="base-map-option" onclick="handleBaseMapChange('Google Imagery'); toggleBaseMapMenu();">Google Imagery</div>
                    <div class="base-map-option" onclick="handleBaseMapChange('Esri Imagery'); toggleBaseMapMenu();">Esri Imagery</div>
                    <div class="base-map-option" onclick="handleBaseMapChange('Esri Topo'); toggleBaseMapMenu();">Esri Topo</div>
                <div class="base-map-option" onclick="handleBaseMapChange('Dark Theme'); toggleBaseMapMenu();">Dark Theme</div>
                <div class="base-map-option" onclick="handleBaseMapChange('Light Theme'); toggleBaseMapMenu();">Light Theme</div>
                <div class="base-map-option base-map-toggle" id="toggleDetectedAircraftOption">
                    <input type="checkbox" id="toggleDetectedAircraftCheckbox" checked title="Show or hide detected manned aircraft on the map">
                    <label for="toggleDetectedAircraftCheckbox">Detected manned aircraft <span style="white-space: nowrap;">(ADS-B)</span></label>
                </div>
                </div>
            </div>
            <div class="status-indicator">
                <span id="edsbNetworkTrigger" class="status-text edsb-tooltip-trigger" style="cursor: pointer;">EDS-B Network:</span>
                <div class="status-dot" id="mqttStatusDot"></div>
                <span class="status-text status-text-right" id="mqttStatusText">DISCONNECTED</span>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Legend Panel -->
    <div class="legend-panel" id="legendPanel">
        <div class="legend-item" data-legend="acoustic-vector" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-line" style="border-color: #0066ff;"></div>
            </div>
            <span>Acoustic estimate vector</span>
        </div>
        <div class="legend-item" data-legend="home-point-location" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-dot" style="background-color: #5a8a6a; border: 2px solid #5a8a6a;"></div>
            </div>
            <span>Home point location</span>
        </div>
        <div class="legend-item" data-legend="drone-location" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-dot" style="background-color: #ff6b6b; border: 2px solid #ff6b6b;"></div>
            </div>
            <span>Drone location</span>
        </div>
        <div class="legend-item" data-legend="mqtt-drones">
            <div class="legend-symbol legend-drone-pulse-wrap">
                <div class="drone-location-pulse"></div>
                <div class="drone-location-circle"></div>
            </div>
            <span>Drone live location</span>
        </div>
        <div class="legend-item" data-legend="detected-aircraft" style="display: none;">
            <div class="legend-symbol">
                <span class="aircraft-marker-plane" style="color: #00CED1;">✈</span>
            </div>
            <span>Detected manned aircraft (ADS-B)</span>
        </div>
        <div class="legend-item" data-legend="user-location" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-dot" style="background-color: #2563eb; border: 2px solid #1d4ed8;"></div>
            </div>
            <span>Your current location</span>
        </div>
        <div class="legend-item" data-legend="edsb-locations" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-dot" style="background-color: #4A9B9D; border: 2px solid #3A7B7D;"></div>
            </div>
            <span>EDSB locations</span>
        </div>
        <div class="legend-item" data-legend="detection-bubble" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-circle" style="border-color: #4A9B9D; background-color: rgba(74, 155, 157, 0.1);"></div>
            </div>
            <span>Detection bubble</span>
        </div>
        <div class="legend-item" data-legend="mesh-network" style="display: none;">
            <div class="legend-symbol">
                <div class="legend-line" style="border-color: #4A9B9D; opacity: 0.4; border-style: dashed;"></div>
            </div>
            <span>Mesh Network</span>
        </div>
    </div>

    <!-- 3D Flight Profile Viewer Modal -->
    <div id="flightProfileModal" class="flight-profile-modal" style="display: none;">
        <div class="flight-profile-modal-content">
            <div class="flight-profile-modal-header">
                <h3>3D Flight Profile</h3>
                <div id="flightProfileRanges" class="flight-profile-ranges"></div>
                <div class="flight-profile-instructions">Click and drag to rotate view</div>
                <button class="flight-profile-close" onclick="closeFlightProfileViewer()">&times;</button>
            </div>
            <div class="flight-profile-content-wrapper">
                <div id="flightProfileCanvas" class="flight-profile-canvas"></div>
            </div>
        </div>
    </div>

    <!-- Data Source panel removed as requested -->
    <!-- Flight Log Control panel removed as requested -->


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Paho MQTT JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <script>
        // Global map instance
        let map;
        let userLocationMarker = null; // Blue dot for user's current location
        let markers = {}; // Store markers by ID
        let updateInterval = null;
        let dataSourceUrl = '';
        
        // Keep flightLogs array to prevent EDS-B connection breakage
        let flightLogs = [];
        let legendVisible = false;
        
        // MQTT Configuration
        // Note: Android uses ssl://mqtt-telemetry.eagleeyessearch.com (TCP)
        // Web browsers need WebSocket endpoint - try common WebSocket ports/paths
        const MQTT_BROKER_URL = "wss://mqtt-telemetry.eagleeyessearch.com:8084"; // WebSocket URL for MQTT
        const MQTT_TOPIC = "public"; // Topic to subscribe to
        const MQTT_LICENSE_KEY = "letmein"; // License key for authentication
        let mqttClient = null;
        let mqttConnected = false;
        let mqttConnecting = false; // True while connect() is in progress to avoid double init
        let mqttReconnectTimeout = null;
        let mqttReconnectAttempts = 0;
        const MQTT_MAX_RECONNECT_DELAY = 30000; // Max 30 seconds between reconnect attempts
        let mqttDroneMarkers = {}; // Store MQTT drone markers by public_drone_id
        let mqttDronePaths = {}; // Store polylines for drone paths
        let mqttDroneData = {}; // Store latest telemetry data for each drone
        let mqttDroneLastUpdate = {}; // Store last update timestamp for each drone
        let mqttDroneTimeouts = {}; // Store timeout IDs for removing stale drones
        let mqttAircraftMarkers = {}; // key: "droneId:aircraftId" -> Leaflet marker
        const AIRCRAFT_STALE_MS = 30000; // Remove aircraft if last_update_ms older than 30 seconds
        let showDetectedAircraft = true; // Toggle in Map layers; when false, aircraft markers are hidden
        let hasShownConnectedToast = false; // Show "Connected to drone telemetry stream" only once per connection

        // Target drone tracking (from URL query parameter drone_public_id)
        let targetDronePublicId = null; // Drone ID to zoom to from URL
        let hasZoomedToTarget = false; // Track if we've already zoomed to target drone (only zoom once)


        // Base map layers
        let baseMaps = {};
        let currentBaseLayer = null;

        /**
         * Parse URL query parameters and extract target drone ID if present
         */
        function parseTargetDroneFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const droneId = urlParams.get('drone_public_id');
            if (droneId) {
                targetDronePublicId = droneId;
                console.log(`Target drone ID from URL: ${targetDronePublicId}`);
            }
        }

        // Initialize map
        function initMap() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded!');
                setTimeout(initMap, 100); // Retry after 100ms
                return;
            }
            
            // Check if map container exists
            const mapContainer = document.getElementById('map');
            if (!mapContainer) {
                console.error('Map container not found!');
                return;
            }
            
            console.log('Initializing map...');
            
            try {
                // Create map centered on a default location (can be changed)
                map = L.map('map', {
                    center: [49.3, -123.2], // Southern Vancouver Island and Lower Mainland
                    zoom: 8,
                    zoomControl: false, // Remove zoom controls
                    attributionControl: true,
                    maxZoom: 25 // Allow deeper zoom
                });

                // Google Hybrid Imagery (satellite + labels) - Default
                const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    attribution: '&copy; Google',
                    maxZoom: 25,
                    maxNativeZoom: 20
                });

                // Google Imagery (satellite only, no labels)
                const googleImagery = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    attribution: '&copy; Google',
                    maxZoom: 25,
                    maxNativeZoom: 20
                });

                // CartoDB Dark Matter (dark theme)
                const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 25
                });

                // CartoDB Positron (light theme)
                const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 25
                });

                // Esri World Imagery (military/operational style)
                const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; Esri',
                    maxZoom: 25,
                    maxNativeZoom: 19
                });

                // Esri World Topo (military topo style)
                const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '&copy; Esri',
                    maxZoom: 25,
                    maxNativeZoom: 19
                });

                // Set up base maps object
                baseMaps = {
                    "Dark Theme": cartoDark,
                    "Google Hybrid": googleHybrid,
                    "Google Imagery": googleImagery,
                    "Esri Imagery": esriImagery,
                    "Esri Topo": esriTopo,
                    "Light Theme": cartoLight
                };

                // Add default layer (Dark Theme)
                cartoDark.addTo(map);
                currentBaseLayer = cartoDark;

                // Close base map menu when clicking outside
                document.addEventListener('click', function(event) {
                    const baseMapBtn = document.getElementById('baseMapBtn');
                    const baseMapMenu = document.getElementById('baseMapMenu');
                    if (baseMapMenu && baseMapBtn && !baseMapBtn.contains(event.target) && !baseMapMenu.contains(event.target)) {
                        baseMapMenu.style.display = 'none';
                    }
                });
                
                // Add Scale Bar (bottom left)
                const ScaleBarControl = L.Control.extend({
                    onAdd: function(map) {
                        const container = L.DomUtil.create('div', 'scale-bar-control');
                        container.innerHTML = '<div class="scale-bar-content"><div class="scale-bar-line"></div><div class="scale-bar-text">0 km</div></div>';
                        L.DomEvent.disableClickPropagation(container);
                        // Store reference to this container for updates
                        this._container = container;
                        this.updateScale(map);
                        map.on('zoomend moveend', () => this.updateScale(map));
                        return container;
                    },
                    updateScale: function(map) {
                        const bounds = map.getBounds();
                        const center = bounds.getCenter();
                        const ne = bounds.getNorthEast();
                        const sw = bounds.getSouthWest();
                        const latDist = center.distanceTo([ne.lat, center.lng]);
                        const lngDist = center.distanceTo([center.lat, ne.lng]);
                        const maxDist = Math.max(latDist, lngDist);
                        
                        // Calculate appropriate scale
                        const containerWidth = 120; // pixels
                        const metersPerPixel = maxDist / (containerWidth / 2);
                        const scaleMeters = metersPerPixel * containerWidth;
                        
                        // Round to nice values
                        let displayValue, displayUnit;
                        if (scaleMeters >= 1000) {
                            displayValue = Math.round(scaleMeters / 1000);
                            displayUnit = 'km';
                        } else {
                            displayValue = Math.round(scaleMeters / 100) * 100;
                            displayUnit = 'm';
                        }
                        
                        // Use the stored container reference instead of querySelector
                        const scaleBar = this._container ? this._container.querySelector('.scale-bar-content') : null;
                        if (scaleBar) {
                            scaleBar.innerHTML = `<div class="scale-bar-line"></div><div class="scale-bar-text">${displayValue} ${displayUnit}</div>`;
                        }
                    }
                });
                const scaleBarInstance = new ScaleBarControl({ position: 'bottomleft' });
                scaleBarInstance.addTo(map);
                console.log('Scale bar control added to map:', scaleBarInstance);
                
                // North Arrow (top left) - user's white transparent SVG, clickable → location popover
                const NorthArrowControl = L.Control.extend({
                    onAdd: function(m) {
                        const container = L.DomUtil.create('div', 'north-arrow-control');
                        const content = L.DomUtil.create('div', 'north-arrow-content', container);
                        content.setAttribute('role', 'button');
                        content.setAttribute('aria-label', 'North arrow – click to show location option');
                        const img = document.createElement('img');
                        img.src = 'images/north_arrow_white_transparent.svg';
                        img.alt = 'North';
                        img.className = 'north-arrow-img';
                        content.appendChild(img);
                        L.DomEvent.disableClickPropagation(container);
                        L.DomEvent.addListener(content, 'click', function(e) {
                            L.DomEvent.stopPropagation(e);
                            const popover = document.getElementById('locationPopover');
                            if (!popover) return;
                            if (popover.classList.contains('visible')) {
                                popover.classList.remove('visible');
                                popover.style.display = 'none';
                                popover.setAttribute('aria-hidden', 'true');
                                return;
                            }
                            const rect = content.getBoundingClientRect();
                            popover.style.display = 'block';
                            popover.offsetHeight; // force reflow so offsetWidth is correct
                            const pw = popover.offsetWidth;
                            if (rect.right + 8 + pw <= window.innerWidth) {
                                popover.style.left = (rect.right + 8) + 'px';
                                popover.style.right = 'auto';
                            } else {
                                popover.style.left = Math.max(8, rect.left - pw - 8) + 'px';
                                popover.style.right = 'auto';
                            }
                            popover.style.top = rect.top + 'px';
                            popover.classList.add('visible');
                            popover.setAttribute('aria-hidden', 'false');
                        });
                        return container;
                    }
                });
                new NorthArrowControl({ position: 'topleft' }).addTo(map);

                // Location popover: toggle on = show current location (blue dot), toggle off = hide it
                (function() {
                    const popover = document.getElementById('locationPopover');
                    const toggle = document.getElementById('viewLocationToggle');
                    if (!popover || !toggle) return;
                    function hideLocationPopover() {
                        popover.classList.remove('visible');
                        popover.style.display = 'none';
                        popover.setAttribute('aria-hidden', 'true');
                    }
                    function showUserOnMap(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        if (userLocationMarker && map.hasLayer(userLocationMarker)) {
                            map.removeLayer(userLocationMarker);
                        }
                        userLocationMarker = L.circleMarker([lat, lng], {
                            radius: 7,
                            fillColor: '#2563eb',
                            color: '#1d4ed8',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);
                        userLocationMarker.bindPopup('Your current location.', {
                            className: 'user-location-popup',
                            closeButton: true
                        });
                        map.setView([lat, lng], Math.max(map.getZoom(), 14));
                        if (typeof updateLegendVisibility === 'function') updateLegendVisibility();
                    }
                    function onLocationError(err) {
                        toggle.checked = false;
                        const msg = err.code === 1 ? 'Location permission denied.' : (err.code === 2 ? 'Location unavailable.' : 'Could not get your location.');
                        showToast(msg);
                    }
                    toggle.addEventListener('change', function() {
                        if (toggle.checked) {
                            if (!navigator.geolocation) {
                                showToast('Geolocation is not supported by your browser.');
                                toggle.checked = false;
                                return;
                            }
                            navigator.geolocation.getCurrentPosition(showUserOnMap, onLocationError, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
                        } else {
                            if (userLocationMarker && map.hasLayer(userLocationMarker)) {
                                map.removeLayer(userLocationMarker);
                                userLocationMarker = null;
                            }
                            if (typeof updateLegendVisibility === 'function') updateLegendVisibility();
                        }
                    });
                    document.addEventListener('click', function(ev) {
                        if (!popover.classList.contains('visible')) return;
                        const arrow = document.querySelector('.north-arrow-content');
                        if (arrow && arrow.contains(ev.target)) return;
                        if (popover.contains(ev.target)) return;
                        hideLocationPopover();
                    });
                })();

                console.log('EDSB Map initialized');
                
                // Invalidate map size to ensure it renders properly
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                        console.log('Map size invalidated');
                    }
                }, 100);
                
                // Initialize MQTT connection for EDS-B data
                initMQTT();
            } catch (error) {
                console.error('Error initializing map:', error);
                showToast('Error initializing map: ' + error.message);
            }
        }
        
        // TDOA, Acoustic Estimate, and Detection Node functions removed - EDS-B only
        
        // Calculate horizontal distance between two lat/lng points using Haversine formula (used by MQTT path calculations)
        function calculateHorizontalDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in meters
        }

        // Toast Notification Function (used by MQTT error handling)
        function showToast(message, duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            
            // Trigger show animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto-hide after duration
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // TDOA, Acoustic Estimate, Detection Node, and processData functions removed - EDS-B/MQTT only
        
        function updateNodePopupsWithDistance() {
            // Stub - TDOA/detection nodes removed
            return;
        }
        
        function updateDirectionIndicator(dronePosition) {
            // Stub - directional indicators removed
            return;
        }
        
        function updateDirectionWedges(lat, lng) {
            // Stub - directional wedges removed
            return;
        }
        
        // All TDOA/Acoustic/Detection Node/Flight Log Playback functions removed - EDS-B/MQTT only
        
        // Stub functions to prevent errors if called from anywhere
        function addFlightLog(flightLogObj) {
            console.warn('Manual flight log import is disabled. This site is EDS-B only.');
            return;
        }
        function renderFlightLogPolyline(flightLog) { return; }
        function updateFlightLogsList() { return; }
        function selectFlightLog(id) { return; }
        function updateSelectedFlightLogMarkers() { return; }
        function toggleFlightLogVisibility(id, visible) { return; }
        function removeFlightLog(id) { return; }
        function showFlightLogPopup(flightLogOrId) { return; }
        function generateFlightLogColor(index) { return '#5a8a6a'; }
        function updateImportButtonCentering() { return; }
        function initializeAnalyticsCharts(flightLog) { return; }
        function drawFlightPath() { return; }
        function centerMapOnFlight() { return; }
        function updateTriangulationLines(droneLat, droneLng) { return; }
        function toggleTriangulationLines() { return; }
        function toggleAcousticTriangulationLine() { return; }
        function toggleDroneDirectionalIndicator() { return; }
        function toggleAcousticDirectionalIndicator() { return; }
        function updateDroneLabel(lat, lng) { return; }
        function toggleDroneLabel() { return; }
        function toggleDroneAltitude() { return; }
        function toggleHomePointLabel() { return; }
        function updateAcousticNodeLabel() { return; }
        function updateNodeLabel(nodeId) { return; }
        function updateFlightPosition(index) { return; }
        function toggleFlightLogPlayback() { return; }
        function startFlightLogPlayback() { return; }
        function stopFlightLogPlayback() { return; }
        function resetFlightLogPlayback() { return; }
        function updateMeshNetwork() { return; }
        function updateDetectionBubbles() { return; }
        function updateToggleVisibility() { return; }
        
        // Export stubs to window for backward compatibility
        window.selectFlightLog = selectFlightLog;
        window.toggleFlightLogVisibility = toggleFlightLogVisibility;
        window.removeFlightLog = removeFlightLog;
        window.showFlightLogPopup = showFlightLogPopup;
        window.toggleTriangulationLines = toggleTriangulationLines;
        window.toggleAcousticTriangulationLine = toggleAcousticTriangulationLine;
        window.toggleDroneDirectionalIndicator = toggleDroneDirectionalIndicator;
        window.toggleAcousticDirectionalIndicator = toggleAcousticDirectionalIndicator;
        window.toggleDroneLabel = toggleDroneLabel;
        window.toggleDroneAltitude = toggleDroneAltitude;
        window.toggleHomePointLabel = toggleHomePointLabel;
        
        // Helper functions kept for MQTT use only
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}m ${secs}s`;
        }

        function formatTimeHMS(timeValue) {
            let totalSeconds;
            if (timeValue > 1000000) {
                totalSeconds = timeValue / 1000;
            } else {
                totalSeconds = timeValue;
            }
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const h = hours.toString().padStart(2, '0');
            const m = minutes.toString().padStart(2, '0');
            const s = seconds.toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        // Update legend to show only MQTT drones and detected aircraft (EDS-B only)
        function updateLegendVisibility() {
            // MQTT Drones - always show (main feature)
            const mqttDronesItem = document.querySelector('[data-legend="mqtt-drones"]');
            if (mqttDronesItem) {
                mqttDronesItem.style.display = 'flex';
            }
            // Detected aircraft - show when any aircraft exist and the layer is on
            const detectedAircraftItem = document.querySelector('[data-legend="detected-aircraft"]');
            if (detectedAircraftItem) {
                detectedAircraftItem.style.display = (Object.keys(mqttAircraftMarkers).length > 0 && showDetectedAircraft) ? 'flex' : 'none';
            }
            // Your current location - show when the blue dot is on the map
            const userLocationItem = document.querySelector('[data-legend="user-location"]');
            if (userLocationItem) {
                const showUserLoc = userLocationMarker && map && map.hasLayer(userLocationMarker);
                userLocationItem.style.display = showUserLoc ? 'flex' : 'none';
            }
            
            // Hide all other legend items (TDOA/Acoustic features removed)
            const itemsToHide = [
                '[data-legend="acoustic-vector"]',
                '[data-legend="home-point-location"]',
                '[data-legend="drone-location"]',
                '[data-legend="edsb-locations"]',
                '[data-legend="detection-bubble"]',
                '[data-legend="mesh-network"]'
            ];
            itemsToHide.forEach(selector => {
                const item = document.querySelector(selector);
                if (item) item.style.display = 'none';
            });
            
            // Hide flight logs legend container
            const flightLogsLegendContainer = document.getElementById('flightLogsLegendContainer');
            if (flightLogsLegendContainer) {
                flightLogsLegendContainer.style.display = 'none';
                flightLogsLegendContainer.innerHTML = '';
            }
        }
        window.updateLegendVisibility = updateLegendVisibility;

        // Initialize on page load
        // Legend toggle function
        function toggleLegend() {
            legendVisible = !legendVisible;
            const legendPanel = document.getElementById('legendPanel');
            const legendBtn = document.getElementById('legendBtn');
            
            if (legendPanel && legendBtn) {
                if (legendVisible) {
                    updateLegendVisibility(); // Update legend when opening
                    legendPanel.classList.add('visible');
                    legendBtn.textContent = 'Hide Legend';
                } else {
                    legendPanel.classList.remove('visible');
                    legendBtn.textContent = 'Legend';
                }
            }
        }
        
        // Base Map Menu Toggle
        function toggleBaseMapMenu() {
            const baseMapMenu = document.getElementById('baseMapMenu');
            if (baseMapMenu) {
                if (baseMapMenu.style.display === 'none' || baseMapMenu.style.display === '') {
                    baseMapMenu.style.display = 'block';
                } else {
                    baseMapMenu.style.display = 'none';
                }
            }
        }
        
        // Handle Base Map Change
        function handleBaseMapChange(layerName) {
            if (!baseMaps || !map) {
                console.error('Map or baseMaps not initialized');
                return;
            }
            
            const newLayer = baseMaps[layerName];
            if (!newLayer) {
                console.error('Layer not found:', layerName);
                return;
            }
            
            // Remove current base layer
            if (currentBaseLayer) {
                map.removeLayer(currentBaseLayer);
            }
            
            // Add new base layer
            newLayer.addTo(map);
            currentBaseLayer = newLayer;
            
            console.log('Base map changed to:', layerName);
        }

        /**
         * Set detected manned aircraft (ADS-B) visibility from the layer checkbox. Called on checkbox change.
         */
        function setDetectedAircraftVisibility(visible) {
            showDetectedAircraft = visible;
            const checkbox = document.getElementById('toggleDetectedAircraftCheckbox');
            if (checkbox) checkbox.checked = showDetectedAircraft;
            if (!map) return;
            Object.values(mqttAircraftMarkers).forEach(marker => {
                if (showDetectedAircraft) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
            updateLegendVisibility();
        }
        
        // ==================== MQTT Functions ====================

        /**
         * Initialize and connect to MQTT broker
         */
        function initMQTT() {
            // Avoid double connection when init is called multiple times (e.g. DOMContentLoaded + retry)
            if (mqttConnected || mqttConnecting) return;

            // Check if Paho MQTT library is loaded
            if (typeof Paho === 'undefined' || !Paho.MQTT || !Paho.MQTT.Client) {
                console.error('Paho MQTT library not loaded yet');
                const headerStatusText = document.getElementById('mqttStatusText');
                const headerStatusDot = document.getElementById('mqttStatusDot');
                if (headerStatusText) {
                    headerStatusText.textContent = 'LIBRARY ERROR';
                    headerStatusText.style.color = '#dc143c';
                }
                if (headerStatusDot) {
                    headerStatusDot.className = 'status-dot failed';
                }
                // Retry after 1 second
                setTimeout(() => {
                    initMQTT();
                }, 1000);
                return;
            }

            try {
                // Create a client instance with random client ID
                const clientId = "eagle_eyes_web_" + Math.random().toString(16).substr(2, 8);

                // Extract hostname and port from WebSocket URL
                // Format: wss://mqtt-telemetry.eagleeyessearch.com:8084
                const url = new URL(MQTT_BROKER_URL);
                const hostname = url.hostname;
                const port = parseInt(url.port) || (url.protocol === 'wss:' ? 443 : 80);
                // Try common WebSocket paths: /, /mqtt, /ws
                let path = url.pathname && url.pathname !== '/' ? url.pathname : '/mqtt';

                console.log(`Connecting to MQTT broker: ${hostname}:${port}${path}`);
                console.log(`Full WebSocket URL would be: ${url.protocol}//${hostname}:${port}${path}`);

                mqttClient = new Paho.MQTT.Client(hostname, port, path, clientId);

                // Set callback handlers
                mqttClient.onConnectionLost = onMQTTConnectionLost;
                mqttClient.onMessageArrived = onMQTTMessageArrived;

                // Connect options
                const connectOptions = {
                    useSSL: url.protocol === 'wss:',
                    userName: MQTT_LICENSE_KEY,
                    password: MQTT_LICENSE_KEY,
                    keepAliveInterval: 60,
                    cleanSession: true,
                    onSuccess: onMQTTConnect,
                    onFailure: onMQTTConnectFailure
                };

                // Connect to broker
                mqttConnecting = true;
                mqttClient.connect(connectOptions);

                console.log('MQTT connection initiated...');
            } catch (error) {
                console.error('Error initializing MQTT:', error);
                showToast('MQTT initialization failed: ' + error.message);
                
                // If connection fails with /mqtt path, try fallback to /
                if (path === '/mqtt') {
                    console.log('Retrying with fallback path: /');
                    setTimeout(() => {
                        try {
                            const fallbackClientId = "eagle_eyes_web_" + Math.random().toString(16).substr(2, 8);
                            const url = new URL(MQTT_BROKER_URL);
                            const hostname = url.hostname;
                            const port = parseInt(url.port) || (url.protocol === 'wss:' ? 443 : 80);
                            mqttClient = new Paho.MQTT.Client(hostname, port, '/', fallbackClientId);
                            mqttClient.onConnectionLost = onMQTTConnectionLost;
                            mqttClient.onMessageArrived = onMQTTMessageArrived;
                            const fallbackOptions = {
                                useSSL: url.protocol === 'wss:',
                                userName: MQTT_LICENSE_KEY,
                                password: MQTT_LICENSE_KEY,
                                keepAliveInterval: 60,
                                cleanSession: true,
                                onSuccess: onMQTTConnect,
                                onFailure: onMQTTConnectFailure
                            };
                            mqttConnecting = true;
                            mqttClient.connect(fallbackOptions);
                        } catch (fallbackError) {
                            console.error('Fallback connection also failed:', fallbackError);
                            attemptMQTTReconnect();
                        }
                    }, 1000);
                } else {
                    attemptMQTTReconnect();
                }
            }
        }

        /**
         * Called when MQTT connection is established.
         * Defer subscribe so Paho client is fully in "connected" state (avoids AMQJS0011E Invalid state not connected).
         */
        function onMQTTConnect() {
            console.log('Connected to MQTT broker');
            mqttConnecting = false;
            mqttConnected = true;

            // Reset reconnection attempts on successful connection
            mqttReconnectAttempts = 0;
            if (mqttReconnectTimeout) {
                clearTimeout(mqttReconnectTimeout);
                mqttReconnectTimeout = null;
            }

            // Update header status indicator
            const headerStatusText = document.getElementById('mqttStatusText');
            const headerStatusDot = document.getElementById('mqttStatusDot');
            if (headerStatusText) {
                headerStatusText.textContent = 'CONNECTED';
                headerStatusText.style.color = '#5a8a6a';
            }
            if (headerStatusDot) {
                headerStatusDot.className = 'status-dot connected';
            }

            // Subscribe after a short delay so client is fully connected (Paho can fire onSuccess before state is "connected")
            setTimeout(function doSubscribe() {
                if (!mqttClient || !mqttConnected) return;
                try {
                    mqttClient.subscribe(MQTT_TOPIC, {
                        qos: 1,
                        onSuccess: function() {
                            console.log('Subscribed to MQTT topic: ' + MQTT_TOPIC);
                            if (!hasShownConnectedToast) {
                                hasShownConnectedToast = true;
                                showToast('Connected to drone telemetry stream');
                            }
                        },
                        onFailure: function(err) {
                            const msg = (err && (err.errorMessage || err.errorCode || err.message || String(err))) || 'unknown';
                            console.error('Failed to subscribe to topic:', msg, err);
                            showToast('Failed to subscribe to telemetry topic');
                        }
                    });
                } catch (error) {
                    console.error('Error subscribing to topic:', error.message || error, error);
                }
            }, 400);
        }

        /**
         * Called when MQTT connection fails
         */
        function onMQTTConnectFailure(error) {
            console.error('MQTT connection failed:', error);
            mqttConnecting = false;
            mqttConnected = false;

            // Update header status indicator
            const headerStatusText = document.getElementById('mqttStatusText');
            const headerStatusDot = document.getElementById('mqttStatusDot');
            if (headerStatusText) {
                headerStatusText.textContent = 'CONNECTION FAILED';
                headerStatusText.style.color = '#dc143c';
            }
            if (headerStatusDot) {
                headerStatusDot.className = 'status-dot failed';
            }

            showToast('MQTT connection failed: ' + (error.errorMessage || 'Unknown error'));

            // Attempt reconnection with exponential backoff
            attemptMQTTReconnect();
        }

        /**
         * Called when MQTT connection is lost
         */
        function onMQTTConnectionLost(responseObject) {
            console.log('MQTT connection lost');
            mqttConnected = false;
            hasShownConnectedToast = false; // Allow toast again on next connect

            // Update header status indicator
            const headerStatusText = document.getElementById('mqttStatusText');
            const headerStatusDot = document.getElementById('mqttStatusDot');
            if (headerStatusText) {
                headerStatusText.textContent = 'DISCONNECTED';
                headerStatusText.style.color = '#d4a574';
            }
            if (headerStatusDot) {
                headerStatusDot.className = 'status-dot disconnected';
            }

            if (responseObject.errorCode !== 0) {
                console.error('MQTT connection lost:', responseObject.errorMessage);
                showToast('Drone telemetry connection lost. Attempting to reconnect...');
            }

            // Attempt reconnection with exponential backoff
            attemptMQTTReconnect();
        }

        /**
         * Attempt to reconnect to MQTT broker with exponential backoff
         */
        function attemptMQTTReconnect() {
            if (mqttReconnectTimeout) {
                clearTimeout(mqttReconnectTimeout);
            }

            const delay = Math.min(1000 * Math.pow(2, mqttReconnectAttempts), 30000); // Max 30 seconds
            console.log(`MQTT reconnection attempt ${mqttReconnectAttempts + 1} in ${delay}ms...`);

            // Update status to show reconnecting
            const headerStatusText = document.getElementById('mqttStatusText');
            if (headerStatusText) {
                headerStatusText.textContent = 'RECONNECTING...';
                headerStatusText.style.color = '#d4a574';
            }

            mqttReconnectTimeout = setTimeout(() => {
                mqttReconnectAttempts++;
                console.log(`Attempting MQTT reconnection (attempt ${mqttReconnectAttempts})...`);
                
                if (typeof Paho !== 'undefined' && Paho.MQTT && Paho.MQTT.Client) {
                    initMQTT();
                } else {
                    console.error('Paho MQTT library not loaded, retrying...');
                    setTimeout(() => {
                        attemptMQTTReconnect();
                    }, 1000);
                }
            }, delay);
        }

        /**
         * Called when an MQTT message arrives
         */
        function onMQTTMessageArrived(message) {
            try {
                const payload = message.payloadString;
                const telemetryData = JSON.parse(payload);

                if (!telemetryData.type || telemetryData.type !== 'drone_telemetry') {
                    return;
                }

                if (!telemetryData.public_drone_id) {
                    return;
                }

                processDroneTelemetry(telemetryData);

            } catch (error) {
                console.error('Error processing MQTT message:', error);
            }
        }

        /**
         * Process incoming drone telemetry data
         */
        function processDroneTelemetry(telemetryData) {
            const droneId = telemetryData.public_drone_id;
            const droneName = telemetryData.drone_name || droneId;

            // Store latest telemetry data
            mqttDroneData[droneId] = telemetryData;
            
            // Update last update timestamp
            mqttDroneLastUpdate[droneId] = Date.now();
            
            // Clear existing timeout for this drone
            if (mqttDroneTimeouts[droneId]) {
                clearTimeout(mqttDroneTimeouts[droneId]);
                delete mqttDroneTimeouts[droneId];
            }
            
            // Set timeout to remove drone after 5 minutes of no updates
            mqttDroneTimeouts[droneId] = setTimeout(() => {
                removeMQTTDrone(droneId);
            }, 5 * 60 * 1000); // 5 minutes

            // Extract GPS location
            const gpsLocation = telemetryData.state?.drone_gps_location;
            if (!gpsLocation || !gpsLocation.lat || !gpsLocation.lng) {
                console.warn('Telemetry missing GPS location for drone:', droneId);
                return;
            }

            const lat = gpsLocation.lat;
            const lng = gpsLocation.lng;
            const altitude = gpsLocation.altitude_ahl_m || gpsLocation.altitude_asl_m || 0;

            // Update or create drone marker
            updateMQTTDroneMarker(droneId, droneName, lat, lng, altitude, telemetryData);

            // Update or create drone path
            updateMQTTDronePath(droneId, lat, lng);

            // Process detected_aircraft (ADS-B): show aircraft on map, lines to drone, remove stale
            // Accept top-level or state.detected_aircraft; snake_case and camelCase
            let rawAircraft = telemetryData.detected_aircraft ?? telemetryData.detectedAircraft ?? telemetryData.state?.detected_aircraft ?? telemetryData.state?.detectedAircraft;
            if (!Array.isArray(rawAircraft)) rawAircraft = [];
            const detectedAircraft = rawAircraft;
            const currentAircraftIds = new Set(detectedAircraft.map(a => (a && (a.id ?? a.icao ?? a.aircraft_id)) || null).filter(Boolean));
            const now = Date.now();
            // Remove aircraft for this drone that are no longer in the list
            Object.keys(mqttAircraftMarkers).forEach(key => {
                if (key.startsWith(droneId + ':')) {
                    const aircraftId = key.slice(droneId.length + 1);
                    if (!currentAircraftIds.has(aircraftId)) {
                        removeAircraftMarkerAndLine(key);
                    }
                }
            });
            detectedAircraft.forEach(aircraft => {
                const id = aircraft && (aircraft.id ?? aircraft.icao ?? aircraft.aircraft_id);
                if (!id) return;
                const lastUpdate = aircraft.last_update_ms != null ? aircraft.last_update_ms : now;
                if (now - lastUpdate > AIRCRAFT_STALE_MS) {
                    removeAircraftMarkerAndLine(droneId + ':' + id);
                    return;
                }
                updateOrCreateAircraftMarker(droneId, droneName, lat, lng, aircraft, id);
            });

            // Check if this is the target drone from URL and zoom to it (only once)
            if (targetDronePublicId && droneId === targetDronePublicId && !hasZoomedToTarget && map) {
                console.log(`Target drone ${droneId} found! Zooming to location: [${lat.toFixed(6)}, ${lng.toFixed(6)}]`);
                map.setView([lat, lng], 15); // Zoom to level 15 (good for drone tracking)
                hasZoomedToTarget = true; // Mark as zoomed so we don't zoom again

                // Open the popup to highlight the drone
                const marker = mqttDroneMarkers[droneId];
                if (marker) {
                    setTimeout(() => marker.openPopup(), 500); // Open popup after brief delay
                }
            }

            // Update legend visibility
            updateLegendVisibility();
        }
        
        /**
         * Remove an MQTT drone from the map
         */
        function removeMQTTDrone(droneId) {
            removeAircraftForDrone(droneId);
            const marker = mqttDroneMarkers[droneId];
            const path = mqttDronePaths[droneId];
            
            if (marker) {
                if (marker.labelMarker) {
                    map.removeLayer(marker.labelMarker);
                }
                map.removeLayer(marker);
                delete mqttDroneMarkers[droneId];
            }
            
            if (path) {
                map.removeLayer(path);
                delete mqttDronePaths[droneId];
            }
            
            delete mqttDroneData[droneId];
            delete mqttDroneLastUpdate[droneId];
            if (mqttDroneTimeouts[droneId]) {
                clearTimeout(mqttDroneTimeouts[droneId]);
                delete mqttDroneTimeouts[droneId];
            }
            
            // Update legend visibility
            updateLegendVisibility();
        }

        /**
         * Update or create a marker for an MQTT drone
         */
        function updateMQTTDroneMarker(droneId, droneName, lat, lng, altitude, telemetryData) {
            if (!map) return;

            let marker = mqttDroneMarkers[droneId];

            if (!marker) {
                // Create new marker - smaller red circle with pulsing ring for drone location
                const droneIcon = L.divIcon({
                    className: 'home-point-marker',
                    html: '<div class="drone-location-pulse"></div><div class="drone-location-circle"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                marker = L.marker([lat, lng], { icon: droneIcon }).addTo(map);
                mqttDroneMarkers[droneId] = marker;

                // Don't create label for MQTT drones by default (but marker is still clickable)
                marker.labelMarker = null;

            } else {
                // Update existing marker position
                marker.setLatLng([lat, lng]);
                // No label to update - labels are not shown for MQTT drones
            }

            // Calculate time since last update (minutes and seconds only, or just minutes if > 5 min)
            const lastUpdate = mqttDroneLastUpdate[droneId] || Date.now();
            const timeSinceUpdate = Date.now() - lastUpdate;
            const totalMinutes = Math.floor(timeSinceUpdate / (1000 * 60));
            const seconds = Math.floor((timeSinceUpdate % (1000 * 60)) / 1000);
            
            let timeSinceUpdateStr;
            if (totalMinutes > 5) {
                timeSinceUpdateStr = `${totalMinutes}m`;
            } else {
                timeSinceUpdateStr = `${totalMinutes}m ${seconds}s`;
            }

            // Update popup with telemetry data
            const batteryPercent = telemetryData.state?.misc?.battery_percent || 'N/A';
            const airspeed = telemetryData.state?.misc?.airspeed_mps;
            const yaw = telemetryData.state?.drone_pose?.yaw_deg;
            const contactInfo = telemetryData.contact_info;

            // Format coordinates for popup
            const latFormatted = lat.toFixed(6);
            const lngFormatted = lng.toFixed(6);

            const popupContent = `
                <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #a0a0a0;">
                    <strong style="color: #d4a574;">${droneName}</strong><br>
                    <strong>Coordinates:</strong><br>
                    <strong>Lat: ${latFormatted}</strong><br>
                    <strong>Lng: ${lngFormatted}</strong><br>
                    <strong>ID:</strong> ${droneId}<br>
                    <strong>Alt:</strong> ${altitude.toFixed(1)} m<br>
                    ${yaw !== null && yaw !== undefined ? `<strong>Yaw:</strong> ${yaw.toFixed(1)}°<br>` : ''}
                    ${batteryPercent !== 'N/A' ? `<strong>Battery:</strong> ${batteryPercent}%<br>` : ''}
                    <strong>Speed:</strong> ${airspeed !== null && airspeed !== undefined ? `${airspeed.toFixed(1)} m/s` : 'N/A'}<br>
                    ${contactInfo ? `<strong>Contact:</strong> ${contactInfo}<br>` : ''}
                    <strong>LAST UPDATE:</strong> ${timeSinceUpdateStr}<br>
                </div>
            `;

            // Bind popup to marker (marker is clickable even without label)
            marker.bindPopup(popupContent);
        }

        /**
         * Update or create a path polyline for an MQTT drone
         */
        function updateMQTTDronePath(droneId, lat, lng) {
            if (!map) return;

            let path = mqttDronePaths[droneId];

            if (!path) {
                // Create new path
                path = L.polyline([[lat, lng]], {
                    color: '#DC143C',
                    weight: 3,
                    opacity: 0.7
                }).addTo(map);

                mqttDronePaths[droneId] = path;
            } else {
                // Add new point to existing path
                const latLngs = path.getLatLngs();
                latLngs.push([lat, lng]);

                // Limit path length to last 1000 points to prevent memory issues
                if (latLngs.length > 1000) {
                    latLngs.shift();
                }

                path.setLatLngs(latLngs);
            }
        }

        /**
         * Remove a single detected aircraft marker
         */
        function removeAircraftMarkerAndLine(key) {
            const marker = mqttAircraftMarkers[key];
            if (marker) {
                map.removeLayer(marker);
                delete mqttAircraftMarkers[key];
            }
        }

        /**
         * Remove all detected aircraft markers and lines for a given drone
         */
        function removeAircraftForDrone(droneId) {
            Object.keys(mqttAircraftMarkers).forEach(key => {
                if (key.startsWith(droneId + ':')) removeAircraftMarkerAndLine(key);
            });
        }

        /**
         * Update or create marker for a detected aircraft (ADS-B)
         * Standard cyan color for all aircraft (no risk-level coloring). Label: call sign if available, otherwise ICAO id.
         */
        function updateOrCreateAircraftMarker(droneId, droneName, droneLat, droneLng, aircraft, aircraftId) {
            if (!map) return;
            const id = aircraftId != null ? aircraftId : (aircraft && (aircraft.id ?? aircraft.icao ?? aircraft.aircraft_id));
            if (!id) return;
            const key = droneId + ':' + id;
            const lat = Number(aircraft.lat ?? aircraft.latitude);
            const lng = Number(aircraft.lng ?? aircraft.longitude);
            if (isNaN(lat) || isNaN(lng)) return;
            const heading = (aircraft.heading_deg ?? aircraft.heading) != null ? Number(aircraft.heading_deg ?? aircraft.heading) : 0;
            const AIRCRAFT_CYAN = '#00CED1';
            const altM = (aircraft.altitude_msl_m ?? aircraft.altitude_msl ?? aircraft.altitudeMslM) != null ? Number(aircraft.altitude_msl_m ?? aircraft.altitude_msl ?? aircraft.altitudeMslM).toFixed(0) : '—';
            const headingStr = (aircraft.heading_deg ?? aircraft.heading) != null ? Number(aircraft.heading_deg ?? aircraft.heading).toFixed(0) + '°' : '—';
            const callSign = aircraft.call_sign ?? aircraft.callSign;
            const displayLabel = (callSign && String(callSign).trim()) ? String(callSign).trim() : id;

            // Unicode ✈ in most fonts points right (90°); rotate so nose points at heading_deg (0=North, 90=East)
            const rotationDeg = heading - 90;

            let marker = mqttAircraftMarkers[key];
            if (!marker) {
                const icon = L.divIcon({
                    className: 'aircraft-marker-wrapper',
                    html: '<div style="display:flex;align-items:center;justify-content:center;width:34px;height:34px;"><span class="aircraft-marker-plane" style="color:' + AIRCRAFT_CYAN + ';transform:rotate(' + rotationDeg + 'deg);">✈</span></div>',
                    iconSize: [34, 34],
                    iconAnchor: [17, 17]
                });
                marker = L.marker([lat, lng], { icon: icon });
                if (showDetectedAircraft) marker.addTo(map);
                mqttAircraftMarkers[key] = marker;
            } else {
                marker.setLatLng([lat, lng]);
                const el = marker._icon;
                if (el) {
                    const planeEl = el.querySelector('.aircraft-marker-plane');
                    if (planeEl) {
                        planeEl.style.color = AIRCRAFT_CYAN;
                        planeEl.style.transform = 'rotate(' + rotationDeg + 'deg)';
                    }
                }
            }

            const callSignLine = (callSign && String(callSign).trim()) ? `<strong>Call sign:</strong> ${String(callSign).trim()}<br>` : '';
            const icaoLine = `<strong>ICAO:</strong> ${id}<br>`;
            const openSkyUrl = 'https://map.opensky-network.org/?icao=' + encodeURIComponent(id);
            const popupContent = `
                <div style="font-family: 'Courier New', monospace; font-size: 12px; color: #a0a0a0;">
                    <strong>Manned aircraft ${displayLabel}</strong><br>
                    <strong>Detected by:</strong> ${droneName}<br>
                    ${callSignLine}${icaoLine}
                    <strong>Lat:</strong> ${lat.toFixed(6)} <strong>Lng:</strong> ${lng.toFixed(6)}<br>
                    <strong>Alt (MSL):</strong> ${altM} m<br>
                    <strong>Heading:</strong> ${headingStr}<br>
                    <a href="${openSkyUrl}" target="_blank" rel="noopener noreferrer" class="popup-opensky-link" style="background:#0a0a0a;border:2px solid #555;border-radius:4px;color:#fff;text-decoration:none;font-size:12px;font-weight:bold;">View OpenSky Details</a>
                </div>
            `;
            marker.bindPopup(popupContent);
        }

        /**
         * Disconnect from MQTT broker
         */
        function disconnectMQTT() {
            if (mqttClient && mqttConnected) {
                try {
                    mqttClient.disconnect();
                    console.log('Disconnected from MQTT broker');
                    mqttConnected = false;
                    hasShownConnectedToast = false;
                } catch (error) {
                    console.error('Error disconnecting from MQTT:', error);
                }
            }

            // Clear reconnection attempts on manual disconnect
            mqttReconnectAttempts = 0;
            if (mqttReconnectTimeout) {
                clearTimeout(mqttReconnectTimeout);
                mqttReconnectTimeout = null;
            }
        }

        /**
         * Clear all MQTT drone markers and paths
         */
        function clearMQTTDrones() {
            // Remove all aircraft markers first
            Object.keys(mqttAircraftMarkers).forEach(key => removeAircraftMarkerAndLine(key));
            mqttAircraftMarkers = {};

            // Remove all markers
            Object.values(mqttDroneMarkers).forEach(marker => {
                if (marker.labelMarker) {
                    map.removeLayer(marker.labelMarker);
                }
                map.removeLayer(marker);
            });

            // Remove all paths
            Object.values(mqttDronePaths).forEach(path => {
                map.removeLayer(path);
            });

            // Clear storage
            mqttDroneMarkers = {};
            mqttDronePaths = {};
            mqttDroneData = {};
            mqttDroneLastUpdate = {};
            Object.values(mqttDroneTimeouts).forEach(timeout => clearTimeout(timeout));
            mqttDroneTimeouts = {};

            // Update legend visibility
            updateLegendVisibility();
        }
        
        // Update download button pulse based on data availability (EDS-B only)
        function updateDownloadButtonPulse() {
            const downloadBtn = document.getElementById('downloadTestDataBtn');
            if (!downloadBtn) return;
            
            // EDS-B only - always remove pulse since we only use MQTT
            downloadBtn.classList.remove('pulse');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired - initializing map...');

            // Parse URL query parameters for target drone
            parseTargetDroneFromURL();

            initMap();
            console.log('initMap() called, map variable:', typeof map !== 'undefined' ? map : 'undefined');

            // Initialize header MQTT status indicator
            const headerStatusText = document.getElementById('mqttStatusText');
            const headerStatusDot = document.getElementById('mqttStatusDot');
            if (headerStatusText) {
                headerStatusText.textContent = 'DISCONNECTED';
                headerStatusText.style.color = '#d4a574';
            }
            if (headerStatusDot) {
                headerStatusDot.className = 'status-dot disconnected';
            }
            
            // Initialize legend - make it visible by default
            const legendPanel = document.getElementById('legendPanel');
            if (legendPanel) {
                legendPanel.classList.remove('visible');
                updateLegendVisibility();
            }

            // Layer checkbox: detected manned aircraft (ADS-B)
            const detectedAircraftCheckbox = document.getElementById('toggleDetectedAircraftCheckbox');
            if (detectedAircraftCheckbox) {
                detectedAircraftCheckbox.addEventListener('change', function() {
                    setDetectedAircraftVisibility(this.checked);
                });
            }

            // EDS-B tooltip: show "Eagle Dependent Surveillance Broadcast" on hover and click
            const edsbPopover = document.getElementById('edsbTooltipPopover');
            const edsbTriggers = document.querySelectorAll('.edsb-tooltip-trigger');
            if (edsbPopover && edsbTriggers.length) {
                function positionAndShow(triggerEl) {
                    edsbPopover.classList.add('visible');
                    edsbPopover.setAttribute('aria-hidden', 'false');
                    const r = triggerEl.getBoundingClientRect();
                    const w = edsbPopover.offsetWidth;
                    edsbPopover.style.left = Math.max(6, r.left + r.width / 2 - w / 2) + 'px';
                    edsbPopover.style.top = (r.bottom + 6) + 'px';
                }
                function hide() {
                    edsbPopover.classList.remove('visible');
                    edsbPopover.setAttribute('aria-hidden', 'true');
                }
                edsbTriggers.forEach(function(trigger) {
                    trigger.addEventListener('mouseenter', function() { positionAndShow(trigger); });
                    trigger.addEventListener('mouseleave', hide);
                    trigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        positionAndShow(trigger);
                        var closeOnClick = function(ev) {
                            if (ev.target.closest && ev.target.closest('.edsb-tooltip-trigger')) return;
                            document.removeEventListener('click', closeOnClick);
                            hide();
                        };
                        setTimeout(function() { document.addEventListener('click', closeOnClick); }, 0);
                        setTimeout(hide, 4000);
                    });
                });
            }
            
            // Initialize MQTT connection
            initMQTT();
            
            // Initialize download button pulse state
            updateDownloadButtonPulse();
        });
        
        // Stub functions for removed features
        function startTaglineRotation() {
            // Stub - tagline rotation removed
            return;
        }
        
        function stopTaglineRotation() {
            // Stub - tagline rotation removed
            return;
        }
        
        // 3D Flight Profile Viewer removed - EDS-B/MQTT only
        
        // Stub functions for removed 3D flight profile viewer
        function openFlightProfileViewer() {
            console.warn('3D Flight Profile Viewer is disabled - this site is EDS-B only');
            return;
        }
        
        function closeFlightProfileViewer() {
            return;
        }
        
        function initFlightProfile3D(flightData) {
            return;
        }
        
        function onFlightProfileResize() {
            return;
        }
        
        function animateFlightProfile() {
            return;
        }
        
        // All 3D flight profile viewer code removed - EDS-B/MQTT only
        
        // Close modal on escape key (stub)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('flightProfileModal');
                if (modal && modal.style.display !== 'none') {
                    closeFlightProfileViewer();
                }
            }
        });
    </script>
</body>
</html>
