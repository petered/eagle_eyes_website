---
layout: main
title: Set up Eagle Eyes Pilot on this device
permalink: /activate/
---

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{{ '/shared.js' | relative_url }}"></script>

<style>
    .activation-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 120px 20px 20px 20px;
        text-align: center;
    }
    
    .activation-form {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 40px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .activation-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 30px;
    }
    
    .auth-required {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .auth-required h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .auth-required p {
        color: #856404;
        margin-bottom: 20px;
    }
    
    .sign-in-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        cursor: pointer;
        transition: background 0.2s ease;
    }
    
    .sign-in-button:hover {
        background: #0056b3;
        color: white;
        text-decoration: none;
    }
    
    .code-input-container {
        margin-bottom: 30px;
    }
    
    .code-input {
        width: 100%;
        max-width: 300px;
        padding: 15px;
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        letter-spacing: 8px;
        text-transform: uppercase;
        font-family: 'Courier New', monospace;
        margin-bottom: 20px;
    }
    
    .code-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .code-input.error {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
    
    .activate-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 30px;
        font-size: 18px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s;
        min-width: 150px;
    }
    
    .activate-button:hover {
        background: #0056b3;
    }
    
    .activate-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .forgot-link {
        display: block;
        margin-top: 30px;
        color: #666;
        font-size: 16px;
        text-decoration: none;
    }
    
    .forgot-link:hover {
        text-decoration: underline;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 16px;
        margin-top: 15px;
        padding: 10px;
        background: #f8d7da;
        border-radius: 4px;
        display: none;
    }
    
    .loading-spinner {
        display: none;
        margin: 20px 0;
    }
    
    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .device-info {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: left;
    }
    
    .device-info h4 {
        color: #1976d2;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .device-info p {
        margin: 5px 0;
        color: #333;
    }
    
    .license-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .license-card {
        border: 1px solid #eee;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        background: white;
        cursor: pointer;
    }
    
    .license-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .license-card.selected {
        border-color: #007bff;
        background: #f0f7ff;
    }
    
    .license-header {
        background-color: #e6f2ff;
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        flex-direction: column;
    }
    
    .license-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .license-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .license-badge {
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .license-id {
        font-size: 14px;
        color: #666;
        font-family: monospace;
        margin: 0;
    }
    
    .license-body {
        padding: 15px;
    }
    
    .license-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .license-detail-item {
        font-size: 14px;
    }
    
    .license-detail-label {
        color: #666;
        font-weight: 500;
    }
    
    .license-detail-value {
        color: #333;
        font-weight: 400;
    }
    
    .license-actions {
        text-align: center;
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .btn-select-license {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .btn-select-license:hover {
        background: #0056b3;
    }
    
    .manual-license-entry {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .manual-license-entry h4 {
        color: #333;
        margin-bottom: 10px;
        font-size: 16px;
    }
    
    .manual-license-entry p {
        color: #6c757d;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }
    
    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s ease;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    #device-info-section,
    #license-selection-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
    }
    
    #license-selection-section .activation-form {
        max-width: 800px;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .activation-container {
            padding: 100px 15px 15px 15px;
        }
        
        .activation-form {
            padding: 30px 20px;
        }
        
        .activation-title {
            font-size: 24px;
        }
        
        .code-input {
            font-size: 20px;
            letter-spacing: 4px;
        }
        
        .license-grid {
            grid-template-columns: 1fr;
        }
        
        .license-detail-grid {
            grid-template-columns: 1fr;
            gap: 8px;
        }
    }
</style>

<div class="activation-container">
    <!-- Authentication Required Message -->
    <div id="auth-required" class="auth-required" style="display: none;">
        <h3>Sign In Required</h3>
        <p>Please sign in to activate Eagle Eyes Pilot on this device.</p>
        <button id="show-signin" class="sign-in-button" onclick="showSignIn()">Sign In</button>
    </div>

    <!-- Sign In Widget Container -->
    <div id="signin-widget-container" style="display: none;">
        {% include signinwidget-main.html %}
    </div>

    <!-- Main Activation Content -->
    <div id="activation-content" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Set up Eagle Eyes Pilot on this device</h1>
            
            <div class="code-input-container">
                <input type="text" 
                       id="activationCode" 
                       class="code-input" 
                       placeholder="ABC-123" 
                       maxlength="7" 
                       autocomplete="off">
                <div>
                    <button id="activateButton" class="activate-button" onclick="handleActivation()">
                        Activate Device
                    </button>
                </div>
            </div>
            
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Verifying activation code...</p>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <a href="{{ '/pilot-setup/' | relative_url }}" class="forgot-link">
                Forgot your 6-digit code? Request a new code.
            </a>
        </div>
    </div>

    <!-- Device Information Display -->
    <div id="device-info-section" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Device Information</h1>
            
            <div class="device-info">
                <h4>Detected Device</h4>
                <p><strong>Device:</strong> <span id="deviceName"></span></p>
                <p><strong>Machine ID:</strong> <span id="machineId"></span></p>
            </div>
            
            <p style="text-align: center; color: #6c757d; margin: 20px 0;">
                Please select a license to use with this device.
            </p>
        </div>
    </div>

    <!-- License Selection Section -->
    <div id="license-selection-section" style="display: none;">
        <div class="activation-form">
            <h1 class="activation-title">Select Your License</h1>
            
            <div class="loading-spinner" id="licensesLoading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading your licenses...</p>
            </div>
            
            <div id="licensesContainer" style="display: none;">
                <h3>Your Active Licenses</h3>
                <div class="license-grid" id="licenseGrid"></div>
                
                <div class="manual-license-entry">
                    <h4>Don't see your license?</h4>
                    <p>If you have a license ID that's not showing above, you can add it to your account:</p>
                    <div class="form-group">
                        <label for="manualLicenseId">License ID:</label>
                        <input type="text" id="manualLicenseId" placeholder="Enter your license ID">
                    </div>
                    <button id="addLicenseBtn" class="btn-select-license">Add License to Account</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var useLocalFirebaseEmulator = getIsEmulatorFromURL();
    var hostURL = useLocalFirebaseEmulator ? 'http://127.0.0.1:5001/eagleeyessearch/us-central1' : 'https://us-central1-eagleeyessearch.cloudfunctions.net';
    
    // Global variable to store URL activation code
    let urlActivationCode = null;
    
    function getUrlActivationCode() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Check for various parameter names (in order of preference)
        const paramNames = ['session_id', 'code', 'nonce', 'activation_code'];
        
        for (const paramName of paramNames) {
            const paramValue = urlParams.get(paramName);
            if (paramValue) {
                // Clean and validate the parameter value
                const cleanValue = paramValue.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // Validate format (should be exactly 6 alphanumeric characters)
                if (cleanValue.length === 6 && /^[A-Z0-9]{6}$/.test(cleanValue)) {
                    console.log(`Found valid activation code in URL parameter '${paramName}':`, cleanValue);
                    return cleanValue;
                } else {
                    console.warn(`Invalid activation code format in URL parameter '${paramName}':`, paramValue, 'Expected 6 alphanumeric characters');
                    
                    // Show warning about invalid URL parameter
                    if (cleanValue.length > 0) {
                        setTimeout(() => {
                            showUrlParameterWarning(paramName, paramValue);
                        }, 1000);
                    }
                }
            }
        }
        
        return null;
    }
    
    function showUrlParameterWarning(paramName, paramValue) {
        const warningHtml = `
            <div id="url-param-warning" style="background-color: #ffeaa7; border: 1px solid #fdcb6e; color: #2d3436; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <strong>‚ö†Ô∏è Invalid URL Parameter</strong><br>
                The activation code in URL parameter '${paramName}' is invalid: <code>${paramValue}</code><br>
                <small>Expected format: 6 letters and numbers (e.g., ABC123)</small>
                <button onclick="$('#url-param-warning').remove()" style="margin-left: 10px; background: #fdcb6e; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Dismiss</button>
            </div>
        `;
        $('.activation-container').prepend(warningHtml);
    }
    
    function clearUrlParameters() {
        // Clear URL parameters after successful activation
        if (window.history && window.history.replaceState) {
            const url = new URL(window.location);
            url.search = '';
            window.history.replaceState({}, document.title, url.pathname);
            console.log('URL parameters cleared after successful activation');
        }
    }
    
    $(document).ready(function() {
        // Check for URL activation code on page load
        urlActivationCode = getUrlActivationCode();
        
        // Show emulator banner if in emulator mode
        if (useLocalFirebaseEmulator) {
            const emulatorBanner = $(`
                <div style="background-color: #ff9800; color: black; padding: 10px; text-align: center; font-weight: bold; margin-bottom: 20px;">
                    üß™ Emulator Mode: Using local Firebase emulator database
                </div>
            `);
            $('.activation-container').prepend(emulatorBanner);
        }
        
        // Check authentication state
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                showActivationContent();
            } else {
                showAuthRequired();
            }
        });
        
        // Listen for sign-in completion
        document.addEventListener('signInComplete', function(event) {
            showActivationContent();
        });
        
        // Auto-format input as user types
        $('#activationCode').on('input', function() {
            let value = $(this).val().toUpperCase().replace(/[^A-Z0-9-]/g, '');
            
            // Remove existing dashes and format as ABC-123
            let cleanValue = value.replace(/-/g, '');
            if (cleanValue.length > 3) {
                value = cleanValue.substring(0, 3) + '-' + cleanValue.substring(3, 6);
            } else {
                value = cleanValue;
            }
            
            $(this).val(value);
            $(this).removeClass('error');
            $('#errorMessage').hide();
        });
        
        // Handle Enter key
        $('#activationCode').on('keypress', function(e) {
            if (e.which === 13) {
                handleActivation();
            }
        });
        
        // Manual license addition
        $(document).on('click', '#addLicenseBtn', function() {
            const licenseId = $('#manualLicenseId').val().trim();
            if (!licenseId) {
                alert('Please enter a license ID');
                return;
            }
            
            addLicenseToAccount(licenseId);
        });
    });
    
    function showAuthRequired() {
        // Update auth required message based on whether we have URL parameter
        if (urlActivationCode) {
            const displayCode = urlActivationCode.substring(0, 3) + '-' + urlActivationCode.substring(3);
            $('#auth-required h3').text('Sign In Required');
            $('#auth-required p').html(`Please sign in to activate Eagle Eyes Pilot with code <strong>${displayCode}</strong>.`);
        } else {
            $('#auth-required h3').text('Sign In Required');
            $('#auth-required p').text('Please sign in to activate Eagle Eyes Pilot on this device.');
        }
        
        $('#auth-required').show();
        $('#signin-widget-container').hide();
        $('#activation-content').hide();
    }
    
    function showSignIn() {
        $('#auth-required').hide();
        $('#signin-widget-container').show();
        $('#activation-content').hide();
    }
    
    function showActivationContent() {
        $('#auth-required').hide();
        $('#signin-widget-container').hide();
        
        // Check if we have a URL activation code
        if (urlActivationCode) {
            // Auto-activate with URL parameter
            autoActivateWithUrlCode(urlActivationCode);
        } else {
            // Show manual input form
            $('#activation-content').show();
            
            // Update title for manual activation
            $('#activation-content .activation-title').text('Set up Eagle Eyes Pilot on this device');
            
            // Focus on input field when showing activation content
            setTimeout(() => {
                $('#activationCode').focus();
            }, 100);
        }
    }
    
    function autoActivateWithUrlCode(activationCode) {
        console.log('Auto-activating with URL code:', activationCode);
        
        // Format code for display (ABC-123)
        const displayCode = activationCode.substring(0, 3) + '-' + activationCode.substring(3);
        
        // Show a different UI for auto-activation
        $('#activation-content').hide();
        showAutoActivationProgress(displayCode);
        
        // Call the activation API directly
        getActivationRequest(activationCode)
            .then(function(result) {
                console.log('Auto-activation successful:', result);
                
                // Clear URL parameters to prevent re-activation on refresh
                clearUrlParameters();
                
                // Show device information and proceed to license selection
                showDeviceInfo(result.device_identifier, result.machine_id);
                showLicenseSelection();
            })
            .catch(function(error) {
                console.error('Auto-activation failed:', error);
                
                // Show error and fall back to manual input
                showAutoActivationError(error.message, displayCode);
            });
    }
    
    function showAutoActivationProgress(displayCode) {
        // Create and show auto-activation progress UI
        const progressHtml = `
            <div id="auto-activation-progress" class="activation-form">
                <h1 class="activation-title">Activating Device</h1>
                <p style="color: #6c757d; margin-bottom: 20px;">Using activation code: <strong>${displayCode}</strong></p>
                
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Verifying activation code...</p>
                </div>
            </div>
        `;
        
        $('.activation-container').append(progressHtml);
    }
    
    function showAutoActivationError(errorMessage, displayCode) {
        $('#auto-activation-progress').html(`
            <div class="activation-form">
                <h1 class="activation-title">Activation Failed</h1>
                <p style="color: #6c757d; margin-bottom: 20px;">Could not activate with code: <strong>${displayCode}</strong></p>
                
                <div class="error-message" style="display: block; margin-bottom: 20px;">
                    ${errorMessage}
                </div>
                
                <button class="activate-button" onclick="fallbackToManualInput('${displayCode}')">
                    Enter Code Manually
                </button>
            </div>
        `);
    }
    
    function fallbackToManualInput(displayCode) {
        // Hide auto-activation progress and show manual input
        $('#auto-activation-progress').remove();
        $('#activation-content').show();
        
        // Pre-fill the input with the failed code
        $('#activationCode').val(displayCode);
        $('#activationCode').focus();
    }
    
    function handleActivation() {
        const code = $('#activationCode').val().trim();
        
        // Validate input
        if (!code) {
            showError('Please enter your 6-digit activation code');
            return;
        }
        
        if (code.length !== 7) {
            showError('Activation code must be in format ABC-123');
            return;
        }
        
        if (!/^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(code)) {
            showError('Activation code must be in format ABC-123 (letters and numbers only)');
            return;
        }
        
        // Show loading
        $('#loadingSpinner').show();
        $('#activateButton').prop('disabled', true);
        $('#errorMessage').hide();
        
        // Call API (remove dash for backend)
        const sessionId = code.replace('-', '');
        getActivationRequest(sessionId)
            .then(function(result) {
                console.log('Activation successful:', result);
                
                // Show device information and proceed to license selection
                showDeviceInfo(result.device_identifier, result.machine_id);
                showLicenseSelection();
            })
            .catch(function(error) {
                console.error('Activation failed:', error);
                showError(error.message);
                $('#loadingSpinner').hide();
                $('#activateButton').prop('disabled', false);
                $('#activationCode').addClass('error');
            });
    }
    
    async function getActivationRequest(sessionId) {
        try {
            // Get authentication token
            const user = firebase.auth().currentUser;
            if (!user) {
                throw new Error('Authentication required');
            }
            
            const idToken = await user.getIdToken(true);
            
            // Make request using GET method with session_id parameter
            const response = await fetch(`${hostURL}/get_activation_request?session_id=${encodeURIComponent(sessionId.toUpperCase())}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${idToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return {
                    success: true,
                    device_identifier: data.device_identifier,
                    machine_id: data.machine_id
                };
            } else {
                // Handle specific error cases
                switch (response.status) {
                    case 404:
                        throw new Error('Activation code not found. Please check the code and try again.');
                    case 410:
                        throw new Error('Activation code has expired. Please request a new code.');
                    case 429:
                        throw new Error('Too many requests. Please wait a minute before trying again.');
                    case 401:
                        throw new Error('Authentication required. Please sign in and try again.');
                    default:
                        throw new Error(data.error || 'Failed to retrieve activation request');
                }
            }
        } catch (error) {
            console.error('Error retrieving activation request:', error);
            throw error;
        }
    }
    
    function showDeviceInfo(deviceIdentifier, machineId) {
        // Hide activation form and show device info
        $('#activation-content').hide();
        $('#device-info-section').show();
        
        // Populate device information
        $('#deviceName').text(deviceIdentifier);
        $('#machineId').text(machineId);
        
        // Hide loading spinner
        $('#loadingSpinner').hide();
        $('#activateButton').prop('disabled', false);
        
        // Scroll to device info section
        setTimeout(() => {
            $('#device-info-section')[0].scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    function showLicenseSelection() {
        // Show license selection section
        $('#license-selection-section').show();
        
        // Load user licenses
        loadUserLicenses();
        
        // Scroll to license selection section
        setTimeout(() => {
            $('#license-selection-section')[0].scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
    
    // Global variables for license management
    let userLicenses = [];
    let selectedLicense = null;
    
    function loadUserLicenses() {
        console.log('loadUserLicenses called');
        $('#licensesLoading').show();
        $('#licensesContainer').hide();
        
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated in loadUserLicenses');
            $('#licensesLoading').hide();
            $('#licensesContainer').show();
            $('#licenseGrid').html('<p>Please sign in to view your licenses.</p>');
            return;
        }
        
        console.log('User authenticated, getting ID token for:', globalUser.email);
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=' + $('#machineId').text();
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('Raw licenses response:', response);
                    console.log('Response type:', typeof response);
                    
                    try {
                        let licenseData;
                        if (typeof response === 'string') {
                            licenseData = JSON.parse(response);
                        } else {
                            licenseData = response;
                        }
                        
                        console.log('Parsed licenses data:', licenseData);
                        
                        if (licenseData && licenseData.licenses_and_dispensed) {
                            // Transform licenses_and_dispensed object to array format
                            userLicenses = [];
                            for (const licenseId in licenseData.licenses_and_dispensed) {
                                const licenseInfo = licenseData.licenses_and_dispensed[licenseId];
                                if (licenseInfo && licenseInfo.license) {
                                    const license = licenseInfo.license;
                                    // Add license_id and calculate remaining tokens
                                    license.license_id = licenseId;
                                    const totalTokens = license.n_tokens || 0;
                                    const dispensedTokens = licenseInfo.n_tokens_dispensed || 0;
                                    license.remaining_keys = Math.max(0, totalTokens - dispensedTokens);
                                    
                                    // Only include licenses with available tokens
                                    if (license.remaining_keys > 0) {
                                        userLicenses.push(license);
                                    }
                                }
                            }
                            console.log('Set userLicenses to:', userLicenses);
                        } else {
                            console.log('No licenses_and_dispensed found in response');
                            userLicenses = [];
                        }
                        
                        $('#licensesLoading').hide();
                        $('#licensesContainer').show();
                        displayLicenses();
                        
                    } catch (parseError) {
                        console.error('Error parsing licenses response:', parseError);
                        $('#licensesLoading').hide();
                        $('#licensesContainer').show();
                        $('#licenseGrid').html('<p>Error parsing license data. Please try again.</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading licenses:', error);
                    $('#licensesLoading').hide();
                    $('#licensesContainer').show();
                    $('#licenseGrid').html('<p>Error loading licenses. Please try again.</p>');
                }
            });
        });
    }
    
    function displayLicenses() {
        console.log('displayLicenses called with:', userLicenses);
        const licenseGrid = $('#licenseGrid');
        licenseGrid.empty();
        
        if (userLicenses.length === 0) {
            console.log('No licenses to display');
            licenseGrid.html('<p>No active licenses found. Please add a license using the form below.</p>');
            return;
        }
        
        console.log('Creating license cards for', userLicenses.length, 'licenses');
        
        userLicenses.forEach(function(license) {
            const expiryDate = license.expiry_timestamp ? 
                new Date(license.expiry_timestamp * 1000).toLocaleDateString() : 
                'No expiry';
            
            const licenseCard = $(`
                <div class="license-card" data-license-id="${license.license_id}" onclick="selectLicense('${license.license_id}')">
                    <div class="license-header">
                        <div class="license-title-row">
                            <h3 class="license-title">${license.license_name || 'Eagle Eyes License'}</h3>
                        </div>
                        <p class="license-id">License ID: ${license.license_id}</p>
                    </div>
                    <div class="license-body">
                        <div class="license-detail-grid">
                            <div class="license-detail-item">
                                <div class="license-detail-label">Expires: <span class="license-detail-value">${expiryDate}</span></div>
                            </div>
                            <div class="license-detail-item">
                                <div class="license-detail-label">Remaining Keys: <span class="license-detail-value">${license.remaining_keys || 'Unlimited'}</span></div>
                            </div>
                        </div>
                        <div class="license-actions">
                            <button class="btn-select-license" onclick="event.stopPropagation(); selectLicense('${license.license_id}')">
                                Use This License for Setup
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            licenseGrid.append(licenseCard);
        });
    }
    
    function selectLicense(licenseId) {
        $('.license-card').removeClass('selected');
        $(`.license-card[data-license-id="${licenseId}"]`).addClass('selected');
        selectedLicense = licenseId;
        
        console.log('License selected:', licenseId);
        
        // Complete the activation process
        completeActivation();
    }
    
    function addLicenseToAccount(licenseId) {
        const globalUser = firebase.auth().currentUser;
        if (!globalUser) {
            console.error('No user authenticated');
            return;
        }
        
        $('#addLicenseBtn').text('Adding...').prop('disabled', true);
        
        globalUser.getIdToken(true).then(function(idToken) {
            var fetch_url = hostURL + '/check_available_licenses_and_tokens?machine_id=' + $('#machineId').text() + '&license_id=' + licenseId;
            $.ajax({
                url: fetch_url,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + idToken
                },
                success: function(response) {
                    console.log('License added successfully:', response);
                    $('#manualLicenseId').val('');
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    // Reload licenses to show the newly added one
                    loadUserLicenses();
                    
                    alert('License added successfully to your account!');
                },
                error: function(xhr, status, error) {
                    console.error('Error adding license:', error);
                    $('#addLicenseBtn').text('Add License to Account').prop('disabled', false);
                    
                    let errorMessage = 'Failed to add license. ';
                    if (xhr.status === 500 && xhr.responseText && xhr.responseText.includes("'NoneType' object has no attribute 'expiry_timestamp'")) {
                        errorMessage = `License ID "${licenseId}" was not found in our database. Please check that you entered the license ID correctly.`;
                    } else if (xhr.responseText) {
                        errorMessage += xhr.responseText;
                    } else {
                        errorMessage += 'Please check the license ID and try again.';
                    }
                    
                    alert(errorMessage);
                }
            });
        });
    }
    
    function completeActivation() {
        // Show a more professional success message with device info
        const deviceName = $('#deviceName').text();
        const machineId = $('#machineId').text();
        
        // Create a success confirmation dialog
        const confirmed = confirm(`Activate Eagle Eyes Pilot on this device?\n\nDevice: ${deviceName}\nMachine ID: ${machineId}\nLicense: ${selectedLicense}\n\nClick OK to complete activation or Cancel to select a different license.`);
        
        if (confirmed) {
            // Show loading state
            $('.license-card').css('pointer-events', 'none');
            $('#addLicenseBtn').prop('disabled', true);
            
            // Here you would typically make an API call to complete the activation
            // For now, simulate API call with timeout
            setTimeout(() => {
                alert(`‚úÖ Activation completed successfully!\n\nYour device "${deviceName}" is now activated with Eagle Eyes Pilot.\n\nYou can now use the application on your drone controller.`);
                
                // Redirect to account page
                window.location.href = "{{ '/account/' | relative_url }}";
            }, 1000);
        }
    }
    
    function showError(message) {
        $('#errorMessage').text(message).show();
    }
</script>